02 内包表記(コンプリヘンション)
===========================

* Pythonのプログラムでは、リストや文字列のようなシーケンスを扱うためにループを組むことがある

  * Pythonでループを組むためのforやwhileは文なので、インデントしたブロックを伴う

  * 単純な処理しかない場合、コードが冗長になりやすい

* Pythonの`内包表記`は、本来for文などを使って行う処理のうち、比較的シンプルな処理をスマートに記述できる文法

  * 文ではなく、式なので、改行を行わずにシンプルにコードを記述できる



## 内包表記とは

* Python3には、3種類の内包表記がある

* `リスト内包表記`と呼ばれる機能を使う

* 例)身長の分散を、リスト内包表記を使って書き換える

```python
>>> monk_fish_team = [158, 157, 163, 157, 145]

>>> total = sum(monk_fish_team)
>>> length = len(monk_fish_team)
>>> mean = total/length

# for height in monk_fish_team:
#   variance = variance+(height-mean)**2
#
# variance = variance/length

>>> variance = sum([(height-mean)**2 for height in monk_fish_team])/length
>>> variance
35.2
```

* コメントアウトされている部分が、元のコードにあったfor文で分散を求めるコード

* その下にある部分が、同じ処理をリスト内包表記で書き換えたコード

* `sum()`の丸括弧の中にある角括弧`[]`で囲まれた部分がリスト内包表記を実行している

* リスト内包表記では、リストから1つずつ取り出し、平均を引いて二乗したもののリストを作っている

  => `sum()`でその数値を合計することで、for文の中でやっていたことと同じ処理を実行している

* リスト内包表記は式なので、関数の引数として渡すことができる



## リスト内包表記の詳細

* `リスト内包表記`：リストなどシーケンスの要素を操作して新しいシーケンスを生み出すための記法

  * リストのリテラルを定義する角括弧`[]`、forやinなどのキーワードと組み合わせて利用する

```python
[ 式 for 繰り返し変数 in シーケンス]
```

* リスト内包表記では、シーケンスの要素を1つずつ繰り返し変数に代入していきながら、左にある式を計算していく

* 式を計算した結果が、リスト内包表記が返すリストの要素となる

* 例では、式に相当する部分が`(height-mean)**2`となっている

  => `height`は繰り返し変数なので、式を計算した結果、繰り返し変数から平均を引いた値がリストの要素として登録される

  ```python
  >>> [(h-mean)**2 for h in monk_fish_team]
  [4.0, 1.0, 49.0, 1.0, 121.0]
  ```

* 例)空白文字列で区切られた数値相当の文字列を数値に変換

```python
>>> str_speeds = "38 42 20 40 39"
>>> speeds = [int(s) for s in str_speeds.split()]
>>> speeds
[38, 42, 20, 40, 39]
```



## リスト内包表記で利用する「if」

* リスト内包表記のシーケンスの右には、ifを使った条件式を置くことができる

* ifを書くと、条件がTrue(真)になった場合のみ、先頭の式を評価してリストの要素として追加する

```python
[ 式 for 繰り返し変数 in シーケンス if 条件式]
```

* 例)空白で区切られた文字列を数値のリストに変換

  => 数字と空白以外の文字列が混じっているとエラーになるので、その部分をスキップする

  * `isdigit()`：文字列が数値だけで構成さているかどうかを調べる

    * 文字列中の全ての文字が数値で、かつ1文字以上あるならTrueを返す

  ```python
  >>> str_speeds = "38 42 20 40 a1 39"
  >>> speeds = [int(s) for s in str_speeds.split() if s.isdigit()]
  >>> speeds
  [38, 42, 20, 40, 39]
  ```



## ディクショナリ内包表記

* `ディクショナリ内包表記`：リスト内包表記とよく似ている機能

  * 波括弧`{}`を使う

  * forの左には、`a:b`のようにコロン`:`で挟んだ2つの要素を置く

```python
{ キー:値 for 繰り返し変数 in シーケンス (if 条件式) }
```

* 例)タイムゾーンと時差のディクショナリから、値とキーを反転した別のディクショナリを作る

```python
>>> tz = {"GMT":"+000", "BST":"+100",
...       "EET":"+200", "JST":"+900"}
>>> revtz = {off:zone for zone, off in tz.items()}
>>> revtz
{'+000': 'GMT', '+100': 'BST',
'+200': 'EET', '+900': 'JST'}
```

* `items()`：キーと値を取り出す

* 繰り返し変数の順番が逆順になっているので、キーと値が入れ替わったディクショナリが生成される



## set内包表記

* `set内包表記`：内包表記のうち、set型のオブジェクトを作る記法

  * 文法は、ディクショナリ内包表記とよく似ている

  * set型のリテラルを定義する時に使う波括弧を使い、forの左にくる要素をコロン`:`で区切らずに置く

```python
{ 式 for 繰り返し変数 in シーケンス (if 条件式)}
```

* 例)文字列を小文字に変換しながらset型に変換して、重複する要素を取り除く

```python
>>> names = ["BOB", "burton", "dave", "bob"]
>>> unames = {x.lower() for x in names}
>>> unames
{'dave', 'bob', 'burton'}
```



| 版 |  年月日   |
|---|----------|
|初版|2019/01/30|
