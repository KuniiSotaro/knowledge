03 日時データの扱い「datetime、calendar」
====================================

* `datetime`：日付や時刻をデータとして表現したいときに使うモジュール

  * Pythonには、日付や時刻に関する処理を集めた、`time`と`datetime`という2つのモジュールがある

  * `time`は古くからあるモジュールで、日時を扱うために必要な処理を集めたもの

    * `エポック秒`と呼ばれる特別な秒数を元に処理を行う

    * 文字列を元に日時に関するデータを得たり、日時を表す文字列を作ることができる

    * Pythonの処理を一定時間停止する`sleep()`関数も`time`モジュールに定義されている

  * `datetime`モジュールを使えば、`time`モジュールでは扱えない1970年より過去、2036年より未来といった、より広範囲な日付を扱うことができる

    * 日付や時刻を使った演算や比較も行い安くなっている

    * 特別な理由がない限り、`datetime`モジュールを使うようにする

* `datetime`には以下のクラスが定義されている

  * 定義されているクラスは全て変更不可能で、ディクショナリのキーとして利用できる



### `datetime.date`クラス

* 日付を扱うためのクラス

* 「西暦(year)、月(month)、日(day)」を引数として与え、

  ```python
  datetime.date(2016, 5, 1)
  ```

  のようにしてインスタンスオブジェクトを作る

* 引数は省略できない

* `today()`というメソッドが定義されていて、

  ```python
  datetime.date.today()
  ```

  のようにすると、今日を指す`date`クラスのインスタンスを手軽に作れる

* `date`クラスのインスタンスには、「year」、「month」、「day」のようにし、日付の要素を取り出すことができる



### `datetime.time`クラス

* 時間を扱うためのクラス

* 「時刻(hours)、分(minutes)、秒(seconds)、ミリ秒」を引数として与え、

  ```python
  datetime.time(10, 20, 0)
  ```

  のようにしてインスタンスを作る

* 分より後の引数は省略できる

* `time`クラスのインスタンスには「hour」、「minute」、「second」とう読み出し専用のアトリビュートがあり、`t.hour`のようにして時刻の要素を取り出すことができる



### `datetime.datetime`クラス

* 日付と時間を扱うためのクラス

* 「西暦(year)、月(month)、日(days)、時刻(hours)、分(minutes)、秒(seconds)、ミリ秒」を与え、

  ```python
  datetime.datetime(2016, 5, 1, 10, 20, 0)
  ```

  のようにしてインスタンスを作る

* 時刻より後の引数は省略できる

* `now()`というメソッドが定義されていて、

  ```python
  datetime.datetime.now()
  ```

  のようにすると、現在の日時を指す`datetime`クラスのインスタンスを手軽に作れる

* `datetime`クラスのインスタンスには、`date`クラス、`time`クラスのインスタンスが持つ呼び出し専用のアトリビュートがある

  * `d.year`や`d.hour`のようにして、日時の要素を取り出すことができる



### `datetime.timedelta`クラス

* 日付や時刻の差を扱うための特殊なクラス

* 日時の演算などに利用する

* `datetime`に定義されている日時を扱うクラスの演算結果として`timedelta`クラスのインスタンスが返ってくる

  ```python
  datetime.timedelta(100)
  ```

  のようにインスタンスを作ることもできる

* `timedelta`クラスのインスタンスには、「days」、「seconds」、「microseconds」という読み取り専用のアトリビュートがある

  * 日時の差を、日付や秒数で取り出すことができる



## 日付と文字列

* `strftime()`：フォーマット済みの日時文字列を取り出す

  * 「`D`」は、date、time、datetimeのいずれかのクラスのインスタンスを表す

  * 日時データを、引数のフォーマット文字列を使って整形した文字列を返す

  * 引数として渡すフォーマット文字に、パーセント`%`で始まる文字列を記述すると、要素が置き換えられる

  * パーセント`%`自体を文字列に埋め込みたい場合は、`%%`のように2つ重ねる

  ```python
  D.strftime(フォーマット文字列)
  ```

  * ここで紹介するフォーマット文字列は、文字列型の`format()`メソッドと組み合わせて

  ```python
  "{:%B %d, %Y}".format(datetime.now())
  ```

|   文字列   |                      説明                       |
|:---------|:------------------------------------------------|
|`%y`、`%Y`|西暦、小文字は下2桁のみ、大文字は全て                   |
|   `%m`   |2桁の月、「01」、「12」など                          |
|   `%d`   |2桁の日、「01」、「31」など                          |
|   `%H`   |24時間表記の時。「00」、「23」など                    |
|   `%l`   |12時間表記の時。「01」、「12」など                    |
|   `%M`   |2桁の分。「00」、「59」など                          |
|   `%S`   |2桁の秒。「00」、「59」など                          |
|`%a`、`%A`|ロケールを考慮した曜日名、大文字は省略あり、小文字は省略なし|
|`%b`、`%B`|ロケールを考慮した月名、大文字は省略あり、小文字は省略なし  |
|  `%p`    |ロケールを考慮した「AM」、「PM」のような午前、午後の表記   |
|  `%w`    |曜日を表す10進数。「0」を日曜、「6」を土曜とする         |
|  `%x`    |ロケールを考慮した日付の表現                           |
|  `%X`    |ロケールを考慮した時刻の表現                           |
|  `%Z`    |タイムゾーンの名前                                   |

* `strptime()`：日付文字列から日時データを作成する

  * 第2引数のフォーマット文字列により整形された日付文字列を渡して、対応する日時データを返す

  * フォーマット文字列には、`strftime()`に利用するものと同じく、パーセント`%`で始まる文字列を指定する

  * フォーマットに指定したようsがない、または余計な文字列が含まれているなど、フォーマットに合わない日付文字列を渡すとエラーとなる



## 日時の演算と比較

* `datetime`に定義されているクラスに対しては、以下の演算、比較を実行できる



### 日時の差を求める

* `date`または`datetime`クラスのうち、同じクラスのインスタンス同士で引き算を行うことによって、日時の差を求めることができる

* 演算の結果、`timedelta`クラスのインスタンスが返ってくる

* 例)日時の差を求める

  ```python
  >>> import datetime
  >>> d1 = datetime.date(2016, 6, 28)
  >>> d2 = datetime.date(2015, 6, 28)
  >>> td = d1 - d2
  >>> print(td)
  366 days, 0:00:00
  ```



### 日時の加算、減算を行う

* `date`または`datetime`クラスのインスタンスに、`timedelta`クラスのインスタンスを加算、または減算することができる

* ある日時を元にして、別の日時を算出できる

* `date`クラスと`timedelta`クラスの演算では、結果は`date`クラスのインスタンスとなる

* `datetime`クラスと`timedelta`クラスの演算であれば、結果は`datetime`クラスのインスタンスとなる

* 例)日時の加算

  ```python
  >>> import datetime
  >>> d1 = datetime.date(2016, 4, 14)
  >>> td = datetime.timedelta(days=100)
  >>> d2 = d1 + td
  >>> print(d2)
  2016-07-23
  ```



### `datetime.timedelta`の演算

* `timedelta`クラスのインスタンスでは、より柔軟な演算を行える

* `timedelta`型の加算、減算はもちろん、`timedelta`型と整数の掛け算を実行できる

* 「`//`」を使って端数を切り捨てた割り算を実行することもできる

* 例)日時の掛け算・割り算

  ```python
  >>> import datetime
  >>> td = datetime.timedelta(days=5)

  # 掛け算
  >>> print(td * 2)
  10 days, 0:00:00

  # 割り算
  >>> print(td / 3)
  1 day, 16:00:00
  ```



### 日時の比較を行う

* `date`または`datetime`クラスのうち、同じクラスのインスタンス同士で比較を行うことができる

```python
>>> import datetime
>>> d1 = datetime.date(2016, 6, 28)
>>> d2 = datetime.date(2016, 6, 28)
>>> d1 > d2
False
>>> d1 == d2
True
```



## `datetime.date`クラスのメソッドを使う

* `date`クラスには以下のメソッドが定義されている

* 以下の書式中、「`D`」は`date`オブジェクトのことを表す

* `timetuple()`：日時を表すタプルを返す

  * `time`モジュールの`localtime()`関数が返す形式の9つの要素を持ったデータを返す

  * `datetime`モジュールと`time`モジュールで相互にデータ型を変換する時などに利用する

  ```python
  D.timetuple()
  ```

* `weekday()`：曜日番号を返す

  * 設定された日付に対して、月曜日を「0」、日曜日を「6」とした曜日番号(整数)を返す

  ```python
  D.weekday()
  ```

* `isoweekday()`：曜日番号を返す

  * 設定された日付に対して、月曜日を「1」、日曜日を「7」とした曜日番号(整数)を返す

  ```python
  D.isoweekday()
  ```



## `datetime.datetime`クラスのメソッドを使う

* `datetime`には以下のメソッドが定義されている

* `datetime`クラスは`date`クラスのサブクラスとなるので、`date`クラスで利用できるメソッドを`datetime`クラスでも利用できる

* 以下の書式中、「`DT`」は`datetime`オブジェクトを表す

* `date()`：`date`オブジェクトを返す

  * 設定されたものと同じ年、月、日を持つ`date`クラスのインスタンスを返す

  ```python
  DT.date()
  ```

* `time()`：`time`オブジェクトを返す

  * 設定されたものと同じ時、分、秒を持つ`time`クラスのインスタンスを返す

  ```python
  DT.time()
  ```



## `calendar`モジュールを利用する

* `calendar`モジュール：西暦や月といった情報から、カレンダーに関する情報を取得するための関数などについて集めている

* 一ヶ月の曜日一覧をタプルとして取得したり、閏年について調べることができる

* `calendar`モジュールでは、曜日を`0`から`6`までの数値で扱う

  * 「`0`」が月曜日で、「`6`」が日曜日

  * この数値は、`MONDAY`、`TUESDAY`のような大文字の変数として`calendar`モジュールに定義されている

* `weekday()`：曜日番号を返す

  * 西暦、月、日を引数として渡すと、該当する曜日番号を調べて返す

  * 曜日は「`0`」が月曜となる整数

  ```python
  calendar.weekday(西暦, 月, 日)
  ```

* `monthrange()`：月の情報をタプルで返す

  * 西暦と月を引数として渡すと、2つの整数を持つタプルを返す

  * タプルの最初の要素は`月の日数`

  * 2つ目の要素は、月が始まる曜日を数値で表したもの(`0`が月曜)

  ```python
  calendar.monthrange(西暦, 月)
  ```

* `month()`：一ヶ月分のカレンダーを返す

  * 西暦と月を引数として渡すと、整形された文字列としてカレンダーを作り文字列として返す

  * オプションの引数`w`では1日を表示するための文字幅を、引数`l`では1週間を表示するための行数を指定する

  * 例)カレンダーを作る

  ```python
  >>> import calendar
  >>> print(calendar.month(2199, 12))
  December 2199
  Mo Tu We Th Fr Sa Su
                    1
  2  3  4  5  6  7  8
  9 10 11 12 13 14 15
  16 17 18 19 20 21 22
  23 24 25 26 27 28 29
  30 31
  ```

* `monthcalendar()`：カレンダーをリストで返す

  * 西暦と月を引数として渡し、カレンダーをリストのリストで返す

  * 7個の数値(日付)を持つ1週分のリストを、月に含まれる週の数だけ含むリストを作る

  * 月の先頭や末尾で、該当する日付がない部分は「`0`」となる

  * 例)日付のリストを作る

```python
>>> import calendar
>>> print(calendar.monthcalendar(2199, 12))
[[0, 0, 0, 0, 0, 0, 1],
 [2, 3, 4, 5, 6, 7, 8],
 [9, 10, 11, 12, 13, 14, 15],
 [16, 17, 18, 19, 20, 21, 22],
 [23, 24, 25, 26, 27, 28, 29],
 [30, 31, 0, 0, 0, 0, 0]]
```

* `setfirstweekday()`：カレンダーの最初の曜日を設定する

  * カレンdなーの一番左に表示される曜日を`0`から`6`の整数で指定する

  * 月曜日が`0`、日曜日が`6`となっている

  * ここで設定した結果は、`calendar`モジュールの結果に影響を与える

  * この設定は、モジュールを読み込むたびにリセットされる

* `firstweekday()`：設定されている初日の曜日番号を返す

  * `calendar`モジュールに設定されている、カレンダーの最初の曜日を曜日番号で返す

* `isleap()`：閏年かどうかを返す

  * 西暦を引数として与え、閏年かどうかを調べる

  * 与えられた西暦が閏年だったらTrue(真)を返す



| 版 |  年月日   |
|---|----------|
|初版|2019/02/06|
