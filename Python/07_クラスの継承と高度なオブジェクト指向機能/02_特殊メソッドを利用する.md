02 特殊メソッドを利用する
=====================

* Pythonのクラスでは、`__init__()`という初期化メソッドを定義する

* Pythonには、他にもアンダースコアが2つ付いたメソッドを多く持っている

  => `特殊メソッド`と呼ばれる

* `特殊メソッド`：

  * 演算子を使った演算

  * 角括弧`[]`を使った要素の参照

  などを実際に行なっている

  * 例)数値オブジェクトを代入した「a」という変数を使って、`a + 1`という演算をする

    * `__add__()`という特殊メソッドが内部的に処理している

    * 第1引数には`a`というインスタンス自体

    * 第2引数には加算を行う数値

    が渡っている

    * 結果は、メソッドの戻り値として返ってくる

* このように、オブジェクトの振る舞いを変更したり、クラスの性質にあった特別な挙動をもたせたい時に特殊メソッドを使う

* オブジェクトの型によって機能が異なるように、型によって定義されている特殊メソッドが異なる



## 特殊メソッドを定義する

* 新しく作ったクラスに特殊メソッドを定義すると、インスタンスに対して演算子などを作った操作を行えるようになる

* 組み込み型を継承したクラスで特殊メソッドをオーバーライドすると、演算子などを使った場合の処理の内容を変更することができる

  => これは、`演算子のオーバーライド`と呼ばれ、オブジェクト指向の重要な要素となる



### 算術演算子を定義する特殊メソッド

* 主に数値型をエミュレートするために利用数r特殊メソッドは、以下のような種類がある

* また、リストやset型のように、演算子を行なって要素を追加するような使い方もある

* 第1引数にインスタンスが、第2引数に演算をするオブジェクトが代入されて呼び出される

* `__add__()`：`+`演算子使用時に呼ばれる

  * 「`+`」で足し算を行う時に呼び出されるメソッド

  * `__iadd__()`というメソッドを定義すると、複合演算子「`+=`」を定義できる

  ```python
  __add__(self, オブジェクト)
  ```

* `__sub__()`：`-`演算子使用時に呼ばれる

  * 「`-`」で引き算を行うときに呼び出されるメソッド

  * `__isub__()`というメソッドを定義すると、複合演算子「`-=`」を定義できる

  ```python
  __sub__(self, オブジェクト)
  ```

* `__mul__()`：`*`演算子使用時に呼ばれる

  * 「`*`」で掛け算を行う時に呼び出されるメソッド

  * `__imul__()`というメソッドを定義すると、複合演算子「`*=`」を定義できる

  ```python
  __mul__(self, オブジェクト)
  ```

* `__truediv__()`：`/`演算子使用時に呼ばれる

  * 「`/`」で割り算を行う時に呼び出されるメソッド

  * `__itruediv__()`というメソッドを定義すると、複合演算子「`/=`」を定義できる

  ```python
  __truediv__(self, オブジェクト)
  ```

* `__floordiv__()`：`//`演算子使用時に呼ばれる

  * 「`//`」で割り算を行うときに呼び出されるメソッド

    => 小数点以下が切り捨てられる

  * `__ifloordiv__()`というメソッドを定義すると、複合演算子「`//=`」を定義できる

  ```python
  __floordiv__(self, オブジェクト)
  ```

* `__and__()`：'&'演算子使用時に呼ばれる

  * ビット演算子`&`を使うときに呼び出される

  ```python
  __and__(self, オブジェクト)
  ```

* `__or__()`：`|`演算子使用時に呼ばれる

  * ビット演算子`|`を使う時に呼び出される

  ```python
  __or__(self, オブジェクト)
  ```



### 比較演算子を定義する特殊メソッド

* 比較演算子を使ってオブジェクト同士の比較を行う際に利用する特殊メソッド

* ここにある特殊メソッドを定義すると、オブジェクト同士の比較が行えるようになる

* `__eq__()`：`==`演算子使用時に呼ばれる

  * `self`とオブジェクトが等しい場合にはTrue(真)を返す

  * 等しくない場合には、False(偽)を返す

  ```python
  __eq__(self, オブジェクト)
  ```

* `__ne__()`：`!=`演算子使用時に呼ばれる

  * `self`とオブジェクトが等しくない場合にTrue(真)を返す

  * 等しい場合には、False(偽)を返す

  ```python
  __ne__(self, オブジェクト)
  ```

* `__it__()`：`<`演算子使用時に呼ばれる

  * 「`self < オブジェクト`」が成り立つ場合にはTrue(真)を、そうでない場合はFalse(偽)を返す

  * `__le__()`というメソッドは、「`self <= オブジェクト`」を判別するために利用する

  ```python
  __it__(self, オブジェクト)
  ```

* `__gt__()`：`>`演算子使用時に呼ばれる

  * 「`self > オブジェクト`」が成り立つ場合にはTrue(真)を、そうでない場合にはFalse(偽)を返す

  * `__ge__()`というメソッドは、「`self >= オブジェクト`」を判別するために利用される

  ```python
  __gt__(self, オブジェクト)
  ```



### 型の変換を定義する特殊メソッド

* 文字列型から数値型への変換のように、あるオブジェクトを別の型に変換する時に利用する特殊メソッドがある

* 型の変換に関わるのはインスタンス自身のみなので、第1引数をとる

* `__int__()`：`int()`関数使用時に呼ばれる

  * 組み込み関数`int()`を使い、整数型に変換を行う際に呼び出される特殊メソッド

  ```python
  __int__(self)
  ```

* `__float__()`：`float()`関数使用時に呼ばれる

  * 組み込み関数`float()`を使い、浮動小数点型への変換を行う際に呼び出される特殊メソッド

  ```python
  __float__(self)
  ```

* `__str__()`：`str()`関数使用時に呼ばれる

  * 組み込み関数`str()`を使ってオブジェクトを文字列型に変換する時に呼び出される関数

  * `print()`関数でオブジェクトを表示する時にも暗黙に呼び出される

  ```python
  __str__(self)
  ```

* `__repr__()`：オブジェクトの文字列表記を返す

  * インスタンスを、「できる限り元の状態に復元できる文字列」に変換するメソッド

  * 例えば、数値の`3`の`__repr__()`は「`3`」という文字列を返すが、

    文字列の`3`は引用符で囲まれた「`'3'`」を返すというように、元の状態がわかる文字列を返す

  * `print()`を使わずに文字列を表示した時に引用符で囲まれた出力が表示されるのは、このメソッドが暗黙に呼ばれているため

  ```python
  __repr__(self)
  ```

* `__bytes__()`：`bytes()`関数使用時に呼ばれる

  * `bytes()`関数を使ってオブジェクトをバイト型へ変更する時に呼ばれる特殊メソッド

  ```python
  __bytes__(self)
  ```

* `__format__()`：`format`メソッド使用時に呼ばれる

  * `format()`メソッドで文字列フォーマットを実行する時に呼ばれる特殊メソッド

  * オブジェクトの性質に合わせて、独自のフォーマット方法やフォーマット文字列を定義できるようになっている

  ```python
  __format__(self, form_spec)
  ```



### コンテナ型で利用する特殊メソッド

* コンテナ型とは、リストやタプル、ディクショナリのように、複数の要素を持つ型の総称

* オブジェクトの要素にアクセスするためには角括弧`[]`を利用するが、そのような表記をした時に利用される特殊メソッドがある

* for文やイテレータに関連するメソッドについてものべる

* `__len__()`：`len()`関数使用時に呼ばれる

  * 組み込み関数`len()`を呼び出した時に実行される特殊メソッド

  * 要素の数を数値で返す

  ```python
  __len__(self)
  ```

* `__getitem__()`：インデクシング時に呼ばれる

  * 角括弧`[]`を伴った表記を使い、要素を参照する際に呼び出される特殊メソッド

  * リストのようにインデックスを使って要素にアクセスするオブジェクトでは、第2引数に整数を受け取る

  * ディクショナリのようにキーに対応した値を保存するオブジェクトの場合は、変更不可能なオブジェクトを受け取る

  * この特殊メソッドで数値を受け取れるオブジェクトは、for文に添えてループに利用できる

  ```python
  __getitem__(self, キー)
  ```

* `__setitem__()`：シーケンスの要素への代入時に呼ばれる

  * 引数のキーを対象に要素を代入する

  * `l[1] = 1`や`d["key"] = 1`のように、代入を行う時に呼び出される特殊なメソッド

  ```python
  __setitem__(self, キー, 要素)
  ```

* `__delitem__()`：シーケンスの要素を削除する時に呼ばれる

  * 指定されたキーに当たる要素を削除する

  * オブジェクトの要素に対してdel文が使われた時に呼び出される特殊メソッド

  ```python
  __delitem__(self, キー)
  ```

* `__iter__()`：`iter()`関数使用時に呼ばれる

  * 組み込み関数`iter()`が呼ばれる時などに利用される特殊メソッド

  * コンテナオブジェクト内の要素に対して、イテレート(反復)処理が行えるようなイテレータオブジェクトを返す必要がある

  * イテレータオブジェクトでは、`__next__()`というメソッドを定義し、呼び出されるたびに次の要素を返すようにする

  ```python
  __iter__(self)
  ```

* `__contains__()`：`in`演算子が使用された時に呼ばれる

  * シーケンスなどの要素を検査する比較演算子「`in`」が使われた時に呼ばれる特殊メソッド

  * オブジェクトの要素として`item`が存在するかどうかを調べ、もし存在するならばTrue(真)、存在しない場合にはFalse(偽)を返す

  * この特殊メソッドが定義されていない場合は、インデックスやイテレータを使って要素の検索が行われる

  ```python
  __contains__(self, 要素)
  ```



### アトリビュートのアクセスに利用される特殊メソッド

* Pythonでは、オブジェクトのアトリビュート操作をカスタマイズすることができる

* 特殊メソッドを使うと、アトリビュートへのアクセスを動的に変更する、または制限するといった`ハック的な`機能を実装できる

* `_getattr__()`：未定義のアトリビュートが参照される時に呼ばれる

  * オブジェクトに存在しないアトリビュートが参照される時に呼び出される特殊メソッド

  * 引数には、参照に利用されたアトリビュート名が文字列として渡される

  * この特殊メソッドを定義すると、特定のアトリビュート名に対してオブジェクトや呼び出し可能オブジェクトを返すようにできる

    => 存在しないオブジェクトが存在するように振る舞える

  * 属性が存在しないことにしたい場合は、「AttributeError」例外を発生させる(`raise`)

  ```python
  __getattr__(self, アトリビュート名)
  ```

* `__getattribute__()`：全てのアトリビュートが参照される時に呼ばれる

  * `__getattr__()`と同じで、アトリビュートの参照が行われた時に呼び出される特殊メソッド

  * アトリビュートの参照が行われた時に無条件で呼び出される

  ```python
  __getattribute__(self, アトリビュート名)
  ```

* `__setattr__()`：アトリビュートへの代入時に呼ばれる

  * オブジェクトのアトリビュートに代入を行おうとした時に必ず呼び出される

  * アトリビュートへの代入の際に必ず呼び出されるので、メソッドの内部で`self.spam = value`のようにすると無限ループになる

  * このメソッド内でアトリビュートへの代入を行わないと、アトリビュートが追加されない

    => アトリビュートの代入に関する全ての面倒を自分で見る必要がある

  ```python
  __setattr__(self, アトリビュート名, 要素)
  ```



### その他の特殊メソッド

* `__call__()`：オブジェクトを関数のように呼び出す

  * オブジェクトの名前に続いて丸括弧`()`が添えられ、関数として呼び出された時に呼ばれる特殊メソッド

  ```python
  __call__(self[, args...])
  ```

* `__del__()`：オブジェクトが破棄される時に呼ばれる

  * オブジェクトがメモリ上から消去される時に呼ばれる特殊メソッド

  * このようなオブジェクトを`デストラクタ`と呼ぶ

  * del文でオブジェクトが削除された時のほか、ガベージコレクタでオブジェクトが削除された時も呼ばれる

  ```python
  __del__(self)
  ```

* `__hash__(self)`：`hash()`関数使用時に呼ばれる

  * ディクショナリ型やset型の要素となるオブジェクトを定義したい時などに定義する特殊メソッド

  * 組み込み関数`hash()`から呼ばれ、数値型を返す

  * `hash()`関数では、オブジェクトのハッシュ値を取得したい時に使用する

  * 複数のオブジェクトを「`==`」演算子で評価した場合に同一であるとき、同じ数値を返すように実装する必要がある

  * 大抵の場合は、インスタンスが固有に持つオブジェクトを`hash()`関数に渡した結果を返すように実装すれば良い

  ```python
  __hash__(self)
  ```



| 版 |  年月日   |
|---|----------|
|初版|2019/01/30|
