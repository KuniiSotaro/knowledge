11 Pythonのファイル処理
=====================

* Pythonでは、数値や文字列などのデータはメモリ上に置かれる

  * メモリ上のデータに対しては、とても高速に参照や書き換えを実行することができる

  * プログラムを終了すると消えてしまう

* プログラムで処理をした結果を保存しておきたい場合には、`ファイル`を使うと便利

  * ハードディスクのように、一旦記録したら消えない記憶装置に書き出される

  * ファイルに書き出したデータであれば、Pythonを終了しても、ファイルを消去しない限り消えることがない

  * ファイルを読み込むことで、書き出した内容を再現することができる

|   |                           メモリ                          |                 ファイル                 |
|---|:---------------------------------------------------------|:----------------------------------------|
|利点|処理が速い、扱いやすい                                       |プログラムを終了したり、電源をオフにしても消えない|
|欠点|Pythonのようなプログラムを終了したり、電源をオフにすると消えてしまう|処理が遅い                                 |

* ファイルを使うことで、外部からPythonにデータを取り込むことができる

  * 例)サイズの大きなテキストファイルを読み込んで処理を行なったり、表計算ソフトで書き出したデータをPythonで読み込み、プログラムで加工を行う

* `ファイル型`：ファイルを操作するための型

  * 組み込み型としてファイルを扱うための型が用意されている

  * 事前に特別な宣言などをせずに、ファイルを開き、ファイルの内容を読み書きすることができる

* `open()`：ファイルを操作する

  * ファイルを操作するための`ファイルオブジェクト`が返ってくる

  * 関数の戻り値として返ってくるファイルオブジェクトを変数に代入するなどして、ファイルを読み書きする時に使う

  * 何種類かメソッドを持っており、このメソッドを呼び出すことでファイルに対する操作を行うことができる

  * 文字列型などのメソッドを呼び出すのと同様に、ファイルオブジェクトに続けてドット`.`を記入し、さらにメソッド呼び出しを行う

* ファイルの読み書きをする時は、文字列やリストを活用する

  * ファイルの内容を組み込みのデータ型に変換したり、書き出すデータを事前に文字列型に変換したりといった処理をする



## ファイルとファイルオブジェクト

* `open()`：ファイルを開く

  * ファイルを開くために必要な情報を引数として与えて呼び出す

  * 最初の引数：開きたいファイルへのパスを与える

    * パスには、完全なパス(フルパス)、相対パスを与えることができる

  * 最初の引数にファイル名だけを与えた場合は、カレントディレクトリにあるファイルを開く

    => Pythonを起動した時のディレクトリ

```python
>>> f = open("foo.txt", "r", encoding="utf-8")
>>> s = f.read()
>>> print(s)
It seems Today.
That all you seen.
The violence TV and Sex on TV.
>>> f.close()
```

* `open()`関数には、以下のような引数を与えることができる

```python
open(開くファイル名[, モード[, エンコード[, エラー処理]]])
```

* 第2引数には、ファイルをどのような状態で開くかを指定するための`モード`を渡す

|オプション|                                                                       解説                                                                       |
|---------|:------------------------------------------------------------------------------------------------------------------------------------------------|
|   `f`   |ファイルを読み込み専用に開く。書き出しはできない。存在しないファイルをこのモードで開こうとするとエラーになる。                                                     |
|   `w`   |ファイルを書き出し専用に開く。ファイルが存在しない場合は作成する。すでに存在しているファイルを開くと、ファイルの内容を空にする                                        |
|   `a`   |ファイルの最後に追記するために使う。書き込み専用でファイルを開くが、すでに存在しているファイルを指定した場合は、元の内容を保ったまま、書き出した内容をファイルの最後に追加する|
|   `+`   |`r`、`w`、`a`と組み合わせて「r+」のように使うオプション。読み込みと書き出しを両方できるようにする                                                              |
|   `b`   |ファイルをバイナリモードで開くオプション。「rb」のように他のオプションと組み合わせて使う。バイト型を使って読み書きを行う                                             |

* 3番目の引数には、ファイルのエンコードを渡す

  => 省略した場合は、UTF-8となる



### ファイルとシーク位置

* ファイルを扱う時は、`シーク位置`を対象に読み書きが行われる

  * 文字列のインデックスに似た働きをする

* ファイルオブジェクトは、ファイル上のインデックスに相当するシーク位置を覚えていて、ファイルを読み書きする時に利用する

* シークの位置がファイルの先頭にあれば、ファイルの先頭から読み込みを行う

* 書き出しの場合は、シーク位置が先頭にある

  * ファイル上に何かが書かれていれば、`上書き`になる

* シーク位置がファイルの末尾にある状態で書き出しを行うと、ファイルへの`追加`となる

  * 読み込みの場合は、シーク位置が末尾にある場合は、何も読み込まれない(空の文字列)

  * 一旦最後まで読み込みを行なったファイルオブジェクトを使って、再度読み込みを行なっても、空の文字列が返ってくるだけ



### ファイルを閉じる

* `close()`：ファイルオブジェクトに対して、ファイルを閉じることができる

  * 閉じたファイルに対しては、読み書きができなくなり、読み書きをするとエラーが発生する

```python
F.close()
```

* メソッドを呼び出して明示的にファイルを閉じない場合は、プログラムを終了するか、またはガベージコレクション(不要なオブジェクトを自動的に削除する機能)によって

  ファイルオブジェクトが削除される時に自動的にファイルを閉じる



## ファイルから読み込む

* ファイルを読むためには、`open()`関数が返したファイルオブジェクトを使う

  * ファイルオブジェクトを作る時に、読み込みができるモードを指定する必要がある

  * `w(書き出し)`モードで開いたファイルに対して読み込みを行おうとすると、エラーになる

* ファイルに対する操作は、ファイルオブジェクトに対してメソッドを呼び出して行う

  * ファイルオブジェクトに続いてドット`.`を記述し、続けてメソッド名を指定して呼び出す

#### ファイルを読み込むためのメソッド

> 処理の内容によって、引数と戻り値が異なる
>
> 各メソッドの記述例の「F」はファイルオブジェクト、[]で囲まれた引数はオプション(省略可)

* `read()`：ファイルから読み込みを行い、文字列を返す

  * `open()`で指定したエンコードで変換を行うが、変換時にエラーが起こるとエラーを返す

```python
F.read([整数のサイズ])
```

* `readline()`：ファイルから1行を読み込み、文字列として返す

  * オプションの引数を指定すると、読み込む行のバイトサイズを指定できる

```python
F.readline([整数のサイズ])
```

* `readlines([整数のサイズ])`：ファイルから複数行を読み込む

  * 戻り値は文字列を要素として含んだシーケンス

  * オプションの引数を指定しないと、ファイルの最後までを読み込み、行に分割してリストを返す

  * オプションの引数を指定すると、読み込むバイトサイズの上限を指定できる

```python
F.readlines([整数のサイズ])
```



### ファイルから1行ずつ読み込んで処理をする

* 文字を記述したテキストファイルをプログラムで扱う場合は、1行ごとに読み込んで処理をすることが多い

* for文とファイルオブジェクトを組み合わせて使う

```python
>>> f = open("foo.txt", "r", encoding="utf-8")
>>> for line in f:
...   print(line, end="")
...
It seems Today.
That all you seen.
The violence TV and Sex on TV.
```

* `end`：`print()`関数が最後に付け加える改行文字を置き換えるための引数



## ファイルに書き込む

* ファイルに書き込む場合にも、ファイルオブジェクトを使う

* ファイルを開く`open()`関数を呼び出す時には、書き込みに適切なモードを指定しておく必要がある

#### ファイルに書き込むメソッド

* `write()`：文字列を指定して、ファイルに対して書き出しを行う

  * `open()`で指定したエンコードへ文字列を変換しながら書き出す

  * このメソッドに戻り値はない

```python
F.write(文字列)
```

```python
>>> f = open("newfile.txt", "w", encoding="utf-8")
>>> f.write(s)
66
>>> f.close()
```

* `writelines`：文字列を要素に含むシーケンス(リストなど)を引数に与え、ファイルの読み込みを行う

  * 書き込みを行う時、改行文字を追加して書き出さない

```python
F.writelines(シーケンス)
```



## バイナリファイルを扱う

* 画像や音声のような`バイナリファイル`を扱いたい時には、`open()`関数に「`b`」オプションを与えてファイルを開く

  * 例えば「`rb`」オプションを与えて開いたファイルは、バイナリファイルを読むように準備されたファイルオブジェクトを返す

  * バイナリファイルには、エンコードという考え方がないので、エンコードは指定する必要がない

* 「`rb`」のように`b`オプションを指定して開かれたオブジェクトから`read()`メソッドを使ってデータを読み込むと、文字列型でなくバイト型のオブジェクが返ってくる

  * `wb`や`ab`の場合も同様

```python
# PNGファイルかを確かめる

>>> imgfile = open("someimage.png", "rb")
>>> imgsrc = imgfile.read()
>>> if imgsrc[1:4] == b'PNG':
...   print('image/png')
...
image/png
```

* 画像データの0から1番目から3番目までのデータに「PNG」と記録されているかどうかを調べて、画像の種類を判別している

  * `read()`メソッドで返ってくるバイト型もシーケンス型の仲間なので、スライスを使ってデータを取り出すことができる

* `b'PNG'`では、バイト型のリテラルを使って比較を行なっている

  * Pythonでは違う型同士の比較は、必ずFalse(偽)となる

  * 比較の対象となるリテラルもバイト型に合わせる必要がある



## ファイル名の扱い

* Pythonは、マルチバイト文字列を使ったファイル名に対応している

  * ファイル名に文字列型を渡せば、ファイル名に日本語が含まれていても、正しく扱うことができる

* Pythonをインストールすると、インストールを行なったOSに合わせて、マルチバイトのファイル名を扱う際に利用するエンコードの情報を自動的に設定することになっている

  * ファイル名を扱う処理にユニコード文字列を渡せば、インストール時に設定される情報を使って、適切なエンコードに変換してくれる

* `getfilesystemencoding()`：マルチバイトのファイル名にどのようなエンコードを利用するかを調べる

```python
>>> import sys
>>> sys.getfilesystemencoding()
'utf-8'
```



| 版 |  年月日   |
|---|----------|
|初版|2019/01/26|
