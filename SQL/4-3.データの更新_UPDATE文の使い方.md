4-3 データの更新
==============

## 学習のポイント

* テーブルのデータを変更(更新)するには`UPDATE`文を使う

* 一部の行を更新する時は、`WHERE`句で対象行の条件を書く

  => `WHERE`句で更新対象行を制限した`UPDATE`文を、`探索型UPDATE`と呼ぶ

* `UPDATE`文で列を`NULL`クリアすることができる

* 複数の列を同時に更新するには、`UPDATE`文の`SET`句に更新対象の複数の列を、カンマ区切りで並べる



## UPDATE文の基本構文

* `UPDATE`文：DML文の一種で、テーブルのデータを変更することができる

* 構文は以下の通り

```sql
UPDATE <テーブル名>
   SET <列名> = <式>;
```

* 更新対象の列と、更新後の値は、`SET`句に記述する

* 例)Shohinテーブルのtorokubi列を全行「2009年10月10日」で統一する

```sql
UPDATE Shohin
   SET torokubi = '2009-10-10';
```

```sql
/* 変更後の確認 */
shop=# SELECT * FROM Shohin ORDER BY shohin_id;
 shohin_id |  shohin_mei  | shohin_bunrui | hanbai_tanka | shiire_tanka |  torokubi  
-----------+--------------+---------------+--------------+--------------+------------
 0001      | Tシャツ      | 衣服          |         1000 |          500 | 2009-10-10
 0002      | 穴あけパンチ | 事務用品      |          500 |          320 | 2009-10-10
 0004      | 包丁         | キッチン用品  |         3000 |         2800 | 2009-10-10
 0006      | フォーク     | キッチン用品  |          500 |              | 2009-10-10
 0007      | おろしがね   | キッチン用品  |          880 |          790 | 2009-10-10
 0008      | ボールペン   | 事務用品      |          100 |              | 2009-10-10
```

* `NULL`の部分にも、「2009-10-10」という値が入る



## 条件を指定したUPDATE文(探索型UPDATE)

* 更新対象の行は、`SELECT`文と同様に制限することができる

* `探索型UPDATE`：`WHERE`句を用いて更新対象行を制限した`UPDATE`文のこと

* 構文は以下の通り

```sql
UPDATE <テーブル名>
   SET <列名> = <式>
 WHERE <条件>;
```

* 例)商品分類が「キッチン」の行に限って、販売単価を10倍にする

```sql
UPDATE Shohin
   SET hanbai_tanka = hanbai_tanka * 10
 WHERE shohin_bunrui = 'キッチン用品';
```

```sql
/* 変更後の確認 */
shop=# SELECT * FROM Shohin ORDER BY shohin_id;
 shohin_id |  shohin_mei  | shohin_bunrui | hanbai_tanka | shiire_tanka |  torokubi  
-----------+--------------+---------------+--------------+--------------+------------
 0001      | Tシャツ      | 衣服          |         1000 |          500 | 2009-10-10
 0002      | 穴あけパンチ | 事務用品      |          500 |          320 | 2009-10-10
 0004      | 包丁         | キッチン用品  |        30000 |         2800 | 2009-10-10
 0006      | フォーク     | キッチン用品  |         5000 |              | 2009-10-10
 0007      | おろしがね   | キッチン用品  |         8800 |          790 | 2009-10-10
 0008      | ボールペン   | 事務用品      |          100 |              | 2009-10-10
```

* `WHERE`句の「`shohin_bunrui = 'キッチン用品'`」という条件で、更新対象の行は3行に制限される

* `SET`句の「`hanbai_tanka * 10`」という式によって、「元の単価の10倍」を表現している

  => `SET`句の代入式の右辺には、単純な値だけでなく、列を含む式を記述することができる



## NULLで更新するには

* `UPDATE`を使うことで、列を`NULL`で更新することができる

  => このような更新を、「`NULL`クリア」と呼ぶ

* 例)商品IDが「0008」のボールペンの登録日を`NULL`に変更する

```sql
UPDATE Shohin
   SET torokubi = NULL
 WHERE shohin_id = '0008';
```

```sql
/* 変更後の確認 */
shop=# SELECT * FROM Shohin ORDER BY shohin_id;
 shohin_id |  shohin_mei  | shohin_bunrui | hanbai_tanka | shiire_tanka |  torokubi  
-----------+--------------+---------------+--------------+--------------+------------
 0001      | Tシャツ      | 衣服          |         1000 |          500 | 2009-10-10
 0002      | 穴あけパンチ | 事務用品      |          500 |          320 | 2009-10-10
 0004      | 包丁         | キッチン用品  |        30000 |         2800 | 2009-10-10
 0006      | フォーク     | キッチン用品  |         5000 |              | 2009-10-10
 0007      | おろしがね   | キッチン用品  |         8800 |          790 | 2009-10-10
 0008      | ボールペン   | 事務用品      |          100 |              |                   /* ボールペンの登録日がNULLになる */
```

* `INSERT`文と同様に、`UPDATE`文においても`NULL`を一つの値として使うことが可能

* ただし、`NULL`クリアが可能なのは、`NOT NULL`制約や主キー制約のない列に限られる

  => この制約がついている列を`NULL`に更新しようとした場合には、エラーとなる



## 複数列の更新

* `UPDATE`文の`SET`句には、複数列を更新対象として記述することが可能

* 例)キッチン用品の販売単価を10倍&仕入れ単価を1/2にする

```sql
/* 正しく更新できるが冗長なUPDATE文 */
UPDATE Shohin
   SET hanbai_tanka = hanbai_tanka * 10
 WHERE shohin_bunrui = 'キッチン用品';
```

* 上のSQL文は冗長なので、以下の通りに変更することが良い

```sql
/* 列をカンマ区切りで並べる */
UPDATE Shohin
   SET hanbai_tanka = hanbai_tanka * 10,
       shiire_tanka = shiire_tanka / 2
 WHERE shohin_bunrui = 'キッチン用品';
```

```sql
/* 列をカッコ()で囲むことによるリスト表現 */
UPDATE Shohin
   SET (hanbai_tanka, shiire_tanka) = (hanbai_tanka * 10, shiire_tanka / 2)
 WHERE shohin_bunrui = 'キッチン用品';
```

* これらのSQL文を実行すると、以下のように表される

```sql
/* 変更後の確認 */
shop=# SELECT * FROM Shohin ORDER BY shohin_id;
 shohin_id |  shohin_mei  | shohin_bunrui | hanbai_tanka | shiire_tanka |  torokubi  
-----------+--------------+---------------+--------------+--------------+------------
 0001      | Tシャツ      | 衣服          |         1000 |          500 | 2009-10-10
 0002      | 穴あけパンチ | 事務用品      |          500 |          320 | 2009-10-10         /* キッチン用品の販売単価を10倍&仕入単価を1/2 */
 0004      | 包丁         | キッチン用品  |       300000 |         1400 | 2009-10-10        /* キッチン用品の販売単価を10倍&仕入単価を1/2 */
 0006      | フォーク     | キッチン用品  |        50000 |              | 2009-10-10         /* キッチン用品の販売単価を10倍&仕入単価を1/2 */
 0007      | おろしがね   | キッチン用品  |        88000 |          395 | 2009-10-10
 0008      | ボールペン   | 事務用品      |          100 |              |
```

* `SET`句の列は、3列以上並べることができる

* 列をカッコで囲む場合には、DBMSによって使用できないことに注意する

  => 列をカンマ区切りで並べることが良いとされる



| 版 |   年月日  |
|----|----------|
|初版|2018/12/21|
