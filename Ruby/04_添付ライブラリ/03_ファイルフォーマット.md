03 ファイルフォーマット
====================

## 目次

* [YAML](#1YAML)

* [JSON](#2JSON)

* [CSV](#3CSV)



## 1.YAML

### YAMLとは

* xmlよりもさらに簡単な記法でデータの階層構造を表現できるフォーマット

* ハッシュ・配列の組み合わせをスペースによるインデントで表現したもの

```YAML
# 配列["Red", "Green", "Blue"]のYAML表現
- Red
- Green
- Blue

# ハッシュ{"country" => "Japan", "state" => "Tokyo"}のYAML表現
country: Japan
state: Tokyo
```



### YAMLの読み込み

YAMLの入出力に関するメソッドは、全てクラスメソッドなので、インスタンスを生成しないで呼び出すことが可能

* `load`：

  * YAMLデータが記録された文字列またはIOインスタンスからHashクラスのインスタンスを生成

  * 文字列またはIOに複数のYAMLが記録されていても、最初のYAMLのみが生成(残りは無視)

```ruby
require 'yaml'

yaml_data = <<-DATA
- Red
- Green
- Blue
---
- Yellow
- Pink
- White
DATA
p YAML.load(yaml_data)
=> ["Red", "Green", "Blue"]
```

* `load_file`：

  * 指定したパスのYAMLファイルからオブジェクトを生成する

  * `YAML.load`メソッドと同様に、ファイルに複数のYAMLが記録されていても、最初のYAMLのみが生成(残りは無視)

```ruby
# 6-3.sample.yml
- Red
- Green
- Blue
---
- Yellow
- Pink
- White

# 6-3.test.rb
require 'yaml'

p YAML.load_file "6-3.sample.yml"
=> ["Red", "Green", "Blue"]
```

* `load_stream`：

  * ioに記録された複数のYAMLデータを順番にロードし、結果を`YAML::Stream`のインスタンスで返す

```ruby
require 'yaml'

p yaml_stream = YAML.load_stream(File.open "6-3.sample.yml")
=> [["Red", "Green", "Blue"], ["Yellow", "Pink", "White"]]
```

* `load_documents`：

  * 引数のioに記録された複数のYAMLデータを順番にロードし、それぞれをブロック内で処理することができる

```ruby
require 'yaml'

YAML.load_documents(File.open "6-3.sample.yml") do |yaml|
  p yaml.first
end

# 実行結果
"Red"
"Yellow"
```



### YAMLの読み込み

* `dump(obj, io = nil)`：

  * 単一のインスタンスを文字列またはIOインスタンスに出力することができる。

  * 引数ioを省略すると、yaml形式に変化した文字列を返し、ioを指定すると指定した出力先にyaml形式のデータを書き込む

```ruby
require 'yaml'

colors = ["Red", "Green", "Blue"]
p YAML.dump colors
=> "---\n- Red\n- Green\n- Blue\n"

File.open("6-3.sample.yml", "w+") do |f|
  YAML.dump(colors, f)
end

# 実行結果
---
- Red
- Green
- Blue
```

* `dump_stream(*objs)`：

  * 複数のオブジェクトを文字列に出力することができる

```ruby
require 'yaml'

colors1 = ["Red", "Green", "Blue"]
colors2 = ["Yellow", "Pink", "White"]

p YAML.dump_stream colors1, colors2

# 実行結果
"---\n- Red\n- Green\n- Blue\n---\n- Yellow\n- Pink\n- White\n"
```



## 2.JSON

### JSONとは

* YAMLと同様に、簡単な記法でデータの階層構造を表現できるフォーマット

* ブラウザとサーバー間でデータを交換する形式として使用される

```ruby
# 配列["Red", "Green", "Blue"]のjson表現
["Red", "Green", "Blue"]

# ハッシュ{"country" => "Japan", "state" => "Tokyo"}のjson表現
{"country": "Japan", "state": "Tokyo"}
```



### JSONの読み込み

* `load(source, proc = nil)`：

  * 文字列からJSONを読み込む。

  * `source`はJSON形式の文字列を指定する(to_str、to_io、readメソッドを持つオブジェクトなら、文字列以外も指定可能)

  * `proc`には要素を読み込むごとに呼び出されるProcオブジェクトを渡すことができる

```ruby
require 'json'

json = <<-DATA
["Red", "Green", "Blue"]
DATA

p JSON.load(json)
=> ["Red", "Green", "Blue"]
```

* `load`にprocを渡すと、Procには解釈されたオブジェクトから順番に渡される

```ruby
require 'json'

json = <<-DATA
["Red", "Green", "Blue"]
DATA

JSON.load(json, lambda{|x| p x})

# 実行結果
"Red"
"Green"
"Blue"
["Red", "Green", "Blue"]
```

* `parse(source, options = {})`：

  * 文字列からJSONを読み込む。`load`とは異なり、`source`には文字列しか渡すことができない

  * `options`には解釈する時のオプションを指定することができる

* YAMLとは違い、ファイル名から直接読み込むメソッドはないが、`load`メソッドの引数にioオブジェクトを指定してデータを読み込むことができる

```ruby
# 6-3.sample.json
["Red", "Green", "Blue"]

# 6-3.test.rb
require 'json'

p JSON.load(File.open("6-3.sample.json"))
=> ["Red", "Green", "Blue"]
```



### JSONへの書き込み

* `dump(obj, io = nil, limit = nil)`：

  * `obj`に書き出したい対象のオブジェクトを指定する

  * 文字列で結果を得たい場合は、第2・3引数を省略して呼び出す

```ruby
require 'json'

array = ["Red", "Green", "Blue"]
p JSON.dump(array)
=> "[\"Red\",\"Green\",\"Blue\"]"
```

* ファイル等に書き出したい時は、ioにIOオブジェクトを指定する

* `limit`はダンプするオブジェクトの参照の深さを指定することができ、`limit`以上深くリンクしたオブジェクトを

* ダンプしようとすると、`ArgumentError`が発生する

```ruby
require 'json'

array = ["Red", "Green", "Blue"]
File.open("6-3.sample.json", "w+") do |f|
  JSON.dump(array, f)
end

# 実行結果
["Red","Green","Blue"]
```



## 3.CSV

### CSVとは

* Comma Separated Values

* データを感まで区切ったテキストデータ

* 古くから多くの表計算ソフトや、データベースソフトなどで使用されているデータフォーマット

```csv
abc,def,efg,hijk
123,456,789,10
ABCDEFG,,HIJKLM,,
```



### 読み書き可能なメソッド

* `open`：

```ruby
CSV.open(filename, mode = "rb", options = {}){|csv| ...}
CSV.open(filename, mode = "rb", options = {})
CSV.open(filename, options = {}){|csv| ...}
CSV.open(filename, options = {})
```

* CSVをモードで指定した形式でオープンし、ブロックで処理する

> modeで指定できる形式

|mode|        意味       |
|----|:------------------|
|'r' |読み込み            |
|'w' |書き込み            |
|'rb'|バイナリ読み込みモード|
|'rw'|バイナリ書き込みモード|

* 読み込み時はfilenameで指定したファイルをオープンし、各行を配列としてブロック引数に渡す

  * ブロックを渡さなかった場合は、CSVオブジェクトが返る

* デフォルトの区切り文字は`CRLF/LF`、`CR`を区切りにするには、optionsに`{ row_sep: ?\r}`を渡す必要がある

```ruby
require 'csv'

CSV.open("6-3.sample.csv") do |csv|
  csv.each do |row|
    p row
  end
end

# 実行結果
["abc", "def", "efg", "hijk"]
["123", "456", "789", "10"]
["ABCDEFG", nil, "HIJKLM", nil, nil]
```

* 書き込み時はfilenameで指定したファイルをオープンし、CSVオブジェクトをブロック引数に渡す

* ブロックを渡さなかった場合は、CSVオブジェクトが返る

```ruby
require 'csv'

CSV.open("6-3.sample.csv", "w") do |row|
  row << ["abc", "def", "ghijk"]
  row << ["lmn", "opq", "rstuv"]
end

# 実行結果
abc,def,ghijk
lmn,opq,rstuv
```



### 読み込みのみ可能なメソッド

* `foreach`：読み込みを行う。ブロック引数にEnumeratorオブジェクトを受け取り、それ経由で各行を受け取ることができる

  ブロックを渡さなかった場合は、Enumeratorオブジェクトが返る

```ruby
CSV.foreach(path, options = {}){|row| ...}
```

* `read`・`readlines`：読み込みを行う。内部の処理は異なるが、どちらも読み込み結果を配列の配列に格納して返す

  * optionsに|headers: true|を渡すと、`CSV::Table`が返る

```ruby
require 'csv'

p CSV.read("6-3.sample.csv")
=> [["abc", "def", "efg", "hijk"], ["123", "456", "789", "10"], ["ABCDEFG", nil, "HIJKLM", nil, nil]]

p CSV.readlines("6-3.sample.csv")
=> [["abc", "def", "efg", "hijk"], ["123", "456", "789", "10"], ["ABCDEFG", nil, "HIJKLM", nil, nil]]

csv_table = CSV.read("6-3.sample.csv", headers: true)
p csv_table
=> #<CSV::Table mode:col_or_row row_count:3>
p csv_table.to_a
=> [["abc", "def", "efg", "hijk"], ["123", "456", "789", "10"], ["ABCDEFG", nil, "HIJKLM", nil, nil]]
```



| 版     | 年/月/日   |
| ------ | ---------- |
| 初版   | 2018/10/19 |
| 第二版 | 2019/05/13 |
