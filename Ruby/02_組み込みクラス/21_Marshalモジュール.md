21 Marshalモジュール
====================

## 目次

* [Marshalモジュールとは](#0Marshalモジュールとは)

* [文字化できないもの](#1文字化できないもの)

* [Rubyオブジェクトを文字列化する](#2Rubyオブジェクトを文字列化する)

* [Rubyのオブジェクトを復元](#3Rubyのオブジェクトを復元)



## 0.Marshalモジュールとは

* Rubyのオブジェクトを文字化し、ファイルに書き出したり読み戻したりする機能を担う

  * この文字化したデータのことを、「マーシャルデータ」と呼ぶ

* オブジェクトを永続化するための機能も担っている

* マーシャルデータの例として、

  * Railsのセッション変数をクッキーやデータベースに登録するとき

* 一部書き出せないクラスが存在しており、また書きだすオブジェクトに制限がある



## 1.文字化できないもの

文字列化できない以下のオブジェクトが指定された場合は、`TypeError`が発生する

* 無名のクラス・モジュール、およびそれらを継承したクラスのインスタンス(`ArgumentError`が発生)

* システムがオブジェクトの状態を保持するような、Dir、IO、Fileクラスなど

* Proc、Thread、MatchDataクラスなどのインスタンス

* 特異メソッドを定義したオブジェクト

* 上記のいずれかを内包しているオブジェクト

  * 初期値をブロックで指定したHashクラスのオブジェクトなど



## 2.Rubyオブジェクトを文字列化する

* `dump`：Rubyのオブジェクトを文字列化する

```ruby
>> Marshal.dump({a: 1, b: 3, c: 5})
=> "\x04\b{\b:\x06ai\x06:\x06bi\b:\x06ci\n"
```

* 2つ目の引数に、IOクラスかそのサブクラスのオブジェクトを指定すると、そのオブジェクトの対象に直接書き出す

```ruby
>> file = File.open("README", "w+")
=> #<File:README>
>> Marshal.dump({a: 1, b: 3, c: 5}, file)
=> #<File:README>
```

## 3.Rubyのオブジェクトを復元

* `load`：文字列化したマーシャルデータから、Rubyのオブジェクトを復元する

```ruby
>> str = Marshal.dump({a: 1, b: 3, c: 5})
=> "\x04\b{\b:\x06ai\x06:\x06bi\b:\x06ci\n"
>> Marshal.load(str)
=> {:a=>1, :b=>3, :c=>5}
```

* 2つ目の引数に、IOクラスかそのサブクラスのオブジェクトを指定すると、そのオブジェクトから直接読み戻して復元する

```ruby
>> file = File.open("README", "w+")
=> #<File:README>
>> Marshal.dump({a: 1, b: 3, c: 5}, file)
=> #<File:README>
>> file.rewind
=> 0
>> Marshal.load(file)
=> {:a=>1, :b=>3, :c=>5}
```



| 版     | 年/月/日   |
| ------ | ---------- |
| 初版   | 2018/10/13 |
| 第二版 | 2019/05/11 |
