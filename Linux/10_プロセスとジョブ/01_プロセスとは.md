01 プロセスとは
=============

* これまで多くのコマンドを扱ってきたが、これらのコマンドの実体は、**ディスク上に保存されたファイル**

* シェルからコマンドを実行すると、

  1. Linuxカーネルはディスクから実行ファイルを読み出してメモリに格納

  1. そのメモリ内容に従ってCPUがプログラムを実行する

* ここで、**メモリ上で実行状態にあるプログラム**　は、「`プロセス`」と呼ぶ

![プロセスの概要](./images/プロセスの概要.png)

* `プロセス`は、同一のコマンドから実行されていても、それぞれ別個のメモリ領域を持つ

  * そのため、`ls`コマンドが3個同時に実行されても、それら3個のプロセスが内部に持つデータがお互いに混ざることはない

  * また、プロセスには、ファイルのオーナーと同様に「`実効ユーザ`」が設定されており、他人のプロセスを勝手に操作することができないようになっている

  => Linuxカーネルが1つ1つのプロセスに「`プロセスID`」という一意の番号を割り振って、適切にプロセスを管理しているため

  => プロセス管理は、Linuxカーネルが持つ重要な機能の一つ

* なおLinuxで`プロセス`が新しく作られる時には、すでに存在している別のプロセスを元に作成される

  * これを親子関係で表現しており、

    * 作成するプロセス：`親プロセス`

    * 作成されるプロセス：`子プロセス`

    と呼ぶ

  * 例)シェルから`ls`コマンドを実行する

    * `親プロセス`：シェル

    * `子プロセス`：`ls`コマンドのプロセス



## psコマンド - プロセスの表示

* `ps`コマンド：現在動作しているプロセスを表示する

  * 引数なしで実行すると、現在のターミナルで実行しているプロセスだけを表示する

  * 下の例では、はじめの`PID`が`プロセスID`、`CMD`というカラムが **実行されているコマンド**

    * ここでは、`プロセスID`が5481のbashと、7716のpsという2つのプロセスが動作している

    * bash：現在実行しているシェル、ps：実行したpsコマンド

![psコマンドによるプロセス確認](./images/psコマンドによるプロセス確認.png)

* `less`コマンドを2つ実行している場合、同名の`less`というプロセスが2つある

  * それぞれのプロセスIDは「15009」、「15119」と異なっているため、2つのプロセスは区別することができる

```bash
[kunii.sotaro@localhost ~]$ ps
  PID TTY           TIME CMD
14617 ttys000    0:00.09 -bash
15009 ttys000    0:00.00 less README.md
15119 ttys002    0:00.00 less README.md
15449 ttys003    0:00.00 ps
```

* `プロセスID`は、プロセスが起動してから終了するまで変化しない

  * そのため、プロセスを操作する時は、この`プロセスID`を使ってプロセスを特定することができる



### 現在のターミナル以外のプロセスも表示する

* `xオプション`：別のターミナルで実行しているコマンドや、「デーモン(daemon)」と呼ばれるターミナルに接続していないプロセスを表示する

  * **現在のユーザが実行している全てのプロセスを表示できる**

  * 例)`xオプション`に、`fオプション`(プロセスの親子関係を表示する)を合わせて指定する

    * プロセスIDが「5481」のbashから`ps xf`が起動している

  ![現在のユーザが実行中の全てのプロセスを表示](./images/現在のユーザが実行中の全てのプロセスを表示.png)

* `TTY`というカラムは、ターミナルを意味する

  * 例では、`tty3`というターミナルでログインして作業している

  * `sshd`というSSH接続を終端とするプロセスは`TTY`に`?`と表示される

  => ターミナルに接続していないプロセス(デーモン)ということを意味する



### オプション形式

* Linuxの`ps`コマンドは、歴史的な理由から以下の **2種類のオプション形式** がある

  1. UNIXオプション：ハイフン付きでオプションを指定する(`ps -aef`など)

  1. BSDオプション：ハイフンなしでオプションを指定する(`ps xf`など)

* この2種類はオプション記号の意味も異なるため、別物として覚える必要がある

  * っこでは、BSDオプションを用いる



### 全てのプロセスの表示

* Linuxでは、ログイン中のユーザが実行しているプロセス以外にも、Linuxのシステム自体を管理するためのプロセスが初めから動いている

  * これらの多くは、スーパーユーザの権限で実行されている

* `x`オプション：`a`オプションと加えて、自分のプロセスだけでなく、システムで動いている全てのプロセスを表示する

![システムで動作している全てのプロセス](./images/システムで動作している全てのプロセス.png)

* Linuxを起動してログイン直後の何も作業を行なっていない状態でも、通常は数十個以上のプロセスが動いている

  * Linuxはマルチタスク機能によって、様々なプロセスが同時に動作している



### よく使われるオプション

* `ps`コマンドには非常に多くのオプションが存在している

  * `man ps`と打ち込んで`ps`コマンドのマニュアルを読むことで対応する

* 以下の表では、よく使われるオプションの一覧を表示している

| オプション | 意味                                                                                          |
| :--------- | :-------------------------------------------------------------------------------------------- |
| `x`        | psコマンドを実行したユーザのプロセス全てを表示                                                |
| `ux`       | psコマンドを実行したユーザのプロセスを、詳細情報を合わせて表示                                |
| `ax`       | 全てのユーザのプロセスを表示                                                                  |
| `aux`      | 全てのユーザのプロセスを、詳細情報を合わせて表示                                              |
| `auxww`    | `aux`オプションで、コマンドが長くターミナルの右端で切れてしまう際に、表示幅を制限せず全て表示 |



| 版 |  年/月/日 |
|----|----------|
|初版|2019/03/02|
