02 ファイルのパーミッション
=======================

* 1つ1つのファイルには、**「誰に、どのような操作を許可するか」** を規定する情報が設定されている

  => この情報のことを、`パーミッション`と呼ぶ

* ファイルのパーミッションも、オーナーと同じく`ls`コマンドに`-l`オプションを付けることで確認できる

![ファイルのパーミッション](./images/ファイルのパーミッション.png)

* `-l`オプションで表示される先頭の1文字は、`ファイルタイプ`

  * `-`：通常のファイル

  * `d`：ディレクトリ

  * `l`：シンボリックリンク

* ファイルタイプの後ろの9文字、`rwxr-xr-x`の部分は、`ファイルモード`

  => これによってファイルパーミッションを表している

  * `rwx`、`r-x`、`r-x`という3文字ごとに1つのブロックになっている

    * `rwx`：`オーナー`に対するパーミッション

    * `r-x`：`グループ`に対するパーミッション

    * `r-x`：`その他のユーザ`に対するパーミッション

* `r`や`x`といった記号は、許可されるファイルへの操作を意味している

  * 操作には「読み取り(`r`)」、「書き込み(`w`)」、「実行(`x`)」の3種類がある

  | 記号 | 意味              |
  | :--- | :---------------- |
  | `r`  | 読み取り(*r* ead)  |
  | `w`  | 書き込み(*w* rite) |
  | `x`  | 実行(e *x* ecute)   |

* `ls`コマンドの`-l`オプションでは、操作が許可になっている時には「`r`」「`w`」「`x`」という記号が表示される

  * 許可されていない場合は、「`-`」が表示される

  * 例)`/bin/cat`ファイルのパーミッション`rwxr-xr-x`

  | ユーザ種別                   | 読み取り | 書き込み | 実行 |
  | ---------------------------- | -------- | -------- | ---- |
  | オーナー                     | 許可     | 許可     | 許可 |
  | rootグループに所属するユーザ | 許可     | 禁止     | 許可 |
  | その他のユーザ               | 許可     | 禁止     | 許可 |

  * このファイルはオーナーにしか書き込み権限がないので、その他のユーザはファイルを上書きすることができない

  * どのユーザにも実行権限がついているため、誰でも実行可能

* `/etc/crontab`ファイルのパーミッションは、以下の通り

![crontabファイルのパーミッション](./images/crontabファイルのパーミッション.png)

  * `rw-`、`r--`、`r--`というファイルのパーミッションとなっている

    * `rw-`：`オーナー`は「読み取り(`r`)」、「書き込み(`w`)」のみ可能

    * `r--`：`グループ`は「読み取り(`r`)」のみ可能

    * `r--`：`その他のユーザ`は「読み取り(`r`)」のみ可能

    * このファイルも`root`ユーザにしか書き込み権限がないので、その他のユーザはエディタなどで上書き保存しても失敗する

    * どのユーザに対しても実行権限がないので、コマンドとして実行することができない

    ```bash
    $ /etc/crontab
    -bash: /etc/crontab: Permission denied
    ```



## ディレクトリのパーミッション

* ファイルと同様に、ディレクトリにもパーミッションが設定されている

* `-d`オプション：`ls`コマンド+`-l`オプションに加えて、ディレクトリのパーミッションを確認する

![ディレクトリのパーミッション](./images/ディレクトリのパーミッション.png)

* ディレクトリのパーミッションの表示は、ファイルと同じく「`r`」「`w`」「`x`」という記号を使うが、ファイルとは違った意味を持つ

* 表. ディレクトリのパーミッションの記号と意味

| 記号 | 意味                                                                 |
| ---- | -------------------------------------------------------------------- |
| `r`  | `読み取り`：ディレクトリに含まれるファイル一覧の取得                 |
| `w`  | `書き込み`：ディレクトリの下にあるファイル・ディレクトリの作成・削除 |
| `x`  | `実行`：ディレクトリをカレントディレクトリにする                     |

* `r`：そのディレクトリに含まれるファイル一覧を取得できる

  * 読み取りが設定されていない場合は、`ls`コマンドがエラーとなり、ファイル一覧を取得することができない

  ![ファイル一覧が取得できない](./images/ファイル一覧が取得できない.png)

* `w`：そのディレクトリ下のファイルの作成・削除が行える

  * **ファイルの削除ができるかどうかディレクトリのパーミッションで決まる**

  => ファイル自身のパーミッションは関係ないことに注意する

  * `r--r--r--`(読み取りのみ可能)と設定されている`readonly.txt`が、`rm`コマンドで削除されている

  ![ファイル自体は書き込み不可でも削除できる](./images/ファイル自体は書き込み不可でも削除できる.png)

* `x`：`cd`コマンドでそのディレクトリに移動したり、ディレクトリ下にあるファイルの読み書きを行うことができる

  * 例)ディレクトリに実行(`x`)が設定されていないため、`cd`コマンドがエラーとなっている

  ![実行が設定されていないディレクトリへはアクセスできない](,/images/実行が設定されていないディレクトリへはアクセスできない.png)

* 例)`rwxr-xr-x`：他のユーザから閲覧されても良いディレクトリ

  * オーナーは全ての操作が可能

  * 他のユーザも`cd`コマンドでそのディレクトリに移動してファイルの読み取りをすることができる

  * その他のユーザがファイルを作成したり削除することはできない

* 例)`rwx------`：他のユーザから閲覧されたくないディレクトリ

  * 他のユーザからはこのディレクトリの内容を一切知ることができなくなる



## chmodコマンド-ファイルモードを変更する

* `chmod`コマンド：ファイルやディレクトリのパーミッションを設定する

  * 「`シンボルモード`」による指定と、「`数値モード`」による指定の2種類が存在する

  * ファイルのパーミッションは、`オーナー`か`スーパーユーザ`しか変更することはできない

    => 誰でもファイルのパーミッションを変更できてしまうと、パーミッションで操作を禁止する意味がないため



### シンボルモード

* `シンボルモード`では、次のような書式で`chmod`コマンドを実行する

```bash
chmod [ugoa][+-=][rwx] <ファイル名>
```

* `シンボルモード`の指定は、「誰に、どのような権限を追加(もしくは禁止)するのか」をわかりやすく指定する

![シンボルモードでの指定](./images/シンボルモードでの指定.png)

* 初めの`ugoa`は、どのユーザに対するパーミッションを変更するのかを指定している

  * 表. chmodコマンドのユーザ指定

  | 記号 | 意味           |
  | ---- | -------------- |
  | `u`  | オーナー       |
  | `g`  | グループ       |
  | `o`  | その他のユーザ |
  | `a`  | `ugo`全て      |

  * ただし、ユーザ指定を省略すると、`a`を指定したものとみなされる

* 次の`+-=`は、権限を追加するのか禁止するのかの操作を表している

  * 表. chmodコマンドの演算子

  | 記号 | 意味                     |
  | ---- | ------------------------ |
  | `+`  | 権限を追加する           |
  | `-`  | 権限を禁止する           |
  | `=`  | 指定した権限と等しくする |

* 最後の`rwx`は、`ls -l`コマンドの出力で表示されたものと同じく、「読み取り」「書き込み」「実行」それぞれのパーミッションを意味する

* 例)`+`を利用して、`file.txt`というファイルに対してオーナーの書き込み権限を追加

  => `r--r--r--`というパーミッションであるとする

  ```bash
  $ chmod u+w file.txt
  ```

  ![シンボルモードでの権限追加](./images/シンボルモードでの権限追加.png)

  => `r--r--r--`から`rw-r--r--`に変更された

* 例)`-`を利用して、グループの書き込みを禁止

  => `rw-rw-r--`というパーミッションであるとする

  ```bash
  $ chmod g-w file.txt
  ```

  ![シンボルモードでの権限追加](./images/シンボルモードでの権限追加.png)

  => `rw-rw-r--`から`rw-rw-r--`に変更された

  * 元々はオーナーとグループに書き込み許可を与えていたファイルを、自分にしか書き込めないように変更するケース、が考えられる

* 例)`=`を利用して、グループおよびその他のユーザに対するパーミッションを「読み取り」だけにする

  => `rwxrwxrwx`というパーミションであるとする

  ```bash
  $ chmod go=r file.txt
  ```

  ![複数のユーザの権限をまとめて指定](./images/複数のユーザの権限をまとめて指定.png)

  => `rwxrwxrwx`から`rwxr--r--`に変更された

* ここで紹介したシンボルモードは、相対的な指定方法

  * 指定したパーミッション以外では変化しない

  * 「オーナーの権限のみ」など、**パーミッションの一部だけを変更したい** 時に便利



### 数値モード

* `数値モード`では、以下のような書式になる

```bash
chmod <8進数> <ファイル名>
```

* `数値モード`では、**元のパーミッションに関わらず新しいパーミッションの値へと変更する**

  => 絶対指定の方法

* パーミッションを数値で表現するには`rwx`のうち許可する操作を、以下の表のような数値に置き換えて、それを足し算する

  * 表. 数値モードでのパーミッションの数値

| 意味          | 数字 |
| ------------- | ---- |
| 読み取り(`r`) | 4    |
| 書き込み(`w`) | 2    |
| 実行(`x`)     | 1     |

* 足した値を「オーナー」「グループ」「その他のユーザ」の順に3つ並べて指定する

  * この3桁の数字が、パーミッションを指定するための値

* 例)`rwxr-xr-x`というパーミッションは、数字に変換すると`755`となる

![数値モードでのパーミッションの数値](./images/数値モードでのパーミッションの数値.png)

  * chmodコマンドに`755`を指定することで、元のパーミッションが何であれ、`rwxr-xr-x`というパーミッションに変更される

  ![数値モードでの755](./images/数値モードでの755.png)

  * オーナーは読み書き実行が可能、その他のユーザは読み取りと実行が可能という状態

  => 他のユーザに見られても良い実行可能ファイルは通常このパーミッションにする

* 例)`rw-r--r--`というパーミッションは、数字に変換すると`644`となる

![数値モードでの644](./images/数値モードでの644.png)

  * オーナーは読み書き可能、その他のユーザは読み取りだけ可能という状態

  * 他のユーザーに見られても良いファイルは、通常このパーミッションにする



| 版 |  年/月/日 |
|----|----------|
|初版|2019/02/14|
