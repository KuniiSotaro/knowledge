03 スーパーユーザ
==============

* Linuxのユーザの中には、`スーパーユーザ`と呼ばれる、「管理者権限」を持つ特別なユーザが存在する

* `スーパーユーザ`は、ユーザ名が`root`であることから、「rootユーザ」と呼ばれる

  * ここまでの例で使用された`xxx`などの、通常の作業に利用するユーザは「一般ユーザ」と呼ばれる

* `スーパーユーザ`はあらゆる操作が許可された強い権限を持つユーザであり、

  * システムの設定ファイルを変更する

  * 新しいアプリケーションをインストールする

  ことができる

* `スーパーユーザ`はファイルのパーミッションの影響を受けずに、

  * 全てのファイルの読み込み

  * 全てのファイルの書き込み

  * 全てのファイルの削除

  が可能

  => このような操作は一般ユーザでは行えないので、Linuxのシステム管理を行う上では`スーパーユーザ`が必要となる

* しかし`スーパーユーザ`は、Linuxを動作させる上での必須のファイルを削除するなど、危険な操作も実行できる

  * 一般ユーザで操作を誤ったとしても、重要なシステムファイルなどは削除できないし、最悪でもそのユーザが作成したファイルが壊れるだけ

  * スーパーユーザで操作を誤ると、Linuxシステム自体を破壊してしまうこともある

  => **通常は一般ユーザでログインして操作し、必要な時だけスーパーユーザとして作業する**

* 一般ユーザからスーパーユーザに変わる方法として、`su`コマンドと`sudo`コマンドが存在する



## suコマンド - ユーザを変更する

* `su`コマンド：一時的に別のユーザになるためのコマンド

  * 実行すると、ログアウトせずに他のユーザに切り替わることができる

  * 任意のユーザになることができるが、主に **スーパーユーザに変わるため** に使う

  => Linuxではセキュリティ上の理由からスーパーユーザで直接ログインできないように設定されていることが多い

  => 一般ユーザでログインしてから`su`コマンドでスーパーユーザになる、という形で利用する

![suコマンドでスーパーユーザになる](./images/suコマンドでスーパーユーザになる.png)

* `su`コマンドを引数なしで実行すると、`スーパユーザ`になることができる

  * この際、パスワードを尋ねられるので、スーパーユーザのパスワードを入力する

  * 一般的な設定では、プロンプトが`$`から`#`に変わる

![suコマンドの実行](./images/suコマンドの実行.png)

* `スーパーユーザ`として作業を終えたら、`exit`コマンドで元の一般ユーザに戻ることができる

![スーパーユーザから一般ユーザに戻る](./images/スーパーユーザから一般ユーザに戻る.png)

* オプションを付けない`su`コマンドでユーザを切り替えると、環境変数やカレントディレクトリなど現在の環境を維持したままユーザだけが切り替わる

* 一方、次のように`su`コマンドに`-`(ハイフン)を付けて実行すると、`スーパーユーザ`の環境に初期化されてユーザが切り替わる

![スーパーユーザの環境に初期化して切り替える](./images/スーパーユーザの環境に初期化して切り替える.png)



## sudoコマンド - コマンドを別のユーザとして実行する

* `sudo`コマンド：別のユーザとしてコマンドを実行するために利用される

  * ユーザを特に指定しない場合には、`スーパーユーザ`としてコマンドを実行する

  * これは主に、**一般ユーザでログインしている時に、スーパーユーザでないと実行できないコマンドを実行する** ために使用される

* 例)`kunii.sotaro`という一般ユーザでログインしている時に、`/etc/shadow`というパスワードファイルの内容を閲覧する

  * 一般ユーザでは読み取り権限がないため、エラーとなる

  * `sudo`コマンドを実行すると、パスワードを尋ねられる

  => 現在ログインしているユーザのパスワードを入力する

```bash
$ cat /etc/shadow
cat: /etc/shadow: Permission denied

$ sudo cat /etc/shadow
[sudo] password for xxx:
# 省略
```

* `sudo`は、**1つのコマンドだけをスーパーユーザ権限で実行する** ところが異なる

  * `su`コマンドでスーパーユーザに切り替わった時には、明示的に`exit`するまでスーパーユーザのまま

  * `sudo`コマンドを実行した場合は、そのコマンドが終了すれば元の一般ユーザの状態に自動的に戻る

* `sudo`を実行する際に入力するパスワードは、スーパーユーザのパスワードでなく、現在ログインしているユーザのパスワードであることに注意する

  * `su`コマンドではスーパーユーザのパスワードが必要だった

  * `sudo`を利用するには、スーパーユーザのパスワードは不要



### sudoコマンドの設定

* `sudo`コマンドは、一般ユーザにスーパーユーザの権限を与えるコマンド

  * この際、全てのユーザが`sudo`コマンドを使えるようにしてしまうと、`スーパーユーザ`と一般ユーザの区別している意味がなくなる

  * どのユーザにコマンドを実行する権限を与えるのか、という設定を行うことができる

  * Linuxをインストールした直後の状態で`sudo`が許可されているかどうかは、ディストリビューションによって異なる

* ユーザに`sudo`を許可するかどうかは、`/etc/sudoers`ファイルで管理されている

  * このファイルは、一般ユーザには読み込み権限が与えられていないため、内容を確認するには`su`または`sudo`でスーパーユーザとして`cat`コマンドを実行する

```bash
$ su -
password:
# cat /etc/sudoers
```

* `sudoers`ファイルは、「`<ユーザ><マシン名>=(<権限>)<コマンド>`」の形式で記述する

  * `<ユーザ>`の部分は、

    * 直接ユーザ名を書く

    * `%<グループ名>`

    の形でグループを記述する

* 例)初期状態で`sudo`が許可されているディストリビューションの場合の`/etc/sudoers`ファイル

  => 「`wheel`グループに所属するユーザは、全てのマシンで、全てのユーザとして、全てのコマンドを実行できる」

  * `wheel`グループ：システム管理を行うためのグループ

```bash
%wheel ALL=(ALL) ALL
```

* あるユーザに`sudo`が許可されていない場合には、`スーパーユーザ`が`/etc/sudoers`ファイルに追記して権限を追加することができる

  * 例)xxxユーザに、`sudo`を使って全てのコマンドを実行する権限を付加する

  ```bash
  xxx ALL=(ALL) ALL
  ```

* ただし、業務において複数人でLinuxマシンを使うような場合には、ALL設定をしてしまうと、スーパーユーザのパスワードを知らない人も管理者権限を実行できてしまう



### visudoコマンド - sudoersファイルを編集する

* `sudo`の設定を行う際、`/etc/sudoers`ファイルを **直接テキストエディタで開いて編集してはいけない**

  * 書き方を誤ると`sudo`が動作せずに、どのユーザも`sudo`が使えなくなってしまう

  * `/etc/sudoers`の誤りを修正するには、スーパーユーザの権限が必要になるため、二度とスーパーユーザの権限を取得できない状態になる

* `visudo`コマンド：`/etc/sudoers`ファイルを編集する

  * このコマンドを実行するには、スーパーユーザの権限が必要

```bash
$ su -
password:
# visodo
```

* 実行すると、テキストエディタが起動して`/etc/sudoers`ファイルを開いた状態になる

  * 特に設定をしていない場合は、Vimが起動した状態になる

  * エディタでの編集内容に文法上の誤りがある場合は、終了しようとした時にエラーが発生する

  * 次のようなエラーの対処が行える

    * `e`：ファイルを再度編集する

    * `x`：ファイルの変更を保存せずに終了する

    * `Q`：ファイルへの変更を保存して終了する(危険)

  * 上書きする前に記述内容の文法チェックが行われるので、直接編集するよりも安全に作業できる



### suとsudoのどちらを使うか

* `su`コマンド：`exit`コマンドで明示的に終了するまで、スーパーユーザ権限が継続する特徴がある

  * スーパーユーザで作業する時間が長くなる傾向がある

* `sudo`コマンド：1つのコマンドだけをスーパーユーザ権限で実行するので、必要な時だけスーパーユーザとしてコマンドを実行する

* スーパーユーザでの操作は、システムに必要なファイルを削除してしまうなど、小さなミスが致命的な問題を引き起こす可能性がある

  * スーパーユーザでの操作は、最小限に抑えることが推奨されている

  * 現在では、**suよりもsudoの方がよく使われる**



| 版 |  年/月/日 |
|----|----------|
|初版|2019/02/24|
