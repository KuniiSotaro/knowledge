03 ジョブ・プロセスの終了
=====================

* コマンドを誤って実行してしまったり、プログラムの不具合などによってコマンドが操作を受け付けなくなる場合には、シェルからコマンドを終了させる必要がある



### ジョブの終了

* ジョブを終了させるには、そのジョブの状態によって操作が異なる

* `フォアグランドジョブ`を実行中の場合は、終了するにはそこで`Ctrl + c`を押す

  * 例)誤って実行した`cp`コマンドを`Ctrl + c`で終了する

  ```bash
  $ cp file1 file2
  ^c
  $
  ```

* `バックグラウンドジョブ`は、キーボード入力を受け付けていない

  * `Ctrl + c`を入力することはできない

  * `kill`コマンド：バックグラウンドジョブを終了させる

    * ジョブ番号を指定する

    ```bash
    kill %<ジョブ番号>
    ```

    * バックグラウンドジョブが以下のようにあるとする

    ```bash
    $ jobs
    [1]   Stopped                 man bash
    [2]-  Stopped                 vim ~/.bashrc
    [3]+  Stopped                 less /etc/ttys
    ```

    * このうち、`man bash`のジョブを終了するには、以下のように打ち込む

    ```bash
    $ kill %1
    [1]   Terminated: 15          man bash
    ```

    * ジョブが終了すると、上記のように「terminated」というメッセージが表示される

    * 終了すると、`jobs`コマンドでジョブが表示されなくなる

    ```bash
    $ jobs
    [2]-  Stopped                 vim ~/.bashrc
    [3]+  Stopped                 less /etc/ttys
    ```



### プロセスの終了

* プロセスを終了するには、バックグラウンドジョブの終了と同様に`kill`コマンドを使う

  * プロセスの場合は、`%`を付けずにプロセスIDをそのまま指定する

  ```bash
  kill <プロセスID>
  ```

* 次の例は、2つのターミナルで作業しており、片方のターミナルでは`less`コマンドでファイルを閲覧している状態

  ```bash
  $ ps
  PID TTY           TIME CMD
  15899 ttys000    0:00.05 -bash
  14303 ttys001    0:00.42 -bash
  15880 ttys001    0:00.02 vim /Users/MacUser/.bashrc
  15882 ttys001    0:00.00 less /etc/ttys
  ```

* ここで、プロセスID 15882の`less`コマンドを終了させるためには、もう1つのターミナルから次のように打ち込むことで、プロセスを終了することができる

  ```bash
  $ kill 15882
  ```

* ただし、他人のプロセスを勝手に終了させることができないように、プロセスを終了できるのはその実効ユーザのみとなっている

  * 例外として、スーパーユーザは全てのユーザのプロセスを終了させることができる



### killコマンド - シグナルを送信する

* `kill`コマンドは、正しく言うと「シグナルを送信するコマンド」

* `シグナル`：プロセスに送信される信号

  * プロセスは受け取ったシグナルの種類によって、「終了」、「停止」、「再起動」など様々な振る舞いをする

  * 実行中のプロセスに対してシグナルを送ることで、プロセス間で通信を行うことができる

* `kill`コマンドで送信するシグナルの種類は、「`kill -<シグナル名>`」と言う形で指定できる

  * 省略すると、デフォルト値として`TERM`と言うシグナルを送信する

  * 以下のシグナルは、同じ意味

  ```bash
  kill 4695
  kill -TERM 4695
  ```

  * それぞれのシグナルには番号が付いており、`kill`コマンドではこのシグナル番号で指定しても良い

  * `TERM`シグナルのシグナル番号は15番なので、以下の例は`kill 4695`と同じ意味

  ```bash
  kill -15 4695
  ```

  * `TERM`と言うシグナルは、「Terminate」(終了)を指示する

  => そのため、シグナルを指定せずに`kill`コマンドを実行すると、ジョブ・プロセスは終了する

* `Ctrl + c`や`Ctrl + z`についても、シグナルを送信するための操作

  * `Ctrl + z`：`TSTP`(停止)

  * `Ctrl + c`：`INT`(終了)

  と言うシグナルを送信する

* `-l`オプション：`kill`コマンドに付けて実行することで確認することができる

  ```bash
  $ kill -l
  1) SIGHUP	 2) SIGINT	 3) SIGQUIT	 4) SIGILL
  5) SIGTRAP	 6) SIGABRT	 7) SIGEMT	 8) SIGFPE
  9) SIGKILL	10) SIGBUS	11) SIGSEGV	12) SIGSYS
  13) SIGPIPE	14) SIGALRM	15) SIGTERM	16) SIGURG
  17) SIGSTOP	18) SIGTSTP	19) SIGCONT	20) SIGCHLD
  21) SIGTTIN	22) SIGTTOU	23) SIGIO	24) SIGXCPU
  25) SIGXFSZ	26) SIGVTALRM	27) SIGPROF	28) SIGWINCH
  29) SIGINFO	30) SIGUSR1	31) SIGUSR2
  ```

  * `9) SIGKILL`のみは例外で、プロセスに渡されずに直接Linuxカーネルが処理する



| 版 |  年/月/日 |
|----|----------|
|初版|2019/03/03|
