01 sedコマンド
=============

* `sed`コマンド：ストリームエディタ

  * 文字列を置換するために用いられることが多い

  * 動作としては以下の流れをとる

    1. シェルから編集のためのコマンドを引数として与えて、`sed`コマンドを実行する

    1. `sed`コマンドは編集対象のテキストに対して、与えられた編集コマンドに対応する編集操作を行う

    1. 編集後のテキストを、`sed`コマンドが標準出力に出力する

  * 決まったパターン(「Osakaという文字列をTokyoに置換する」)では非常に効率的

  * 正規表現が利用できるため、編集パターンの定義も柔軟に行える

  * 編集結果を標準出力に出力するため、**元のファイルは変更しない**

    => ファイルを壊す心配をせずに気軽に試してみることができる

  * `sed`はフィルタとして動作するため、編集対象のファイルがない場合には標準出力kら読み込む

    => このパイプを使って、他のコマンドの出力結果を編集する目的にもよく使われる

![非対話型エディタとは](./images/非対話型エディタとは.png)



## sedコマンドの形式

```bash
sed [オプション] <スクリプト> <対象ファイル>
```

* `<スクリプト>`：「アドレス」と「コマンド」を組み合わせた文字列

* さらに引数やフラグを取ることがある

* また、アドレスは省略することができ、その場合は全ての行が対象となる

![sedコマンドの例1](./images/sedコマンドの例1.png)

![sedコマンドの例2](./images/sedコマンドの例2.png)

* ここでは、以下のコマンドを用いる

  * `d`：行を削除する

  * `p`：行を表示する

  * `s`：行を置換する

* サンプルとしては、以下のファイルを用いる

```txt
# drink2.txt
Ber
Beer
BeerBeerBeer
Beeeeeeeeer!!!!
My Vodka
My Wine
```



## 行を削除する

* `d`：行を削除するコマンド

* `sed`コマンドは、アドレスで指定された行のみ作用する

  * アドレスの指定には、いくつの形式があるが、まずは行番号で指定してみる

  * 例)アドレスに`1`を指定して、1行目だけに`d`コマンドを実行する

    => 結果として、1行目は削除されて表示されない

  ```bash
  $ sed 1d drink2.txt
  Beer
  BeerBeerBeer
  Beeeeeeeeer!!!!
  My Vodka
  My Wine
  ```

* アドレスの範囲は、`n,m`の形で「n行目からm行目まで」と指定できる

  * 例)2行目から5行目までを削除

  => 1、6、7行目が表示される

  ```bash
  $ sed 2,5d drink2.txt
  Ber
  My Vodka
  My Wine
  ```

* アドレスに`$`を指定すると、最終行を意味する

  * 例)`3,$`と指定すると、「3行目から最終行まで」を意味する

  => 結果として1、2行目のみが表示される

  > `$`を利用する際はシェルに解釈させないために、シングルクオートで括ることに注意する

  ```bash
  $ sed '3,$d' drink2.txt
  Ber
  Beer
  ```

* アドレスを省略すると、**コマンドは全ての行に作用する**

  * 例)`d`コマンドでアドレスを省略する

  => 全ての行が削除されて結果として何も表示されない

  ```bash
  $ sed d drink2.txt
  ```

* アドレスは、**正規表現で書く** こともできる

  * この際には、正規表現を`/`(スラッシュ)で囲む

  * 例)`/^B/`：「先頭がBで始まる行」をアドレス指定

  ```bash
  $ sed /^B/d drink2.txt
  My Vodka
  My Wine
  ```



## 行を表示する

* `p`：行を表示するコマンド

  * 例)`1p`として1行目を表示する

  ```bash
  $ sed 1p drink2.txt
  Ber
  Ber
  Beer
  BeerBeer
  BeerBeerBeer
  Beeeeeeeeer!!!!
  My Vodka
  My Wine
  ```

  > 予想と異なる結果となった
  >
  > 1行目の「Ber」が2回表示されており、続けて2行目から後の全行がそのまま表示されている
  >
  > これは、`sed`コマンドの「パターンスペースの自動出力」が原因

* `sed`コマンドは行を読み込むと、まず「パターンスペース」という場所に一旦コピーする

  * そのパターンスペースに編集コマンドを実行してから、最後にパターンスペースの内容を出力する

  * 上の例では、1行目の「Ber」は`1p`のスクリプトで表示された行で、2行目の「Ber」はパターンスペースの出力で表示された行

![sedのパターンスペース](./images/sedのパターンスペース.png)

* `-n`オプション：パターンスペースの出力をさせないようにする

  * `p`コマンドを`-n`オプションを同時に利用することで、特定の行だけを表示することができる

  * 例)1行目だけを表示する

  ```bash
  $ sed -n 1p drink2.txt
  Ber
  ```

  * `-n`オプションによりパターンスペースの出力をさせないという手法は、置換機能で「置換が発生した時にだけ出力する」ケースなどに利用される



## 行を置換する

* `s`コマンド：行を置換するコマンド

  * `sed`が利用されるほとんどのケースは **置換を目的** としているため、この`s`コマンドは非常によく使われる

  * `s`コマンドで置換する文字列は、次の形式で指定する

    > フラグは省略可能

  ```bash
  s/置換前文字列/置換後文字列/フラグ
  ```

  * 例)「Beer」という文字列を「Whisky」という文字列に置換する

  => アドレスは省略しているので、全ての行が対象となる

  ```bash
  $ sed 's/Beer/Whisky/' drink2.txt
  Ber
  Whisky
  WhiskyBeer
  WhiskyBeerBeer
  Beeeeeeeeer!!!!
  My Vodka
  My Wine
  ```

  * 上の例では、3行目と4行目に「Beer」が残ってしまっている

    * これは、`s`コマンドでの置換の際には、行頭から探して最初に見つかった文字列だけを置換して、そこで処理を終了するため

* `g`フラグ：見つかった全ての文字列を置換する

  ```bash
  $ sed 's/Beer/Whisky/g' drink2.txt
  Ber
  Whisky
  WhiskyWhisky
  WhiskyWhiskyWhisky
  Beeeeeeeeer!!!!
  My Vodka
  My Wine
  ```

  * 置換前文字列の指定には、正規表現を利用できる

  * 例)`B.*r`：「Bで始まりrで終わる」文字列を、「Whisky」という文字列に置換

  ```bash
  $ sed 's/B.*r/Whisky/g' drink2.txt
  Whisky
  Whisky
  Whisky
  Whisky
  Whisky!!!!
  My Vodka
  My Wine
  ```

  > 置換前文字列には正規表現を使うことが多いため、`s`コマンドを使う際には、常にスクリプト全体をシングルクオートで括っておく

* 置換後文字列を指定せずに空にすることで、空文字に置換する(置換前文字列を削除)ことができる

  * 例)「!」を削除

  ```bash
  $ sed 's/!//g' drink2.txt
  Ber
  Beer
  BeerBeer
  BeerBeerBeer
  Beeeeeeeeer
  My Vodka
  My Wine
  ```

* なお、`-n`オプション(パターンスペースを出力しない)、`p`フラグ(置換が発生した場合に出力)を組み合わせることで、

  => 置換が発生した行だけを表示することができる

  => 長いテキストを置換する場合に、どこで置換が発生するかを確認する時に便利

  ```bash
  $ sed -n 's/!//gp' drink2.txt
  Beeeeeeeeer
  ```



### sedでの拡張正規表現

* `sed`では正規表現は「基本正規表現」として解釈される

* `-r`オプション：拡張正規表現を利用したい場合に用いる



### 後方参照

* `後方参照`：マッチした文字列を置換後に埋め込む

  * 正規表現を`()`でグループ化した際に、そのマッチした文字列を`\1`などの数値で参照できる機能

  * この際、基本正規表現と拡張正規表現では次のように書き方が異なる

| 基本正規表現                      | 拡張正規表現                    |
| --------------------------------- | ------------------------------- |
| `\( \)`でグループ化し、`\1`で参照 | `( )`でグループ化し、`\1`で参照 |

* 複数のグループ化をした場合には、`\1`、`\2`のように行の先頭からの順番に参照できる

  * 例)「My <文字列>」の、<文字列>部分を`\(.*\)`と書いてグループ化する

    * 置換後文字列に後方参照`\1`を使うことで、「--Vodka--」のように、マッチした文字列を利用して置換することができる

  ```bash
  $ sed 's/My \(.*\)/--\1--/' drink2.txt
  Ber
  Beer
  BeerBeer
  BeerBeerBeer
  Beeeeeeeeer!!!!
  --Vodka--
  --Wine--
  ```



### アドレス指定

* `s`コマンドで置換する際には、`d`コマンドや`p`コマンドと同様にアドレス指定できる

  * この場合、置換対象の行がそのアドレスのみに限られる

  * これはファイルの一部のみを置換したい時に便利

  * 例)1行目から3行目までを置換対象として「Beer」を「Whisky」に置換している

  => 4行目は置換対象ではないので、「Beer」トイウ文字列がそのまま残っている

  ```bash
  $ sed '1,3s/Beer/Whisky/g' drink2.txt
  Ber
  Whisky
  WhiskyWhisky
  BeerBeerBeer
  Beeeeeeeeer!!!!
  My Vodka
  My Wine
  ```



### 区切り文字の変更

* `s`コマンドで置換する際に、文字列内で`/`(スラッシュ)という文字そのものを指定したい場合

  * 区切り文字と区別するために`\`を付けてエスケープして`\/`と書く

  * 例)「Beer」を「/Beer/」に置換

  ```bash
  $ sed 's/Beer/\/Beer\//g' drink2.txt
  Ber
  /Beer/
  /Beer//Beer/
  /Beer//Beer//Beer/
  Beeeeeeeeer!!!!
  My Vodka
  My Wine
  ```

* ここまで`s`コマンドの区切り文字には`/`を使ってきたが、`s`の後ろの文字が自動的に区切り文字と見なされるため、どんな文字でも構わない

  * 例)区切り文字を「!」に置換している

  ```bash
  $ sed 's!Beer!/Beer/!g' drink2.txt
  Ber
  /Beer/
  /Beer//Beer/
  /Beer//Beer//Beer/
  Beeeeeeeeer!!!!
  My Vodka
  My Wine
  ```



| 版 |  年/月/日 |
|----|----------|
|初版|2019/04/14|
