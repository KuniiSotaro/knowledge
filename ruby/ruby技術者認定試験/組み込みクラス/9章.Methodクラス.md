9章.Methodクラス
===============

> パーフェクトRuby・9章
>
> 2018/11/02

## Methodオブジェクト

Rubyでは、オブジェクトの持つメソッドも、オブジェクトとして扱うことができる

→`Method`オブジェクト



### Methodオブジェクトの取得

* Methodクラスは、Rubyのオブジェクトが持つメソッドを具象化したもの

* Rubyはオブジェクト指向なので、メソッド呼び出しには常にレシーバとなるオブジェクトが必要になる

  →Methodオブジェクトは、レシーバとなる **オブジェクト** と **メソッド** の中身を保持する

* Methodオブジェクトを作るには、`Object#method`を用いる

```ruby
# Array#shiftをMethodオブジェクトにする
>> array = [1, 2, 3, 4, 5]
=> [1, 2, 3, 4, 5]
>> array_shift = array.method(:shift)
=> #<Method: Array#shift>
```

* 取り出したMethodオブジェクトは、Procオブジェクトと同様に`call`メソッドで実行することができる

* Methodオブジェクトはレシーバを保持しているので、Methodオブジェクトを取り出したオブジェクトにも影響を与える

```ruby
# callによる呼び出し
>> array_shift.call
=> 1
>> array_shift.call
=> 2
>> array
=> [3, 4, 5]
```

* Methodオブジェクトは、クラスとは別にメソッドの処理自体をオブジェクトとして保持するので、

  * オープンクラスでレシーバとなる、オブジェクトのクラスのメソッドがオーバーライドされても、影響を受けない

  * Methodオブジェクトに保持されているレシーバに対して、特異メソッドを使いメソッドのオーバーライドをしても影響を受けない

```ruby
>> class Dog
>>   def bark
>>     puts 'wan!!'
>>   end
>> end
=> :bark

>> dog = Dog.new
=> #<Dog:0x007fc7dd80a2d0>
>> bark_wan = dog.method(:bark)
=> #<Method: Dog#bark>

>> class Dog                 # Methodオブジェクトを取得したメソッドを書き換える
>>   def bark
>>     puts 'bowwow!!'
>>   end
>> end
=> :bark

>> dog.bark                  # dogオブジェクトのbarkメソッドは、書き換えた結果が反映されている
bowwow!!
=> nil
>> bark_wan.call             # Methodオブジェクトの方には、書き換えた影響はない
wan!!
=> nil

>> def dog.bark              # Methodオブジェクトを取得したメソッドを特異メソッドとして書き換える
>>   puts 'kyankyan!!'
>> end
=> :bark

>> dog.bark                  # dogオブジェクトの特異メソッドは、書き換えた結果が反映されている
kyankyan!!
=> nil
>> bark_wan.call             # Methodオブジェクトの方には、書き換えた影響はない
wan!!
=> nil
```



### メソッドに関する引数の情報

Methodオブジェクトは、メソッドを抽象化してオブジェクトとして切り離して扱えるようにするだけでなく、

メソッドの実行に必要な引数に関する情報も取得することができる



#### 引数の数

* `Method#arity`：Methodオブジェクトとなったメソッドを呼び出す際に、指定する必要のある引数の数を返す

  →Procオブジェクトと、同様

```ruby
>> class Arity
>>   def arity_0; end
>>   def arity_1(x); end
>>   def arity_2(x, y); end
>> end
=> :arity_2

>> arity_obj = Arity.new
=> #<Arity:0x007fedcf08c518>
>> arity_obj.method(:arity_0).arity
=> 0
>> arity_obj.method(:arity_1).arity
=> 1
>> arity_obj.method(:arity_2).arity
=> 2
```

* 可長変引数の場合は、負の値が帰ってくる

* 可長変引数をとるが、必須の引数も取る場合は、

  `(必須の引数の個数+1) * -1`

  となる。要するに、

  * 可長変引数しか取らない場合は、`-1`

  * 必須の引数が1つあり、かつ可長変引数をとる場合は`-2`

* デフォルト値をとるメソッドの場合も、可長変引数をとるメソッドの結果と同じ

```ruby
>> class Arity
>>   def arity_variable_length(*x); end
>>   def arity_variable_length_with_default_arg(x, *y); end
>>   def arity_default_val_1(x = 1); end
>>   def arity_default_val_2(x, y = 1); end
>> end
=> :arity_default_val_2

>> arity_obj = Arity.new
=> #<Arity:0x007fdb1185ee10>
>> arity_obj.method(:arity_variable_length).arity                   # 可長変引数が1つある
=> -1
>> arity_obj.method(:arity_variable_length_with_default_arg).arity  # 必須の変数が１つあり、かつ可長変引数あり
=> -2
>> arity_obj.method(:arity_default_val_1).arity                     # 仮引数が１つある
=> -1
>> arity_obj.method(:arity_default_val_2).arity                     # 必須の変数が１つあり、かつ仮引数が１つある
=> -2
```



#### 引数の情報

* `Method#parameters`：Methodオブジェクトが保持しているメソッドがとる引数の情報を、配列で取得することができる

|戻り値の例|               意味              |
|--------|---------------------------------|
| `:req` |             必須の引数            |
| `:opt` |   デフォルト値が指定されている引数   |
| `:rest`| 引数宣言時に`*`が付けられた可長変引数 |
|`:block`|引数宣言時に`&`で指定されたブロック引数|

* 戻り値の結果は、要素数が引数の数と一致する配列

* 結果の配列の要素は、引数1つに対して、引数の種類と定義された時の仮引数の名前がペアとなった配列となる

```ruby
>> class MethodParameter
>>   def arity_0(); end
>>   def arity_1(x); end
>>   def arity1_and_default_val(x = 1); end
>>   def arity1_and_valiable_arg(x, *y); end
>>   def arity1_and_block_arg(x, &y); end
>> end
=> :arity1_and_block_arg

>> method_params = MethodParameter.new
=> #<MethodParameter:0x007f9799070ca0>

>> method_params.method(:arity_0).parameters
=> []
>> method_params.method(:arity_1).parameters
=> [[:req, :x]]
>> method_params.method(:arity1_and_default_val).parameters
=> [[:opt, :x]]
>> method_params.method(:arity1_and_valiable_arg).parameters
=> [[:req, :x], [:rest, :y]]
>> method_params.method(:arity1_and_block_arg).parameters
=> [[:req, :x], [:block, :y]]
```

* `Method#parameters`を利用すると、ハッシュを利用したキーワード引数を取るようなメソッドを作成することも可能



### メソッドの持ち主・名前・レシーバ
