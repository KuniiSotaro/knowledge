2章 Ruby言語仕様
==============

## 2-1.Hello, Ruby

### 2-1-2.メソッド呼び出しとブロック

* メソッド呼び出し

```ruby
レシーバ.メソッド名
```

* ブロック：繰り返しの度に実行される処理。

  * 手続きをひとまとめにしたもので、メソッドを呼び出す際に1つだけ渡すことができる引数の1種

    => このようなメソッドの呼び出しを、「ブロック付きメソッド呼び出し」と呼ぶ

  * ブロックを渡されたメソッドは、受け取ったブロックを任意のタイミングで実行できる

  * `each`メソッド：配列の要素数と同じ回数だけ、ブロックを実行する

  * ブロックの中の`|`で囲まれた変数：ブロックの仮引数

    * ブロックは、実行される際に引数を受け取ることができる

    * `each`メソッドに渡したブロックは、配列の要素を引数として受け取る

```ruby
names.each do |name|
  puts "Hello, #{name.upcase}"
end
```

* ブロックの用途としては、ファイルを読み込んで出力する例もあげられる

```ruby
File.open 'README.md' do |file|
  puts file.read
end
```

* この処理では、以下の動作が行われている

  1. ファイルを開く

  1. ファイルの内容を読み込んで出力する

  1. ファイルを閉じる

* `File.open`はブロックを実行した後で自動的にファイルを閉じるため、ファイルを閉じ忘れることはない

* ファイルの他にも、ロックを伴う処理や、データベースのトランザクション処理など、

  ブロックは処理を抽象化する用途によく用いられる



### 2-1-4.メソッド定義と戻り値

* メソッドの戻り値は、そのメソッドの中で最後に評価された式の値となる

```ruby
>> def add(a, b)
>>   a + b
>> end
=> :add
>> add(1, 1)
=> 2
```

* 処理の途中でメソッドの呼び出し元に処理を戻したい際には、`return`を記述する

  * `return`に値を与えると、それがメソッドの戻り値となる

```ruby
>> def add(a, b)
>>   return a + b
>>   puts 'この文字列は出力されない'
>> end
=> :add
>> add(1, 1)
=> 2
```


## 2-8.様々な代入式

### 2-8-1.多重代入

* 一度に複数の変数や定数の代入を行う際には、左辺と右辺の式をそれぞれ`,`(カンマ)で区切る多重代入で簡潔に記述できる

```ruby
#
# 変数aに1が、変数bに2が代入
#
>> a, b = 1, 2
=> [1, 2]

>> a
=> 1
>> b
=> 2
```

* 右辺には配列を指定することができる

* 右辺の配列の要素数が左辺の式よりも多い場合、余った要素は無視される

```ruby
#
# 配列からの多重代入(右辺で余った`3`は無視される)
#
>> a, b = [1, 2, 3]
=> [1, 2, 3]

>> a
=> 1
>> b
=> 2
```

* 最後の式に`*`をつけることで、余った要素も配列として代入できる

```ruby
#
# `*`のついた`b`には、右辺で余った要素が配列として代入される
#
>> a, *b = [1, 2, 3]
=> [1, 2, 3]

>> a
=> 1
>> b
=> [2, 3]
```

* 左辺の変数に対応する要素が無い場合、その変数にはnilが代入される

```ruby
#
# 対応する要素が無い`c`には、nilが代入される
#
>> c, d, e = [1, 2]
=> [1, 2]

>> c
=> 1
>> d
=> 2
>> e
=> nil
```

* 多重代入は変数の交換する際にもよく用いられる

```ruby
>> a = 'a'
=> "a"
>> b = 'b'
=> "b"

>> a, b = b, a
=> ["b", "a"]

>> a
=> "b"
>> b
=> "a"
```



### 2-8-2.自己代入

* 演算結果を自身に代入し直す、**自己代入** を行う場合には、

  `=`の前に演算子を記述すると簡素に表現できる

```ruby
>> a = 1
=> 1
>> a += 1   # a = a + 1
=> 2

>> b ||= 2  # b = b || 2
=> 2
```



## 2-12.組み込みの変数/定数

### 2-12-1.擬似変数

* Rubyには、擬似変数と呼ばれる参照専用の特殊な変数がある

|     識別子    |                       概要                      |
|:-------------|:-----------------------------------------------|
|`self`        |自身を表す。レシーバ無しでメソッドを呼び出した際のレシーバ|
|`true`        |真。TrueClassの唯一のインスタンス                   |
|`false`       |偽。FalseClassの唯一のインスタンス                  |
|`nil`         |NilClassの唯一のインスタンス                       |
|`__FILE__`    |現在実行中のソースのファイル名                       |
|`__LINE__`    |現在実行中の行番号                                 |
|`__ENCODING__`|現在のソースでのスクリプトエンコーディング             |



### 2-12-2.組み込み変数

* グローバル変数にはいくつか組み込みで用意されているものがある

* 組み込み変数はどこからも参照できるが、実際はもっとスコープが狭く、参照する場所によって異なる値を参照していることもある

* `$stdout`・`$>`：標準出力。初期値はSTDOUT

  => スコープはグローバル

```ruby
>> $stdout
=> #<IO:<STDOUT>>
>> $>
=> #<IO:<STDOUT>>
```

* `$stderr`：標準エラー出力。初期値はSTDERR

  => スコープはグローバル

```ruby
>> $stderr
=> #<IO:<STDERR>>
```

* `$stdin`：標準入力。初期値はSTDIN

  => スコープはグローバル

```ruby
>> $stdin
=> #<IO:<STDIN>>
```

* `$SAFE`：現在のスレッドのセーフレベルを表す整数

  => オブジェクトの汚染レベルのこと

  => スコープはローカル

```ruby
>> $SAFE
=> 0
```

* `$!`：最後に発生した例外オブジェクト

  => スコープはローカル

```ruby
>> $!
=> nil
```

* `$@`：最後に発生した例外のバックトレースを表す配列

  => スコープはローカル

```ruby
>> $@
=> nil
```

* `$$`：実行中のRubyプロセスのブロセスID

  => スコープはローカル

```ruby
>> $$
=> 19898
```

* `$?`：最後に終了した子プロセスの終了ステータス

  => スコープはローカル

```ruby
>> $?
=> nil
```

* `$LOADED_FEATURES`・`$"`：Kernel.#requireによるロード済みファイルの配列

  => スコープはグローバル

```ruby
>> $LOADED_FEATURES
=> ["enumerator.so", "thread.rb", "rational.so", "complex.so", ] # 省略済み
```

* `$~`；最後に成功した正規表現マッチに関する情報(MatchDataオブジェクト)

  => スコープはスレッドローカル

```ruby
>> $~
=> nil
```

* `$1`、`$2`、`$n`...：最後に成功した正規表現マッチでn番目のカッコにマッチした値

  => スコープはスレッドローカル

* `$+`：最後に成功した正規表現マッチで最後のカッコにマッチした値

  => スコープはスレッドローカル

* `$&`：最後に正規表現でマッチした文字列

  => スコープはスレッドローカル

* `$'`：最後に正規表現でマッチしたよりも後ろの文字列

  => スコープはスレッドローカル

* `$(バッククオート)`：最後に正規表現でマッチしたよりも前の文字列

  => スコープはスレッドローカル

※例は、正規表現の章を参考にする

* `$*`：Rubyスクリプトに与えられた引数の配列(ARGVと同じ)

  => スコープはグローバル

```ruby
>> $*
=> []
```

* `$/`・`$-0`：デフォルトの入力の行区切りを表す文字列(デフォルトは`\n`)

  => スコープはグローバル

```ruby
>> $/
=> "\n"
```

* `$;`・`$-F`：String#splitで引数を省略した際の区切り文字

  => スコープはグローバル

```ruby
>> $;
=> nil
```

* `$:`・`$LOAD_PATH`・`$-l`：ライブラリをロードする際の探索パスの配列

  => スコープはグローバル

```ruby
>> $:
=> ["/usr/local/Cellar/rbenv/1.1.1/rbenv.d/exec/gem-rehash", ] # 省略
```

* `$DEBUG`：インタプリタが`-d`オプション付きで起動され、デバックモードであれば真

```ruby
>> $DEBUG
=> false
```

* `$VERBOSE`：冗長メッセージフラグ(nilであれば警告を出力しない。falseであれば重要な警告のみ出力する。trueであれば全ての警告を出力する)

  => スコープはグローバル

```ruby
>> $VERBOSE
=> false
```

* `$PROGRAM_NAME`；実行中のRubyスクリプト名

  => スコープはグローバル

```ruby
>> $PROGRAM_NAME
=> "irb"
```

* `$<`：Rubyスクリプトに与えられた引数または標準入力で構成される仮装ファイル(ARGFと同じ)

  => スコープはグローバル

```ruby
>> $<
=> ARGF
```

* `$FILENAME`：仮装ファイルARGFのファイル名

  => スコープはグローバル

```ruby
>> $FILENAME
=> "-"
```

* `$_`：ARGFからKernel.#getsまたはKernel.#readlineで最後に読み込んだ行

  => スコープはスレッドローカル

```ruby
>> $_
=> nil
```



### 2-12-3.組み込み定数

* `STDIN`：標準出力`$stdin`のデフォルト値

```ruby
>> STDIN
=> #<IO:<STDIN>>
```

* `STDOUT`：標準出力`$stdout`のデフォルト値

```ruby
>> STDOUT
=> #<IO:<STDOUT>>
```

* `STDERR`：標準エラー出力`$stderr`のデフォルト値

```ruby
>> STDERR
=> #<IO:<STDERR>>
```

* `ARGV`：Rubyスクリプトに与えられた引数の配列(`$*`と同じ)

* `ARGF`：Rubyスクリプトに与えられた引数または標準入力で構成される仮想ファイル(`$<`と同じ)

* `ENV`：環境変数

```ruby
>> ENV
=> {"RBENV_VERSION"=>"2.4.1", "TERM_PROGRAM"=>"Apple_Terminal", ] # 省略
```

* `RUBY_ENGINE`：Rubyの処理系を表す文字列

```ruby
>> RUBY_ENGINE
=> "ruby"
```

* `RUBY_COPYRIGHT`：Rubyのコピーライトを表す文字列

```ruby
>> RUBY_COPYRIGHT
=> "ruby - Copyright (C) 1993-2017 Yukihiro Matsumoto"
```

* `RUBY_DESCRIPTION`：`ruby -v`で表される文字列

```ruby
>> RUBY_DESCRIPTION
=> "ruby 2.4.1p111 (2017-03-22 revision 58053) [x86_64-darwin17]"
```

* `RUBY_PATCHLEVEL`：Rubyのパッチレベルを表すIntegerオブジェクト

```ruby
>> RUBY_PATCHLEVEL
=> 111
```

* `RUBY_PLATFORM`：プラットフォームを表す文字列

```ruby
>> RUBY_PLATFORM
=> "x86_64-darwin17"
```

* `RUBY_RELEASE_DATE`：Rubyのリリース日を表す文字列

```ruby
>> RUBY_RELEASE_DATE
=> "2017-03-22"
```

* `RUBY_VERSION`：Rubyのバージョンを表す文字列

```ruby
>> RUBY_VERSION
=> "2.4.1"
```



### 解説

* `STDIN/STDOUT/STDERR`はそれぞれ、`$stdin/$stdout/$stderr`のデフォルト値

  * 組み込み変数の方の標準入出力を別のIOオブジェクトで上書きした後でもう一度初期の値に復元したい場合は、これらの定数を用いる

* `ENV`：ハッシュと同様のインターフェースを持っているオブジェクト

  * 添字に対応する要素が格納されている

  * 値と要素にはそれぞれ文字列だけを指定することができ、それ以外のオブジェクトを指定した場合は、エラーとなる

* `ARGV`：与えられた引数が配列で格納されている

  * 最初の要素は、実行されたファイル名ではなく、最初の引数となる

* `ARGF`：スクリプトに指定されたそれぞれの引数をファイル名と見なして、それらのファイルを連結して1つのファイルのように表現したものが入っている

  * 引数が与えられなければ、標準入力をしたのもが入る

    => これらは、ファイルオブジェクトのように扱うことができる

* `RUBY_`で始まるいくつかの定数は、実行している処理系についての情報を保持している



|  版  |   日付   |
|-----|----------|
| 初版 |2019/01/04|
