01 多クラス
==========

* `分類`、`スコアリング`、`クラス確率推定`について、多クラスでどのように扱うか議論する

  * 多クラスの場合の性能評価をどうするか

  * 2クラスのモデルから多クラスのモデルをどのように構成するか

  > 線形分類などの基本的に2クラス分類を目的としたモデルを考える上で必要不可欠

* ただし、決定木などのモデルは多クラスを扱うことができる



## 1.多クラス

* 多クラスにおける性能評価について考える

* 分類器の性能： $`k \times k`$ 分割表

  * クラスの数： $`k`$

* 分類器の正答率： $`\frac{\sum 分割表の対角成分}{\sum インスタンス数}`$

  * この指標では、クラス間の性能差を評価できない



### 例：多クラス分類器の性能

 例) $`3 \times 3`$ 分割表を考える

|       | 予測1  | 予測2  | 予測3  |     |
| ----- | ------ | ------ | ------ | --- |
| 実際1 | **15** | 2      | 3      | 20  |
| 実際2 | 7      | **15** | 8      | 30  |
| 実際3 | 2      | 3      | **45** | 50  |
|       | 24     | 20     | 56     | 100 |

 * 分類器の正答率： $`\frac{(15+15+15)}{100}=0.75`$

|         | 適合率                 | 再現率                 |
| ------- | ---------------------- | ---------------------- |
| クラス1 | $`\frac{15}{24}=0.63`$ | $`\frac{15}{20}=0.75`$ |
| クラス2 | $`\frac{15}{20}=0.75`$ | $`\frac{15}{30}=0.50`$ |
| クラス3 | $`\frac{45}{56}=0.80`$ | $`\frac{45}{50}=0.90`$ |

こららの平均(重み付き平均)を取ることで、この分類器全体に対する`適合率`と`再現率`をそれぞれ計算できる

* 重み付き平均をとった適合率：$`(0.20 \times 0.63)+(0.30 \times 0.75)+(0.50 \times 0.80)=0.75`$

 > また、重み付き平均をとった再現率は正答率に一致する

例)クラス1とクラス3のペアを考える(クラスのペアごとに適合率と再現率を計算して、別の指標を考える)

|       | 予測1  | 予測3  |     |
| ----- | ------ | ------ | --- |
| 実際1 | **15** | 3      | 18  |
| 実際3 | 2      | **45** | 47  |
|       | 17     | 48     | 65  |

* クラス1を正のクラス

  * 適合率：$`\frac{15}{17}=0.88`$

  * 再現率：$`\frac{15}{18}=0.83`$

* クラス3を正のクラス

  * 適合率：$`\frac{45}{48}=0.94`$

  * 再現率：$`\frac{45}{47}=0.96`$



### 多クラス分類器の構成

> いくつかの2クラス分塁器を組み合わせて、1つの $`k`$ クラス分類器をつくることで対応する

* `1対他分類器`：クラス $`C_1`$ と、それ以外のクラス $`C_2, \cdots, C_k`$ に対する二値分類器

  * 次に、$`C_2`$ と、それ以外のクラス $`C_3, \cdots, C_k`$ に対する二値分類器、といった $`k`$ 個の二値分類器を組み合わせて構成される

  * ただし、$`i`$ 番目の二値分類器を学習する際には、

    * クラス $`C_i`$ 中の全インスタンス：正

    * それ以外のインスタンス：負

> この分類器では、$`C_i`$ と $`C_{i+1}, \cdots, C_k (1\leq <k)`$ に対する二値分類器を $`k-1`$ 個組み合わせるような、学習の順番が決まっているものもある

  ![1対他分類器](./images/01_多クラス/一対他分類器.png)

* `一対一分類器`： $`\frac{k(k-1)}{2}`$ 個のクラスのペアに対して二値分類器を作り、それらを組み合わせて構成される

  * 二値分類器がクラスを非対称に扱う場合は、各ペアに対して2つの分類器を作る(総数： $`k(k-1)`$ )

  > 例)4分類の場合
  >
  > $`\frac{4 \cdot 3}{2!}=6`$
  >
  > ![一対一分類器](./images/01_多クラス/一対一分類器.png)



### 出力符号行列

* `出力符号行列`： $`k`$ クラスの分類問題を $`l`$ 個の二値分類で記述する

  * 要素が`+1`、`0`、`-1`の $`k \times l`$ 行列

  * `+1`：正のクラス、`-1`：負のクラス、`0`：予測なし

* 一対一分類器による、3クラスの分類問題

> **対称の場合**
> $`
> \left(
> \begin{array}{ccc}
>   C_1 \\
>   C_2 \\
>   C_3
> \end{array}
> \right)
> = \underbrace{
>   \left(
>  \begin{array}{ccc}
>    +1 \\
>    -1 \\
>    0
>  \end{array}
> \right)}_{C_1:正, C_2:負}
> \times
> \underbrace{
>  \left(
> \begin{array}{ccc}
>   +1 \\
>   0 \\
>   -1
> \end{array}
> \right)}_{C_1:正, C_3:負}
> \times
> \underbrace{
>  \left(
> \begin{array}{ccc}
>   0 \\
>   +1 \\
>   -1
> \end{array}
> \right)}_{C_2:正, C_3:負} =
> \left(
> \begin{array}{ccc}
>   +1 & +1 &  0 \\
>   -1 &  0 & +1 \\
>    0 & -1 & -1
> \end{array}
> \right)
> `$

> **非対称の場合**
>
> 正と負を交換した3つの分類器が追加
>
> $`
> \left(
> \begin{array}{ccc}
>   C_1 \\
>   C_2 \\
>   C_3
> \end{array}
> \right)
> = \underbrace{
>   \left(
>  \begin{array}{ccc}
>    +1 & -1 \\
>    -1 & +1 \\
>     0 &  0
>  \end{array}
> \right)}_{C_1:正, C_2:負, 正と負を入れ替え}
> \times
> \underbrace{
>  \left(
> \begin{array}{ccc}
>   +1 & -1\\
>    0 &  0\\
>   -1 & +1
> \end{array}
> \right)}_{C_1:正, C_3:負, 正と負を入れ替え}
> \times
> \underbrace{
>  \left(
> \begin{array}{ccc}
>    0 &  0\\
>   +1 & -1\\
>   -1 & +1
> \end{array}
> \right)}_{C_2:正, C_3:負, 正と負を入れ替え} =
> \left(
> \begin{array}{ccc}
>   +1 & -1 & +1 & -1 &  0 &  0 \\
>   -1 & +1 &  0 &  0 & +1 & -1 \\
>    0 &  0 & -1 & +1 & -1 & +1
> \end{array}
> \right)
>`$


* 一対他分類器に対する出力符号行列

> **通常の場合**
>
> $`
> \left(
> \begin{array}{ccc}
>   C_1 \\
>   C_2 \\
>   C_3
> \end{array}
> \right)
> = \underbrace{
>   \left(
>  \begin{array}{ccc}
>    +1 \\
>    -1 \\
>    -1
>  \end{array}
> \right)}_{C_1:正, その他:負}
> \times
> \underbrace{
>  \left(
> \begin{array}{ccc}
>   -1 \\
>   +1 \\
>   -1
> \end{array}
> \right)}_{C_2:正, その他:負}
> \times
> \underbrace{
>  \left(
> \begin{array}{ccc}
>   -1 \\
>   -1 \\
>   +1
> \end{array}
> \right)}_{C_3:正, その他:負} =
> \left(
> \begin{array}{ccc}
>   +1 & -1 & -1 \\
>   -1 & +1 & -1 \\
>   -1 & -1 & +1
> \end{array}
> \right)
> `$

> **順番が決まっている場合**
>
> $`C_1 - C_2 - C_3`$ のように順番を決めている
>
> $`
> \left(
> \begin{array}{ccc}
>   C_1 \\
>   C_2 \\
>   C_3
> \end{array}
> \right)
> = \underbrace{
>   \left(
>  \begin{array}{ccc}
>    +1 \\
>    -1 \\
>    -1
>  \end{array}
> \right)}_{C_1:正, その他:負}
> \times
> \underbrace{
>  \left(
> \begin{array}{ccc}
>    0 \\
>   +1 \\
>   -1
> \end{array}
> \right)}_{C_2:正, C_3:負}
> \times =
> \left(
> \begin{array}{ccc}
>   +1 &  0 \\
>   -1 & +1 \\
>   -1 & -1
> \end{array}
> \right)
> `$

`

### 復号

* 新たなインスタンスが得られた場合

  1. 全ての二値分類器の予測を集める

  1. 正、負、予測棄却を決定する

  1. 予測結果を集めて、`語`を構成する

* `語`は、通常出力符号行列の`行`の中から探す

  > このプロセスを、`復号`と呼ぶ

* 順序なしの一対多分類器において、$`(-1\ +1\ -1)`$ が得られた場合

  * クラス $`C_2`$ に分類される

  ![一対多分類の例](./images/01_多クラス/一対多分類の例.png)

* 対称な一対一分類器において、$`w= (0\ +1\ 0)`$ が得られた場合

  * 最も近しい分類は $`C_1`$ だが、`ハミング距離`を定義する

  > $`d(w,c)=\sum_{i}\frac{1-w_ic_i}{2}`$
  >
  > * $`w_i`$ ：$`i`$ 番目の語
  >
  > * $`c_i`$ ：$`i`$ 番目の符号(分類器)

* `語`と`符号`が分類クラスを同じくしていれば、距離には影響はない

  * 一方が`+1`で他方が`-1`の場合には、距離に`1`の影響を与える

  * どちらかが`0`の場合には、$`\frac{1}{2}`$ の影響を与える

* この距離を用いて、予測クラスは $`\arg \min_j d(w,c_j)`$ で計算される

  * $`c_j`$ ：出力符号行列の第 $`j`$ 行ベクトル

  > $`\left(
  > \begin{array}{ccc}
  >   +1 & +1 &  0 \\
  >   -1 &  0 & +1 \\
  >    0 & -1 & -1
  > \end{array}
  > \right)`$

  > * 第一列：$`(+1\ +1\ 0)`$ 、$`w= (0\ +1\ 0)`$
  >
  > $`d(w,c_1) = \frac{1-0\cdot(+1)}{2} + \frac{1-(+1)\cdot(+1)}{2} + \frac{1-0\cdot0}{2} = 1`$

  > * 第二列：$`(-1\ 0\ +1)`$ 、$`w= (0\ +1\ 0)`$
  >
  > $`d(w,c_2) = \frac{1-0\cdot(-1)}{2} + \frac{1-(+1)\cdot0}{2} + \frac{1-0\cdot(+1)}{2} = 1.5`$

  > * 第三列：$`(0\ -1\ -1)`$ 、$`w= (0\ +1\ 0)`$
  >
  > $`d(w,c_3) = \frac{1-0\cdot0}{2} + \frac{1-(-1)\cdot(-1)}{2} + \frac{1-0\cdot(-1)}{2} = 1.5
  > `$

  * 故に、クラス $`C_1`$ に分類されることがわかる
