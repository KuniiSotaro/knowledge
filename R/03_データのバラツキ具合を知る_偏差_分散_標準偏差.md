03 データのバラツキ具合を知る 偏差 分散 標準偏差
=========================================

* 偏差:「平均-データ」で求めた、データと平均との差

  * 平均より小さな値：マイナス

  * 平均より大きな値:プラス

* 偏差平方:偏差を二乗した値

  * 偏差の平均(分散)を求める時に使う

* 分散($\sigma^2$):「偏差の平方/全てのデータの個数」で求めた値

  * データ全体お散らばり具合を示す

  * 平均値の周りにデータが集まる:小さい値

  * 平均から離れているデータが多い:大きい値



## 1. 全体の散らばり具合を知る

```r
data <- read.table(         # 店舗別売上.txtをデータフレームとしてdataに代入
  "販売台数.txt",
  header=T,                 # 1行目は列名であることを指定
  fileEncoding="CP932"      # 文字コードをShift_JISに指定
)
hist(data$車種A)            # 車種Aのヒストグラムを作成
hist(data$車種B)            # 車種Bのヒストグラムを作成
```

> 車種Aの販売台数がばらついている



### 偏差

* 偏差:全体の中心から見て、そのデータはどの位離れているか

```
偏差 = 対象の値 - 平均
```

* 編纂を求める場合には、データの中心は「平均値」

```r
me_A = mean(data$車種A)     # 車種Aの平均を求める
num_A <- data$車種A         # 車種Aの販売台数をベクトルに代入
dev_A <- num_A - me_A       # 車種Aの偏差を求める
cat("偏差：",dev_A, "\n")   # 出力
```

```r
偏差： -19 -7 -7 20 -22 2 -22 -1 17 17 14 5 8 11 -13 17 5 -13 -22 -13 -1 11 -16 20 8 -4 -4 2 8 -1
```

```r
me_B = mean(data$車種B)     # 車種Bの平均を求める
num_B <- data$車種B         # 車種Bの販売台数をベクトルに代入
dev_B <- num_B - me_B       # 車種Bの偏差を求める
cat("偏差：",dev_B, "\n")   # 出力
```

```r
偏差： 2 -2 0 -4 2 6 0 6 0 -3 2 0 -6 6 -10 0 4 2 -4 2 -6 -2 -2 -6 2 0 0 9 -2 4
```

>　車種A:偏差の絶対値が大きくなっていて、平均値からデータが散らばっている
>
> 車種B:偏差の絶対値は小さく、平均の周りにデータが集まっている



### 偏差平方と分散

* 偏差平方:偏差を二乗したもの。

  * (販売台数-平均値)^2の値が大きい:平均値から離れたデータ

  * (販売台数-平均値)^2の値が小さい:平均値近くのデータ

* 分散($\sigma^2$):偏差平方の平均

  * 全体が平均値の周りに集まっているかどうかを知る

  * 平均値からの離れ具合(偏差平方)を平均した値

$$
\begin{eqnarray}
\sigma^2 = \frac{(x_1 - \bar{x})^2+(x_2 - \bar{x})^2+(x_3 - \bar{x})^2 + \cdots + (x_n - \bar{x})^2}{n}
\end{eqnarray}
$$



### 偏差を基にして分散を求める

```r
# 車種Aの分散を求める
dspr_A <- sum(dev_A^2) / length(data$車種A)
cat("分散：", dspr_A, "\n")
# 車種Bの分散を求める
dspr_B <- sum(dev_B^2) / length(data$車種A)
cat("分散：", dspr_B, "\n")
```

```r
分散： 168.8
分散： 17
```

> 車種Aの販売台数の散らばり具合は大きい
>
> 車種Bの販売台数は平均値の周りに集まっている



## 2. 標準偏差

* 標準偏差:平均値からの離れ具合(偏差平方)を平均した値(分散)の平方根

  * 単位を元のデータと揃える

  * あるデータが平均値からどのくらい離れているかを測る尺度

$$
\begin{eqnarray}
\sigma = \sqrt{\sigma^2}
\end{eqnarray}
$$

* 標準化:特定のデータの偏差が標準偏差の何個分かを求める

$$
\begin{eqnarray}
標準化 = \frac{x - \mu}{\sigma}
\end{eqnarray}
$$



### 1. 偏差の値の単位を元のデータの単位に換算して「標準偏差」を求める

* 分散の問題:

  * 値が大きくなりすぎている

  * 単位が「もとの単位^2」になっている

* 標準偏差:平均値からの離れ具合(偏差平方)を平均した値(分散)の平方根

  * 単位を元のデータと揃えた値

  $$
  \begin{eqnarray}
  \sigma = \sqrt{\sigma^2}
  \end{eqnarray}
  $$

* `sqrt()`関数:引数に指定した値の平方根を返す

* `var()`関数:不偏分散($u^2$)を求める

  * 不偏分散:「データの個数-1」

  * ここでは自作した関数を用いる

```r
getDisper <- function(x) {       # 分散を返す関数
  dev <- x - mean(x)             # 偏差を求める
  return(sum(dev^2) / length(x)) # 分散を返す
}

data <- read.table(           # 店舗別売上.txtをdataに代入
  "販売台数.txt",
  header=T,                   # 1行目は列名であることを指定
  fileEncoding="CP932"        # 文字コードをShift_JISに指定
)

num_A  <- data$車種A          # 車種Aのデータをベクトルに代入
dspr_A <- getDisper(num_A)    # 車種Aの分散を求める
sd_A   <- sqrt(dspr_A)        # 車種Aの標準偏差を求める
cat("標準偏差：", sd_A, "\n") # 出力

num_B  <- data$車種B          # 車種Bのデータをベクトルに代入
dspr_B <- getDisper(num_B)    # 車種Bの分散を求める
sd_B   <- sqrt(dspr_B)        # 車種Bの標準偏差を求める
cat("標準偏差：", sd_B, "\n") # 出力
```

```r
標準偏差： 12.99231
標準偏差： 4.123106
```

* 標準偏差は、「平均値からの離れ具合を測るものさし」として使うことができる

* `sd()`関数:不偏分散をもとにして、標準偏差の推定値を求める

  * 今回は標準偏差を求める関数も自作する

  $$
  \begin{eqnarray}
  \sigma^2 = \sqrt{\frac{(x_1 - \bar{x})^2+(x_2 - \bar{x})^2+(x_3 - \bar{x})^2 + \cdots + (x_n - \bar{x})^2}{n}}
  \end{eqnarray}
  $$

```r
getSd <- function(x) {                  # 標準偏差を返す関数
  return(                               # 戻り値を返す
    sqrt(                               # 分散の平方根
      sum((x - mean(x))^2) / length(x)) # 分散の計算式
    )
}

data <- read.table(           # 店舗別売上.txtをdataに代入
  "販売台数.txt",
  header=T,                   # 1行目は列名であることを指定
  fileEncoding="CP932"        # 文字コードをShift_JISに指定
)

num_A <- data$車種A           # 車種Aのデータをベクトルに代入
sd_A <- getSd(num_A)          # 車種Aの標準偏差を求める
cat("標準偏差：", sd_A, "\n") # 出力

num_B <- data$車種B           # 車種Bのデータをベクトルに代入
sd_B <- getSd(num_B)          # 車種Bの標準偏差を求める
cat("標準偏差：", sd_B, "\n") # 出力
```

```r
標準偏差： 12.99231
標準偏差： 4.123106
```



### 2. データを標準化した数値で表す

* 標準化:特定のデータの偏差が標準偏差の何個分かを求める

  * 特定のデータから平均値を引いて偏差を求め、それを標準偏差で割る

  * 標準偏差を`1`とした割合がわかる

  * 平均から標準偏差何個分離れているかを知ることが出来る

```r
getSd <- function(x) {                  # 標準偏差を返す関数
  return(                               # 戻り値を返す
    sqrt(                               # 分散の平方根
      sum((x - mean(x))^2) / length(x)) # 分散の計算式
  )
}

data <- read.table(           # 店舗別売上.txtをdataに代入
  "販売台数.txt",
  header=T,                   # 1行目は列名であることを指定
  fileEncoding="CP932"        # 文字コードをShift_JISに指定
)

num_A  <- data$車種A          # 車種Aのデータをベクトルに代入
mean_A <- mean(num_A)         # 車種Aの平均を求める
sd_A   <- getSd(num_A)        # 車種Aの標準偏差を求める
std_A  <-
  (num_A - mean_A) / sd_A     # 標準化(データ-平均)÷標準偏差)
print(std_A)                  # 出力

num_B  <- data$車種B          # 車種Bのデータをベクトルに代入
mean_B <- mean(num_B)         # 車種Bの平均を求める
sd_B   <- getSd(num_B)        # 車種Bの標準偏差を求める
std_B  <-
  (num_B - mean_B) / sd_A     # 標準化(データ-平均)÷標準偏差)
print(std_B)                  # 出力
```

```r
[1] -1.46240405 -0.53878044 -0.53878044  1.53937268 -1.69330995  0.15393727
 [7] -1.69330995 -0.07696863  1.30846678  1.30846678  1.07756088  0.38484317
[13]  0.61574907  0.84665497 -1.00059224  1.30846678  0.38484317 -1.00059224
[19] -1.69330995 -1.00059224 -0.07696863  0.84665497 -1.23149814  1.53937268
[25]  0.61574907 -0.30787454 -0.30787454  0.15393727  0.61574907 -0.07696863
 [1]  0.1539373 -0.1539373  0.0000000 -0.3078745  0.1539373  0.4618118
 [7]  0.0000000  0.4618118  0.0000000 -0.2309059  0.1539373  0.0000000
[13] -0.4618118  0.4618118 -0.7696863  0.0000000  0.3078745  0.1539373
[19] -0.3078745  0.1539373 -0.4618118 -0.1539373 -0.1539373 -0.4618118
[25]  0.1539373  0.0000000  0.0000000  0.6927177 -0.1539373  0.3078745
```

* 「95台」という値を車種Aと車種Bでそれぞれ標準化する

```r
> (95 - mean_A) / sd_A
[1] 1.924216
> (95 - mean_B) / sd_B
[1] 3.638034
```

> 車種Bにおける95台という数字は、車種Aよりもおよそ2倍も離れている、なかなか達成できない売上の数値

* 標準化した値の平均は「0」、標準偏差は「1」となる



## 3. 標準偏差を用いて、データが平均からどのくらい離れているかを知る

### 1. 標準偏差を「尺度」にする

* データの中心の傾向:「平均値+標準偏差」と「平均値-標準偏差」の範囲に、データ全体の68%が含まれる

> 来客数の標準偏差と標準化係数を求める

* `cbind()`関数:2つのデータフレームを並べた状態で結合する

  * 第一引数:指定したデータフレームの右側の列

  * 第二引数:指定したデータフレームの列が結合

```r
cbind(結合されるデータフレーム, 結合するデータフレーム)
```

```r
getSd <- function(x) {                  # 標準偏差を返す関数
  return(                               # 戻り値を返す
    sqrt(                               # 分散の平方根
      sum((x - mean(x))^2) / length(x)) # 分散の計算式
  )
}

data <- read.table(       # 来店者数.txtをdataに代入
  "来店者数.txt",
  header=T,               # 1行目は列名であることを指定
  fileEncoding="CP932"    # 文字コードをShift_JISに指定
)

num  <- data$来店者数     # 来店者数のデータをベクトルに代入
sd   <- getSd(num)        # 来店者数の標準偏差を求める
mean <- mean(num)         # 来店者数の平均
# 標準化係数をデータフレームにバインド
new_frm <- cbind(
              # もとのデータフレーム
              data,
              # 標準化係数のデータフレーム
              data.frame(
                # 標準化の計算
                (num - mean) / sd
              )
           )
```

```r
> num
 [1] 46 57 61 67 56 74 41 43 64 54 46 51 64 31 42 57 56 68 43 59 48 61 43 48 51
[26] 62 69 49 58 42
> sd
[1] 10.01382
> mean
[1] 53.7
```

* ここで、平均値を`54`、標準偏差を`10`とする

  * 30日間の68%の期間は約20日間なので、この間は44人〜64人の間で遷移する



### 2. 標準偏差±1個分の範囲内であれば、平凡なデータ

統計を行う際には、以下の判断が行われる

> * データの偏差が標準偏差の±1個の範囲内に収まっていれば、平凡なデータである
>
> * データの偏差が標準偏差の±2個の範囲を超えていれば、そのデータは特殊なデータである

* 標準偏差±1個分の範囲内に、全体の68%のデータが存在することが確率的に証明されている

* 標準偏差±2個分範囲内に、全体の96%のデータが存在することが確率的に証明されている



#### 標準化係数で、データの特殊性を見る

| 範囲                 | 内容                                       |
| -------------------- | ------------------------------------------ |
| ±1以内               | 全体の約68%に含まれる平凡な値              |
| +1 < 標準化係数 < 2  | 全体の14%((96%-68%)/2)に含まれる値         |
| -1 > 標準化係数 > -2 | 全体の14%((96%-68%)/2)に含まれる値         |
| +2 < 標準化係数      | 全体の約2%((100%-96%)/2)に含まれる特殊な値 |
| -2 > 標準化係数      | 全体の約2%((100%-96%)/2)に含まれる特殊な値 |

```r
> new_frm
   日 来店者数 X.num...mean..sd
1   1       46      -0.76893704
2   2       57       0.32954445
3   3       61       0.72899226
4   4       67       1.32816398
5   5       56       0.22968249
6   6       74       2.02719765
7   7       41      -1.26824680

8   8       43      -1.06852290
9   9       64       1.02857812
10 10       54       0.02995859
11 11       46      -0.76893704
12 12       51      -0.26962727
13 13       64       1.02857812
14 14       31      -2.26686633
15 15       42      -1.16838485
16 16       57       0.32954445
17 17       56       0.22968249
18 18       68       1.42802593
19 19       43      -1.06852290
20 20       59       0.52926835
21 21       48      -0.56921313
22 22       61       0.72899226
23 23       43      -1.06852290
24 24       48      -0.56921313
25 25       51      -0.26962727
26 26       62       0.82885421
27 27       69       1.52788788
28 28       49      -0.46935118
29 29       58       0.42940640
30 30       42      -1.16838485
```



#### 標準化した値の平均値は0で標準偏差は1となる

* 標準正規分布:平均値が`0`、標準偏差が`1`となるデータの分布体型

  * どのようなデータでも、標準化するすると同じ形の相対度数の分布グラフになる

> **標準化の法則**
>
> データを$X$とする
>
> データを全て$\frac{X-\mu}{\sigma}$にすると、平均が`0`、標準偏差が`1`となる

* 全てのデータを標準化することで、平均の`0`を中心として標準偏差`±1`分のようにデータを見ることができる



## 4. 来店者の数が上位5%に入る日を調べる

### 1. 標準正規分布のグラフ

* 標準正規分布:平均値が`0`、標準偏差が`1`になるデータの分布

  * 横軸:データの大きさ(標準偏差)

  * 縦軸:データの数(度数)を、データが存在する確率に置き換える

```r
curve(dnorm(x, mean=0, sd=1), from=-4, to=4)
```

* `curve()`関数:`x`を含んだ関数式のグラフを`from`から`to`までの区間だけを表示する

```r
cirve(xを含んだ関数式, from=左端の値, to=右端の値)
```

* `dnorm()`関数:平均`m`、標準偏差`n`の正規分布における確率密度関数を求める

```r
dnorm(x, mean=n, sd=n)
```

| 引数 | 内容     |
| ---- | -------- |
| `x`  | 確率変数 |
| `n`  | 平均     |
| `m`  | 標準偏差 |



#### 確率密度関数

$$
\begin{eqnarray}
f(x) = \frac{1}{\sqrt{2\pi}}e^{- \frac{1}{2}x^2}
\end{eqnarray}
$$

* $x$の値を定めると、グラフの高さ$f(x)$が定まる。よってグラフの形がきっちりと決まっている

* 左右対称で、$x=0$のところで$f(x)$の値が最大になる

* $x=1$、$x=-1$のところで曲がり方が変わる

* $x=-1$よりも左では、「左曲がり」

* $x=-1$から$x=1$までは、「右曲がり」

* $x=1$よりも右では、「左曲がり」

* 相対度数分布のグラフなので、曲線内部の面積は`1`となる

* グラフの両端はどこまで行っても横軸とは交わらない

  * ただし、面積はちょうど`1`になる



### 2. 標準正規分布のグラフで区切られた領域がデータの出現率を表す

* 実際のデータは、$-\infty$から $+\infty$までの全ての値に対応しなければならない

* 階級に収まるデータ数の割合を示す値を使うことで、データそのものが存在する確率を示す



#### 区間面積の求め方

* 標準正規分布のグラフの高さ$f(x)$を求める式は、標準正規分布の横軸(標準偏差)が$x$のときの高さを求める

  * ここでは、台形の面積を求めて近似する

`0`から`0.01`刻みで求めた区間面積と累計面積の表を作成する

```r
# 0～2を0.01刻みにしたシーケンスを生成
n <- seq(0, 2, by = 0.01)
# 標準正規分布の確率密度関数で確率を求める
dn <- dnorm(n, mean=0, sd=1)

# 区間面積用の数値ベクトルを作る
s_area <- as.numeric(NULL)
# 累積面積用の数値ベクトルを作る
t_area <- as.numeric(NULL)

# 区間面積と累計面積を計算
i <- 0                             # カウンター変数
for (value in n){                  # nの要素のぶんだけ繰り返す
  if(value == 0){                  # nが0であれば実行
    s_area <- 0                    # 区間面積を0とする
    t_area <- 0                    # 累計面積を0とする
    i <- i + 1                     # カウンターの値を1増やす
  } else {                         # nの要素が0以外の場合の処理
    # 区間面積のベクトルに区間面積を追加
    s_area <- c(
      s_area,                      # 代入先のベクトル
      (dn[i] + dn[i+1]) * 0.01 / 2 # 区間面積を台形の面積で近似
      )
    # 累計面積のベクトルに累計面積を追加
    t_area <- c(
      t_area,                      # 代入先のベクトル
      t_area[i] + s_area[i+1]      # 累計の面積を計算
      )
    i <- i + 1                     # カウンターの値を1増やす
  }
}
# 標準正規分布の数表を作成
dframe <- data.frame(
  x_value      = n,                # 0～2までの連続値
  section_area = s_area,           # 区間面積
  total_area   = t_area            # 累計面積
  )
```



#### 作成した図表をファイルに出力する

* `write.table()`関数:引数に指定したオブジェクトをファイルに書き出す

  * データフレームでなければ、強制的にデータフレームに変換した後ファイルに書き出す

  * 各行の項目は`sep`の値で切り分けられる

```r
write.table(
            x,
            file = "",
            append = FALSE,
            uote = TRUE,
            sep = " ",
            eol = "\n",
            na = "NA",
            dec = ".",
            row.names = TRUE,
            col.names = TRUE,
            qmethod = c("escape", "double")
)
```

| 引数        | 内容                                                                               |
| ----------- | ---------------------------------------------------------------------------------- |
| `x`         | 書き出されるオブジェクト(データフレーム)                                           |
| `file`      | データを書き出すファイル名                                                         |
| `append`    | `TRUE`を指定すると、既存のファイルが存在する場合には、ファイルの内容に追加される。 |
|             | `FALSE`を指定すると上書きモードとなる。                                            |
|             | デフォルトは`FALSE`                                                                |
| `quote`     | `TRUE`を指定すると、列名がダブルクオートで囲まれる。                               |
|             | `FALSE`を指定すると、ダブルクオートで囲まれない。                                  |
|             | デフォルトでは`FALSE`                                                              |
| `sep`       | 区切り文字を指定する                                                               |
| `eol`       | 各行の最後に出力される文字を指定。デフォルトは`\n`(改行)                           |
| `na`        | データ中の欠損値に使われる文字列を指定。デフォルトは`NA`                           |
| `dec`       | 小数点に使われる文字を指定。デフォルトは`.`                                        |
| `row.names` | `TRUE`を指定すると、データフレームの行名を書き込む。                               |
|             | `FALSE`を指定すると、書き込みを行わない                                            |
|             | デフォルトでは`FALSE`                                                              |
| `col.names` | `TRUE`を指定すると、データフレームの列名を書き込む。                               |
|             | `FALSE`を指定すると、書き込みを行わない。                                          |
|             | デフォルトでは`TRUE`                                                               |


```r
write.table(dframe, file="std_distribution.txt", sep="\t", row.names=FALSE)
```



## 3. 上位5%に入る来店者数を見つける

* 上位5%となる、面積`0.95`の領域を探す

  * 左半分の面積`0.5`を引いた`0.45`を面積として考える

```r
165    1.64 0.0010481796 0.449495996
166    1.65 0.0010311301 0.450527126
```

* 標準偏差$+1.645\sigma$分の位置を上位5%の面積の区切りとする

  * 来店者数の標準偏差`10`を用いて、「$10 \times 1.645=16.45$」とすれば、「平均54+16.45=70.45」となる

  * 71人以上の来客があれば、上位5%に入る



#### qnorm()関数で、上位5%に入る来客者数を一発で見つける

```r
> qnorm(0.95, mean=53.7, sd=10.01382)
[1] 70.1712
```



| version | update     |
| ------- | ---------- |
| 1st     | 2020/04/05 |
