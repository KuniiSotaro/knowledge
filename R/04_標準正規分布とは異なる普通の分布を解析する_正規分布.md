04 標準正規分布とは異なる普通の分布を解析する 正規分布
==============================================

## 1. 一般正規分布

* 一般正規分布:「$\mu=0$」、「$\sigma=1$」の標準正規分布とは異なる平均値、標準偏差を持つ分布

* 変数変換 :標準偏差($\sigma=1$)に対する割合を求める

    > データから平均を引くことで、正規分布の平均は$0$となる。
    >
    > $\frac{1}{\sigma}$ より、$\sigma$ を標準正規分布の $\sigma=1$ に対する値を求める

  * $z$:標準正規分布の $\sigma$ の位置

  * $X$:正規分布のデータ

$$
\begin{eqnarray}
z = \frac{X-\mu}{\sigma}
\end{eqnarray}
$$

  > 正規分布のデータ $X$ を、標準正規分布の $\sigma$ に換算した値がわかる

* 確率密度関数:正規分布の $x$ を求める関数 $f(x)$

$$
\begin{eqnarray}
f(x) = \frac{1}{\sigma \sqrt{2 \pi}}e^{-\frac{1}{2}\bigr( \frac{x-\mu}{\sigma} \bigl)^2}
\end{eqnarray}
$$

  1. 「グラフの山の頂点は0、正の領域と負の領域で対称」として、平均値を平行移動

  2. 「グラフの山の正の領域と負の領域で対称」になるので、$x^2$で考える

  3. 山の頂点から端へ行くほどゼロに近づく(指数関数で山の傾斜を表す)

$$
\begin{eqnarray}
e^{-(x-\mu)^2}
\end{eqnarray}
$$

  4. 「正規分布から計算された平均と分散」と「この$f(x)$から計算された平均と分散」が一致するようにする

$$
\begin{eqnarray}
s^2 = \frac{1}{2 \sigma^2} \\
e^{-\frac{1}{2}\bigr( \frac{x - \mu}{\sigma} \bigl)^2}
\end{eqnarray}
$$

  5. グラフの面積が「1」になるように、$\sigma \sqrt{2 \pi}$ で割る



### 売上が40万以上になる確率を求める

* `pnorm()`関数:指定した平均と標準偏差に対する確率密度関数 $f(x)$ の累計確率を求める

```r
pnorm(
  q,
  mean = 0,
  sd = 1,
  lower.tail = TRUE,
  log.p = FALSE
)
```

| 引数         | 説明                     |
| ------------ | ------------------------ |
| `q`          | 累積確率を求めるベクトル |
| `mean`       | 平均                     |
| `sd`         | 標準偏差                 |
| `lower_tail` | `TRUE`で確率を求める     |
| `log.p`      | `FALSE`で確率を求める    |

    > 任意の正規分布において、`x`までの区間を積分区間として面積を求める

  * 最初の引数`x`:正規分布する任意のデータ

  * 2つ目の引数:正規分布の平均値

  * 3つ目の引数:標準偏差

```r
getSd <- function(x) {                  # 標本分散をもとに標準偏差を返す関数
  return(                               # 標準偏差を返す
    sqrt(                               # 分散の平方根
      sum((x - mean(x))^2) / length(x)) # 分散の計算式
  )
}

data <- read.table(                     # 売上状況.txtをdataに代入
  "売上状況.txt",
  header=T,                             # 1行目は列名であることを指定
  fileEncoding="CP932"                  # 文字コードをShift_JISに指定
)
# 必要なデータを用意
num <- data$売上額                      # 売上額のデータをベクトルに代入
sdv <- getSd(num)                       # 売上額の標準偏差を求める
seq <- seq(30, 60, by=5)                # 10～100までの5刻みのシーケンスを生成

# 累積確率を求める
cmp <- pnorm(
  seq,                                  # 累積確率を求めるデータ
  mean       = mean(data$売上額),       # 来店者数の平均
  sd         = sdv,                     # 来店者数の標準偏差
  lower.tail = TRUE                     # 累積確率を求める
  )

# 5万円刻みの売上額と累積確率のデータフレームを作成
cp_frm <- data.frame(
  "売上額"=seq,
  "累積確率"=cmp
  )
```

```r
> cp_frm
  売上額  累積確率
1     30 0.2468548
2     35 0.3940493
3     40 0.5583785
4     45 0.7131121
5     50 0.8359974
6     55 0.9183079
7     60 0.9648071
```

* 40万円をクリアできる確率は、確率全体の1から40万円に対する累積確率を引くことで求める

```r
> how = 1 - cp_frm[3,2]
> how
[1] 0.4416215
```



## 2. 偏差値の仕組み

* 偏差値:全員の平均点と標準偏差を基に、各人の得点を標準化した後、10倍して50を足したもの

  * 最後に`50`を足すことで、偏差値の値をマイナスにすることを防ぐ

$$
\begin{eqnarray}
偏差値 = \frac{X - \mu}{\sigma} \times 10 + 50
\end{eqnarray}
$$

```r
getSd <- function(x) {                  # 標準偏差を返す関数
  return(                               # 戻り値を返す
    sqrt(                               # 分散の平方根
      sum((x - mean(x))^2) / length(x)) # 分散の計算式
  )
}

data <- read.table(           # テスト結果.txtをdataに代入
  "テスト結果.txt",
  header=T,                   # 1行目は列名であることを指定
  fileEncoding="CP932"        # 文字コードをShift_JISに指定
)

num <- data$得点              # テスト結果の得点をベクトルに代入
sdv <- getSd(num)             # 得点の標準偏差を求める
men <- mean(num)              # 得点の平均
dev <-
  (data$得点-men) / sdv*10+50 # 全員の偏差値を求める

data <- cbind(                # 偏差値を追加したデータフレームを生成
  data,                       # もとのデータフレーム
  data.frame("偏差値" = dev)  # 偏差値のデータフレーム

  )
```

```r
> data
   得点   偏差値
1    87 63.08467
2    87 63.08467
3    84 60.77561
4    75 53.84843
5    78 56.15749
6    81 58.46655
7    51 35.37596
8    63 44.61220
9    63 44.61220

10   90 65.39373
11   48 33.06690
12   72 51.53937
13   48 33.06690
14   69 49.23031
15   57 39.99408
16   87 63.08467
17   54 37.68502
18   90 65.39373
19   78 56.15749
20   66 46.92125
21   66 46.92125
22   72 51.53937
23   78 56.15749
24   75 53.84843
25   57 39.99408
26   48 33.06690
27   57 39.99408
28   69 49.23031
29   81 58.46655
30   69 49.23031
```



### 標準偏差を用いた合格判定の仕組み

**平均が60点、標準偏差は10点の時、80点取ったら合格できる？**

* 定員:10名

* 受験人数:100名

80点は、平均点 $\mu$ を基準にすると「+20点」なので、標準偏差を用いて「$+2\sigma$」

> 上位約2.28%に含まれるので、定員が10名であれば十分に合格圏内

```r
> 1 - pnorm(80, mean=60, sd=10)
[1] 0.02275013
```



## 3. バラバラに分布するデータを正規分布に近似する(大数の法則)

> 省略



## 4. 正規分布の再生性

### 1. 正規分布の再生性

* 標準正規分布:平均 $\mu=0$ 、標準偏差 $\sigma = 1$ の分布

$$
\begin{eqnarray}
\mathcal{N}(0, 1^2)
\end{eqnarray}
$$

* 一般の正規分布:平均 $\mu$ 、標準偏差 $\sigma$ の分布

$$
\begin{eqnarray}
\mathcal{N}(\mu, \sigma^2)
\end{eqnarray}
$$

* 正規分布の再生性:正規分布を2つに重ね合わせても、分布の形が保存される

  * $X$:正規分布 $\mathcal{N}(\mu_1, \sigma_1^2)$

  * $Y$:正規分布 $\mathcal{N}(\mu_2, \sigma_2^2)$

$$
\begin{eqnarray}
\mathcal{N}(\mu_1+\mu_2,\sigma_1^2+\sigma_2^2)
\end{eqnarray}
$$



#### 2つのテストの平均と標準偏差を基に50位の人の合計得点を推計する

例題の点数

* 変量$X$:英語の点数

* 変量$Y$:数学の点数

英語と数学の合計点を表す変量 $X+Y$ は、

$$
\begin{eqnarray}
\mathcal{N}(45+65, 6^2+8^2) = \mathcal{N}(110, 10^2)
\end{eqnarray}
$$

* `qnorm()`関数:面積(累計確率)を指定すると、面積の区切りとなる $\sigma$ の割合を求める

```r
qnorm(
  q,
  mean = 0,
  sd = 1,
  lower.tail = TRUE,
  log.p = FALSE
)
```

| 引数         | 説明                                                                       |
| ------------ | -------------------------------------------------------------------------- |
| `q`          | 確率を求める面積                                                           |
| `mean`       | 平均                                                                       |
| `sd`         | 標準偏差                                                                   |
| `lower.tail` | `TRUE`(デフォルト)であれば、下側の確率を求める                             |
| `log.p`      | `FALSE`(デフォルト)ではなく`TRUE`であれば、確率`P`は対数値`log(P)`とされる |

```r
> qnorm(0.5+0.45, mean=0, sd=1)
[1] 1.644854
```

そうすると、 $\mathcal{N}(110, 10^2)$ の $\sigma^2$ は平均からの右半分($\sigma$)となる

```r
> 110 + (10 * 1.64)
[1] 126.4
```

よって、50位の人の英語と数学の合計点は、126点位であると考えられる



## 5. 点推定

### 1. 母集団と標本

* 全数調査:母集団全てについて調査すること

* 標本調査:調査対象の一部のデータを用いて分析を行うこと

| 用語                         | 内容                                 |
| ---------------------------- | ------------------------------------ |
| 母集団                       | 調査の対象となる全てのデータ         |
| サンプリング(抽出)           | 母集団から一部のデータを抽出すること |
| サンプル(標本)               | 抽出したデータ                       |
| サンプルサイズ(標本の大きさ) | 標本の数                             |



#### 推定を行うために必要な情報

* 推定:母集団の平均、分散、比率などの指標となる値を予想する

  * 母集団の分布と標本の分布の関係がわかっていることが前提

| 用語                            | 内容                     |
| ------------------------------- | ------------------------ |
| 母平均($\mu$)                   | 母集団の平均             |
| 母分散($\sigma^2$)              | 母集団の分散             |
| 母標準偏差($\sigma$)            | 母集団の標準偏差         |
| 標本平均($\bar{x}$)             | 標本の平均               |
| 標本分散($S^2$)                 | 標本の分散               |
| 標本標準偏差($S$)               | 標本の標準偏差           |
| 不偏分散($u^2$)                 | 標本の不偏分散           |
| 不偏分散から求めた標準偏差($u$) | 母集団の$\sigma$の推定値 |

> 「母集団の相対度数分布グラフとそこから取り出したサンプル($X$)の相対度数分布グラフは同じ」



### 2. ピンポイントで推定する

* 推定には、以下の推定法がある

  * 点推定:母集団が持つ性質をピンポイントで言い当てる

  * 区間推定:母集団の性質を大まかに言い当てる



#### 最尤法による推定

* 最尤法:母分散の推定に標本分散($s^2$)をそのまま用いる点推定

```r
getDisper <- function(x) {                # 分散を返す関数
  dev <- x - mean(x)                      # 偏差を求める
  return(sum(dev^2) / length(x))          # 分散を返す
}

test <- c(                                # テスト結果
  75, 68, 96, 76, 84, 74, 64,	94,	77,	82,
  86,	56,	82,	69,	59,	81,	61,	85,	64,	63,
  68,	79,	61,	57,	63,	89,	74,	63,	71,	69,
  95,	84,	76
  )

m1 <- mean(test[1:5])                     # 平均
d1 <- getDisper(test[1:5])                # 分散
```

標本平均と標本分散を、そのまま母平均と母分散として推定

```r
> m1
[1] 79.8
> d1
[1] 91.36
```



#### 不偏推定量による推定

* 不偏分散:標本分散の平均と母分散(一般的に、標本分散の平均は母集団よりも小さな値)のずれを考慮した分散

$$
\begin{eqnarray}
u^2 = \frac{(x_1 - \bar{x})^2 + \cdots + (x_n - \bar{x})^2}{n - 1}
\end{eqnarray}
$$

* `var()`関数:不偏分散を求める

```r
> d2 <- var(test[1:5])                      # 不偏分散
> d2
[1] 114.2
```

不偏推定量($\hat{\sigma}^2$)による推定では、母平均は79.8で変わらず、母分散は不偏分散($u^2$)を用いることで、114.2と推定する



#### 点推定の結果を見る

|                     | 最尤法による推定    | 不偏推定量による推定 |
| ------------------- | ------------------- | -------------------- |
| 母平均($\mu$)の推定 | 標本平均($\bar{x}$) | 標本平均($\bar{x}$)  |
| 母分散($\sigma^2$)  | 標本分散($s^2$)     | 不偏分散($u^2$)      |

> 今回の点推定の結果

```txt
母平均 74
母分散 124

最尤法による点推定
母平均 79.8
母分散 91.36

不偏推定量による点推定
母平均 79.8
母分散 114.2
```

全てのデータが揃っている場合には「最尤法」、母集団の一部のデータでは「不変推定量」を用いる



## 6. サイコロを振ると1の目が出る確率は？

* 試行:何度でも繰り返すことが出来て、なおかつその結果が偶然に左右される行為

* 標本空間:ある試行を行った際に起こりうる全ての結果を集めた集合

* 事象:標本空間の部分集合のこと



### 1. 確率変数とその定義

**確率の定義**

ある試行の標本空間($\cup$)を

$$
\begin{eqnarray}
\cup = \{e_1, e_2, \cdots, e_n \}
\end{eqnarray}
$$

とし、標本空間の要素の数を $n$ 、事象 $E$ に含まれる要素の数を $m$ とした時、

$$
\begin{eqnarray}
P(E) = \frac{m}{n}
\end{eqnarray}
$$

を「事象 $E$ の確率」という



#### 離散型一様分布と確率質量関数

* 一様分布:確率を求める関数が常に一定の値を与える確率分布

* 離散型一様分布:確率変数($X$)が「離散確率変数」である分布

  * サイコロの目のように「離散型」の確率変数を求める関数は常に $\frac{1}{n}$ のあチアを与えるので、一様分布となる

* 確率質量関数:確率変数 $X$ が離散的な値を取る離散確率変数である時の確率を与える関数 $f(x)$



#### 連続分布と確率密度関数

* 確率密度:確率が滑らかな曲線で描かれた、曲線と横軸で囲まれた面積(累積確率)

* 確率密度関数:正規分布の確率を求める関数 $f(x)$



#### Rで離散型一様分布を確認する

* `runif()`関数:離散型一様分布の乱数を発生する

```r
runif(n, min, max)
```

| 引数  | 内容                   |
| ----- | ---------------------- |
| `n`   | 試行の回数             |
| `min` | 出力する乱数の最小値   |
| `max` | 出力する乱数の最大値 |

```r
temp<-floor(
  runif(5000000,# 試行回数
        1,      # 出力する乱数の最小値
        7       # 出力する乱数の最大値の次の値
  )
)

hist(           # ヒストグラムを作成
  temp,
  breaks = seq(
    0,          # 下限
    6,          # 上限
    1           # 階級の幅
  ),
  freq = FALSE, # 相対度数を表示する
  col="red"     # 棒の色は赤
)
```



## 7. 「標本平均の平均」をとると母平均にかなり近くなる

### 1. 母集団から5個のサンプルをランダムに抽出する

* `sample()`関数:指定したデータからランダムにサンプリングを抽出する

```r
sample(
  x,
  size,
  replace = FALSE,
  prob = NULL
)
```

| 引数      | 内容                                             |
| --------- | ------------------------------------------------ |
| `x`       | ランダムサンプリングするデータを格納したベクトル |
| `size`    | ランダムサンプリングする個数                     |
| `replace` | 復元抽出を行うか                                 |
| `prob`    | ベクトル`x`のそれぞれのデータが抽出される確率    |
|           | デフォルトは`FALSE`                              |

5個のサンプルの平均をとることを15回繰り返し、その平均で推定する

```r
data <- read.table(             # テスト結果.txtをdataに代入
  "計測結果.txt",
  header=T,                     # 1行目は列名であることを指定
  fileEncoding="CP932"          # 文字コードをShift_JISに指定
)

sample_m <- as.numeric(NULL)    # 空の実数型ベクトルを用意

for (i in 1:15){                # 処理を15回繰り返す
  sample   <- sample(           # 抽出したサンプルをベクトルに代入
    data$容量,                  # 抽出元のデータ
    5,                          # サンプルサイズ
    replace = FALSE             # 復元抽出は行わない
    )
  # 標本平均をベクトルに追加
  sample_m <- c(sample_m, mean(sample))
}

s_mean <- mean(sample_m)        # 標本平均の平均を求める
p_mean <- mean(data$容量)       # 元データの平均
```



#### 母集団の平均と標本の平均

**標本平均**

$$
\begin{eqnarray}
標本平均 = \frac{x_1 + x_2 + \cdots + x_N}{n}
\end{eqnarray}
$$

**標本平均の平均**

$$
\begin{eqnarray}
標本平均の平均 = \frac{\bar{x_1} + \bar{x_2} + \cdots + \bar{x_N}}{n}
\end{eqnarray}
$$

```r
> p_mean      # 標本平均の平均を求める
[1] 181.36
> s_mean      # 元データの平均
[1] 182.88
> sample_m    # サンプルの個々の平均を出力
 [1] 178.4 185.6 175.6 175.4 177.2 179.4 189.2 188.0 187.6 195.2 172.6 182.4
[13] 187.4 186.6 182.6
```

母平均 $\mu$ と標本平均との不偏性

$$
\begin{eqnarray}
\mu \simeq = 標本平均の平均
\end{eqnarray}
$$



#### 標本分布で推定するときのポイント

1. 標本分布が母集団の本当の値を中心として分布しているか

    * 満たされていないと、推定値が本当の値をかすりもしない

    * 推定値が本当の値よりも小さめ、大きめの値になりやすくなる

    > 標本平均の平均を調べることでわかる

2. 標本分布が横に大きく広がっていないか？

    * 推定値に当たり外れが大きいか、あるいは推定値にどの程度の誤差が生じるかを調べる必要がある

    > 標本分布の標準偏差を調べることでわかる

### 2. 標本分布が母集団の本当の値を中心として分布しているか

* `lines()`関数:出力済みのグラフに、指定した地点を結ぶ線(ライン)を描画する

```r
lines(地点1, 地点2, ...)
```

```r
getDisper <- function(x) {                # 分散を返す関数
  dev <- x - mean(x)                      # 偏差を求める
  return(sum(dev^2) / length(x))          # 分散を返す
}

getSd <- function(x) {                    # 標準偏差を返す関数
  return(                                 # 戻り値を返す
    sqrt(                                 # 分散の平方根
      sum(
        (x - mean(x))^2) / length(x)      # 分散の計算式
      )
  )
}

data <- read.table(                       # テスト結果.txtをdataに代入
  "計測結果.txt",
  header=T,                               # 1行目は列名であることを指定
  fileEncoding="CP932"                    # 文字コードをShift_JISに指定
)

sample_m <- as.numeric(NULL)              # 標本平均を格納する空のベクトルを用意
rp <- c(1:1000)                           # 繰り返す回数をベクトルに代入
size <- 5                                 # サンプルサイズをベクトルに代入

for (i in rp){                            # 処理を10000回繰り返す
  sample   <- sample(
    data$容量,                            # 抽出元のデータ
    size,                                 # サンプルサイズ
    replace = FALSE                       # 復元抽出は行わない
  )
  # 標本平均をベクトルに追加
  sample_m <- c(sample_m, mean(sample))
}

s_mean <- mean(sample_m)                  # 標本平均の平均を求める
p_mean <- mean(data$容量)                 # 母集団の平均

hist(
  sample_m,                               # すべての標本平均をヒストグラムにする
  freq = FALSE,                           # 相対度数を表示する
  col="red"                               # 棒の色は赤
)
lines(density(sample_m))                  # 確率密度の近似値をラインで描画

# 標本平均の平均の分散を求める
sample_m_dsp   <- getDisper(sample_m)
# 母集団から標本平均の分散を割り出す
sample_m_dsp_est <- getDisper(data$容量)/size
# 標準誤差を求める
standard_error <- sqrt(sample_m_dsp)
# 標準偏差÷√サンプルサイズで標準誤差を求める
standard_error_by_sd <-getSd(data$容量)/sqrt(size)
```

* 標本平均の分布の法則:平均 $\mu$ 、分散 $\sigma$ の正規分布に従う母集団からサンプルサイズ $n$ 個の標本を抽出したときの標本平均の分布

$$
\begin{eqnarray}
\mathcal{N}(\mu, \frac{\sigma^2}{n})
\end{eqnarray}
$$

* 標本平均の平均における標準誤差:母集団が $\mathcal{N}(\mu, \sigma^2)$ の分布であるとき、標本平均の平均の標準誤差の平均

  * 推定値と母集団の誤差は、平均的には $\sqrt{\sigma^2}$ くらいの誤差が生じる

$$
\begin{eqnarray}
\sqrt{標本平均の分散s^2}
\end{eqnarray}
$$



## 8. データ全体の散らばりと標本平均の散らばり

### 1. 標本平均の分散を求める

標本抽出を行い、標本平均の記録を40回繰り返し、標本平均の分散を求めた上で、母分散 $\sigma^2$ と比較する

```r
getDisper <- function(x) {       # 標本分散を返す関数
  dev <- x - mean(x)             # 偏差を求める
  return(sum(dev^2) / length(x)) # 分散を返す
}

data <- read.table(              # 計測結果結果.txtをdataに代入
  "計測結果.txt",
  header=T,                      # 1行目は列名であることを指定
  fileEncoding="CP932"           # 文字コードをShift_JISに指定
)

sample_m <- as.numeric(NULL)     # 空の実数型ベクトルを用意

for (i in 1:15){                 # 処理を15回繰り返す
  sample   <- sample(
    data$容量,                   # 抽出元のデータ
    5,                           # サンプルサイズ
    replace = FALSE              # 復元抽出は行わない
  )
  # サンプルの平均をベクトルに追加
  sample_m <- c(sample_m, mean(sample))
}

s_mean <- mean(sample_m)        # 標本平均の平均
s_var  <- getDisper(sample_m)   # 標本平均の分散
p_mean <- mean(data$容量)       # 母集団の平均
p_var  <- getDisper(data$容量)  # 母集団の分散
```

```r
> s_mean
[1] 181.3867
> s_var
[1] 20.75982
> p_mean
[1] 181.36
> p_var
[1] 131.9904
```

* 母分散 $\sigma^2$ の推定値　$\hat{\sigma}^2$ と標本平均の分散の関係式

$$
\begin{eqnarray}
母分散 \simeq サンプルサイズ \times 標本平均の分散
\end{eqnarray}
$$

* 標本平均の分散を求める

$$
\begin{eqnarray}
標本平均の分散 = \frac{1}{サンプルサイズ} \times 母分散
\end{eqnarray}
$$



## 9. 標本分散の平均

```r
getDisper <- function(x) {       # 標本分散を返す関数
  dev <- x - mean(x)             # 偏差を求める
  return(sum(dev^2) / length(x)) # 分散を返す
}

data <- read.table(              # 計測結果結果.txtをdataに代入
  "計測結果.txt",
  header=T,                      # 1行目は列名であることを指定
  fileEncoding="CP932"           # 文字コードをShift_JISに指定
)

sample_m  <- as.numeric(NULL)    # 標本平均を格納するベクトルを用意
sample_v  <- as.numeric(NULL)    # 標本分散を格納するベクトルを用意
sample_uv <- as.numeric(NULL)    # 標本分散を格納するベクトルを用意

for (i in 1:15){                 # 処理を15回繰り返す
  sample   <- sample(
    data$容量,                   # 抽出元のデータ
    5,                           # サンプルサイズ
    replace = FALSE              # 復元抽出は行わない
  )
  # サンプルの平均をベクトルに追加
  sample_m  <- c(sample_m, mean(sample))
  # サンプルの分散を求めてベクトルに追加
  # サンプル平均はgetDisper()で計算される
  sample_v  <- c(sample_v, getDisper(sample))
  # サンプルの普遍分散を求めてベクトルに追加
  sample_uv <- c(sample_uv, var(sample))
}

s_mean    <- mean(sample_m)       # 標本平均の平均
s_mean_v  <- mean(sample_v)       # 標本分散の平均
s_mean_uv <- mean(sample_uv)      # 不偏分散の平均
p_mean    <- mean(data$容量)      # 母集団の平均
p_var     <- getDisper(data$容量) # 母集団の分散
```

```r
> s_mean
[1] 181.1067
> s_mean_v
[1] 95.28533
> s_mean_uv
[1] 119.1067
> p_mean
[1] 181.36
> p_var
[1] 131.9904
```



| version | update     |
| ------- | ---------- |
| 1st     | 2020/04/10 |
