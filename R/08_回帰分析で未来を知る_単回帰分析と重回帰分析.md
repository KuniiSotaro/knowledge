09 回帰分析で未来を知る 単回帰分析と重回帰分析
=======================================

## 1. 相関関係と線形単回帰分析

### 相関分析でデータ同士の関係を数値化する

> 過去のデータがあればそれを分析し、広告と売上には密接な関係があることを突き詰めておくことが重要

* 相関分析:2つのデータの関連性を統計的に解析し、それを数値化する

* 相関係数:相関分析を行ってわかった、2つのデータの結びつきの強さ

  * 「係数」という客観的な数値で適切な判断が行える

* 単回帰式:目的変数 $y$ と 説明変数 $x$ において比例関係を表す

  * $\sigma$:切片

  * $b$:説明変数 $x$ の係数

$$
\begin{eqnarray}
y = a + bx
\end{eqnarray}
$$



### 2. 散布図で相関関係を見る(散布図の描画)

* 散布図を作成するときの注意点

  * 横軸:「原因となるような項目」

  * 縦軸:「結果となるような項目」

* `plot()`関数:散布図を描く

  * 第一引数:横軸(`x`)に割り当てるデータ

  * 第二引数:縦軸(`y`)に割り当てるデータ

```R
plot(x軸に割り当てるデータ, y軸に割り当てるデータ)
```

```R
file <- "清涼飲料水売上.txt" # 読み込むファイル名を設定

data <- read.delim(          # ファイルを読み込んでdataに格納
  file,
  header=T,                  # 1行目は列名であることを指定
  fileEncoding="CP932"       # 文字コードをShift_JISに指定
)

var_1<- c(
  data[,1]                   # 1列目の変量をベクトルに代入
)

var_2<- c(
  data[,2]                   # 2列目の変量をベクトルに代入
)

plot(data)                   # 散布図を描く
```

> 散布図では、気温と清涼飲料水の売上に正の相関があることがわかった



#### 外れ値の確認

* イレギュラーなデータであれば削除する

  * 明確な理由がある場合には外れ値に該当するデータを削除する

* 外れ値のデータをそのまま残しておいて今後の分析に役立てる

  * 最終的には「意味のないデータ」として削除するかどうかを判断する

  * 外れ値には何らかの原因があるかもしれないので、視点を変えて原因を探る必要がある



### 3. 2つのデータの強さを求める

* 相関係数は、常に`-1`から`1`までの値をとる

  * 正の相関:相関係数の符号が正

  * 負の相関:相関係数の符号が負

$$
\begin{eqnarray}
-1 \leq r \leq 1
\end{eqnarray}
$$

* 相関係数の強さ:相関係数の絶対値 $\vert r \vert$ で評価する

| 相関係数(絶対値)               | 相関の強さ       |
|:-------------------------------|:-----------------|
| $\vert r \vert <0.3$           | ほとんど相関なし |
| $0.3 \leq \vert r \vert < 0.5$ | 弱い相関がある   |
| $0.5 \leq \vert r \vert < 0.7$ | 相関がある       |
| $0.7 \leq \vert r \vert$       | 強い相関がある   |

* 相関係数を求める式は、以下の式となる

$$
\begin{eqnarray}
r = \frac{\sum_{i=1}^n(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^n(x_i-\bar{x})^2}\sqrt{\sum_{i=1}^n(y_i - \bar{y})}}
\end{eqnarray}
$$

* `cor()`関数:相関係数を求める

  * デフォルトで、「スピアマンの積率相関係数」が求められる

```R
cor(データ1, データ2, [method="spearman"], [method="kendall"])
```

```R
coef <- cor(var_1, var_2)    # 相関係数を求める
```

```R
> coef
[1] 0.9702484
```

> 気温と販売数の関係には十分に強い相関関係があることがわかる



### 4. 線形回帰分析を実行する

* 回帰直線:2つのデータの散布図に描かれたプロットの中心を通るような直線を引いたもの

* 線形回帰分析:回帰曲線でモデル化する分析

  * 2つのデータの平均値が交差する部分を通る

  * 各点とのズレが最小となる位置を通る

    > `回帰係数`を求める必要がある

$$
\begin{eqnarray}
b = \frac{\sum_{i=1}^n(x_i - \bar{x})(y_i - \bar{y})}{\sum_{i=1}^n(x_i - \bar{x})^2}\\
a = \frac{(\sum_{i=1}^nx_i^2)(\sum_{i=1}y_i)-(\sum_{i=1}^nx_iy_i)(\sum_{i=1}^nx_i)}{n\cdot(\sum_{i=1}^nx_i^2)-(\sum_{i=1}^nx_i)^2}
\end{eqnarray}
$$



#### 最小2乗法

* 最小2乗法:データのプロットと回帰曲線のズレ(残差)の合計が最小になるように、 $a$ と $b$ を求める

  * $\varepsilon$:残差

$$
\begin{eqnarray}
\varepsilon = \hat{y} - y
\end{eqnarray}
$$

* データの $i$ 番目個体について、目的変数 $y$ の実測値 $y_i$ と、単回帰式から得られる予測値 $\hat{y}$ との残差を $\varepsilon_i$ とすると、

$$
\begin{eqnarray}
\varepsilon_i = y_i - \hat{y} = y_i - (a+bx_i)
\end{eqnarray}
$$

* ここで、残差平方和を用いて、最小化する $a$、$b$ を決定する

$$
\begin{eqnarray}
\varepsilon_n^2 = \sum (y_i - a - bx_i)^2
\end{eqnarray}
$$



#### 線形回帰分析を行う

* `Im()`関数:線形回帰分析を行う

```R
Im(formula, data,　weights, subset, na.action)
```

| parameter   | explanation                                                                |
|:------------|:---------------------------------------------------------------------------|
| `formula`   | 回帰式に用いる目的変数、説明変数、定数項を用いるかなどのモデルの形式を指定 |
| `data`      | 回帰分析に用いるデータを指定                                               |
| `weights`   | 必要な場合に、説明変数の重みを指定                                         |
| `subset`    | データフレーム中の一部分のみを使用する際に指定する                         |
| `na.action` | 欠損値の扱いを指定する                                                     |

> 今回は $y$ が最高気温、 $x$ は清涼飲料水の売上数

```R
> # 線形単回帰分析を実行
> salse.lm <- lm(var_2~var_1, data=data)
> # 分析結果を表示
> summary(salse.lm)

Call:
lm(formula = var_2 ~ var_1, data = data)

Residuals:
    Min      1Q  Median      3Q     Max
-52.051 -20.828  -1.217  15.338  59.171

Coefficients:
            Estimate Std. Error t value Pr(>|t|)    
(Intercept) -760.877     46.071  -16.52 5.75e-16 ***
var_1         33.741      1.591   21.20  < 2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 28.7 on 28 degrees of freedom
Multiple R-squared:  0.9414,	Adjusted R-squared:  0.9393
F-statistic: 449.7 on 1 and 28 DF,  p-value: < 2.2e-16
```

* 回帰分析の結果から、定数項と回帰係数の値だけを取り出す

```R
> round(coefficients(salse.lm), 2)
(Intercept)       var_1
    -760.88       33.74
```

* `Std.Error`:係数を求めた時の標準誤差

* `t value`:係数を求めた時のt値

* `Pr(>|t|)`:係数を求めた時のp値

$$
\varepsilon_n^2 = \sum(y_i - \hat{y}_i)^2\\
u_{\varepsilon}^2 = \frac{\varepsilon_n^2}{n-k-1}\\
E(a)=\sqrt{\varepsilon_n^2\Bigr( \frac{1}{n} + \frac{x^2}{\sum (x_i - \bar{x})^2} \Bigl)}\\
E(b) = \sqrt{\frac{u_{\varepsilon}^2}{\sum (x_i - x)^2}}\\
t_a = \frac{a}{E(a)}\\
t_b = \frac{b}{E(b)}
$$

* `Multiple R-squared`:調整済み決定係数

  * 回帰モデルがどの程度データにフィットしているかを表す

  * 決定係数と調整済み決定係数が1に近づくほど、回帰モデル(直線)がデータによくフィットする

$$
\begin{eqnarray}
R^2 = \frac{S_{\hat{y}\hat{y}}}{S_{yy}}\\
調整済み決定係数R^2 = 1\cdot\frac{\varepsilon_n^2/(n-k-1)}{S_{yy}/(n-1)}
\end{eqnarray}
$$

* `F-statistic`:F値とそのp値を表す

  * 「全ての回帰係数がゼロ」であるという場合の帰無仮説の検定統計量

$$
\begin{eqnarray}
F = \frac{R^2}{1-R^2}\cdot\frac{n-k-1}{k}
\end{eqnarray}
$$



### 5. 最高気温が1度上昇した時の売上数を予測する

* `lm()`関数で求めた線形単回帰分析の結果を活用するための関数は、以下のものが定義されている

| name         | explanation                | example              |
|:-------------|:---------------------------|:---------------------|
| `coef()`     | 回帰係数                   | `coef(salse.lm)`     |
| `fitted()`   | 用いたデータの予測値       | `fitted(salse.lm)`   |
| `deviance()` | 残差の平方和               | `deviance(salse.lm)` |
| `anova()`    | 回帰係数の分散分析         | `anova(salse.lm)`    |
| `predict()`  | 新たなデータに対する予測値 | `predict(salse.lm)`  |
| `print()`    | 要約よりも簡単な結果の表示 | `print(salse.lm)`    |
| `summary()`  | 回帰分析結果の要約         | `summary(salse.lm)`  |

```R
# 散布図に回帰直線を引く
plot(data)
abline(salse.lm)
```



## 2. 線形重回帰分析

### 1. 重回帰分析で説明変数が複数の場合の分析を行う

* 重回帰分析:2つ以上の要因(説明変数)を使ってデータを予測する

$$
\begin{eqnarray}
y = b + a_1x_1 + a_2x_2 + \cdots + a_nx_n
\end{eqnarray}
$$

* 説明変数: $X$

* 目的変数: $Y$

* 誤差: $E$

* 係数: $A$

$$
\begin{eqnarray}
Y = XA + E
\end{eqnarray}
$$

* この時の係数は、以下の式で求められる

$$
\begin{eqnarray}
\bar{A} = (X^TX)^{-1}X^TY
\end{eqnarray}
$$



#### 相関係数を確認する

```R
file <- "売上高と各種要因.txt" # 読み込むファイル名を設定

data <- read.delim(            # ファイルを読み込んでdataに格納
  file,
  header=T,                    # 1行目は列名であることを指定
  row.names=1,
  fileEncoding="CP932"         # 文字コードをShift_JISに指定
)

# データフレームの各列をベクトルに代入
var_1<- c(data[,1])           # 1列目の変量をベクトルに代入
var_2<- c(data[,2])           # 2列目の変量をベクトルに代入
var_3<- c(data[,3])           # 3列目の変量をベクトルに代入
var_4<- c(data[,4])           # 4列目の変量をベクトルに代入
var_5<- c(data[,5])           # 5列目の変量をベクトルに代入
var_6<- c(data[,6])           # 6列目の変量をベクトルに代入

coef <- cor(data)            # 相関係数を求める
```

```R
> coef
               売上額.万円.    立地...     競合店    面積... サービス満足度
売上額.万円.      1.0000000 -0.7657018 -0.6692924  0.2629088      0.7756754
立地...          -0.7657018  1.0000000  0.9226217 -0.2797616     -0.5668410
競合店           -0.6692924  0.9226217  1.0000000 -0.1831194     -0.4427619
面積...           0.2629088 -0.2797616 -0.1831194  1.0000000      0.2432349
サービス満足度    0.7756754 -0.5668410 -0.4427619  0.2432349      1.0000000
商品の充実度      0.7803769 -0.7180655 -0.5724830  0.4492832      0.6024347
               商品の充実度
売上額.万円.      0.7803769
立地...          -0.7180655
競合店           -0.5724830
面積...           0.4492832
サービス満足度    0.6024347
商品の充実度      1.0000000
```



### 2. 全ての説明変数を使って重回帰分析する

* 重回帰分析では、説明変数自体に意味のあるものを使用して行う

* 説明変数同士の関連性が強すぎてはいけない

  * 分析から得られた係数の符号が逆転してしまうことがある

```R
###################################################
# すべての説明変数を使用して重回帰分析
###################################################
# 線形単回帰分析を実行
lm1 <- lm(var_1 ~
            var_2 + var_3 + var_4 + var_5 + var_6,
          data=data)
summary(lm1)                # 分析結果を表示
round(coefficients(lm1), 2) # 係数を表示

# 分析のもとになったデータと予測値、残差を一覧にする
exp <- predict(lm1)         # 元データに対する予測値
res <- residuals(lm1)       # データと予測値の残差
view_lm1 <- data.frame(data[1], exp, res) # データフレームにまとめる
```

```R
> summary(lm1)

Call:
lm(formula = var_1 ~ var_2 + var_3 + var_4 + var_5 + var_6, data = data)

Residuals:
     Min       1Q   Median       3Q      Max
-1989.33  -665.54   -14.47   740.33  1599.93

Coefficients:
            Estimate Std. Error t value Pr(>|t|)  
(Intercept)  265.898   2607.724   0.102    0.920  
var_2       -171.774    553.409  -0.310    0.761  
var_3       -336.777    655.910  -0.513    0.616  
var_4         -3.213      5.806  -0.553    0.589  
var_5       1369.413    494.022   2.772    0.015 *
var_6        968.344    511.048   1.895    0.079 .
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1104 on 14 degrees of freedom
Multiple R-squared:  0.8077,	Adjusted R-squared:  0.7391
F-statistic: 11.76 on 5 and 14 DF,  p-value: 0.0001312
```



#### 決定係数と調整済み決定係数

* 決定係数($R^2$)の値は、回帰式の精度を表す

  * 5個全ての説明変数で、約80%の確率で説明ができる

  * 一方で、説明変数が多くなると、回帰式の精度とは関係なく決定係数の値が大きくなる

* 調整済み決定係数:計算上の問題による決定係数の増加分を補正したもの

  * 一般には`0.4`以上あれば精度に問題がない



#### t値

* t値:それぞれの説明変数の目的変数に対する影響を示す指標

  * 説明変数の係数を標準誤差で割った値

  * 値が大きければ目的変数に対する影響度が強い

  * 目安:`1.4`以上あれば、影響の度合いが強い



#### 係数の確認

```R
> round(coefficients(lm1),2)
(Intercept)       var_2       var_3       var_4       var_5       var_6
     265.90     -171.77     -336.78       -3.21     1369.41      968.34
```



#### 誤差の確認

> 実測値に近いものもあるが、大きく外しているものもあるので、説明変数を減らすほうが良い

```R
> view_lm1
           売上額.万円.      exp         res
赤坂店             7990 8633.632  -643.63203
溜池山王店         8420 9211.441  -791.44112
広尾店             3950 3334.324   615.67562
南麻布店           6870 7280.281  -410.28068
麻布十番店         4520 3810.154   709.84576
恵比寿店           3480 5469.325 -1989.32542
高輪店             8900 8635.857   264.14276
西五反田店         6280 5448.226   831.77374
東五反田店         8180 6580.068  1599.93233
不動前店           5330 5759.021  -429.02079
飯倉店             3090 3821.248  -731.24795
渋谷店             8600 7442.045  1157.95498
中目黒店           3880 4816.755  -936.75529
南青山店           7400 6342.914  1057.08641
北青山店           4540 4553.591   -13.59059
芝公園店           3450 5010.610 -1560.60974
泉岳寺店           2350 2365.356   -15.35634
乃木坂店           8510 8116.804   393.19596
表参道店           4450 4579.045  -129.04459
神宮前店           5320 4299.303  1020.69697
```



### 3. 説明変数を減らしてもう一度分析する

* `step()`関数:分析結果から、説明変数を1つずつ減らした場合の分析結果をシミュレートする

  * `both`: デフォルト。増減法を指定

  * `forward`:増加法を指定

  * `backward`:減少法を指定

```R
step( 分析結果,
  , derection="both"
)
```



#### step()関数で説明変数を1つずつ減らした分析結果を見る

* AIC:モデルの選択基準

$$
\begin{eqnarray}
AIC = -2 \times (モデルの最大対数尤度) + 2\times(モデルのパラメータ数)
\end{eqnarray}
$$

> `step()`関数でAICを計算するときは、以下の式となる
>
> * $n$:分析対象の個体の数

$$
\begin{eqnarray}
AIC = n \times \Bigr( \frac{残差の2乗和}{n} \Bigl) + 2 \times (モデルのパラメータ数)
\end{eqnarray}
$$

```R
> stp <- step(lm1)
Start:  AIC=285.15
var_1 ~ var_2 + var_3 + var_4 + var_5 + var_6

        Df Sum of Sq      RSS    AIC
- var_2  1    117500 17191813 283.28
- var_3  1    321523 17395836 283.52
- var_4  1    373505 17447817 283.58
<none>               17074312 285.15
- var_6  1   4378764 21453076 287.71
- var_5  1   9371123 26445435 291.90

Step:  AIC=283.28
var_1 ~ var_3 + var_4 + var_5 + var_6

        Df Sum of Sq      RSS    AIC
- var_4  1    351179 17542992 281.69
<none>               17191813 283.28
- var_3  1   3898169 21089982 285.37
- var_6  1   6271100 23462912 287.50
- var_5  1  10540498 27732311 290.85

Step:  AIC=281.69
var_1 ~ var_3 + var_5 + var_6

        Df Sum of Sq      RSS    AIC
<none>               17542992 281.69
- var_3  1   4166199 21709191 283.95
- var_6  1   6101264 23644256 285.66
- var_5  1  10637978 28180970 289.17
```

* `<none>`の上の行:次に減らすべき説明変数

* `<none>`の下の行:減らしてもAIC値が下がらない説明変数



#### 2つの説明変数を減らして重回帰分析を実行

```R
##################################################
# 増減法で説明変数を減らして重回帰分析
##################################################
# 説明変数を減らしたAIC値を求める
stp<-step(lm1)
# 不要な説明変数を外して線形単回帰分析を実行
lm2 <- lm(var_1 ~
            var_3 + var_5 + var_6,
          data=data)
summary(lm2)                # 分析結果を表示
round(coefficients(lm2), 2) # 係数を表示

# 分析のもとになったデータと予測値、残差を一覧にする
exp <- predict(lm2)         # 元データに対する予測値
res <- residuals(lm2)       # データと予測値の残差
view_lm2 <- data.frame(data[1], exp, res) # データフレームにまとめる
```

```R
> summary(lm2)

Call:
lm(formula = var_1 ~ var_3 + var_5 + var_6, data = data)

Residuals:
     Min       1Q   Median       3Q      Max
-1764.76  -661.79   -57.66   707.67  1488.79

Coefficients:
            Estimate Std. Error t value Pr(>|t|)   
(Intercept)   -783.0     1709.5  -0.458  0.65310   
var_3         -534.4      274.1  -1.949  0.06901 .
var_5         1413.4      453.8   3.115  0.00667 **
var_6          942.1      399.4   2.359  0.03138 *
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1047 on 16 degrees of freedom
Multiple R-squared:  0.8024,	Adjusted R-squared:  0.7654
F-statistic: 21.66 on 3 and 16 DF,  p-value: 7.031e-06
```

```R
> view_lm2
           売上額.万円.      exp         res
赤坂店             7990 8638.972  -648.97193
溜池山王店         8420 9046.692  -626.69177
広尾店             3950 3267.003   682.99652
南麻布店           6870 7570.246  -700.24594
麻布十番店         4520 3738.319   781.68104
恵比寿店           3480 5214.765 -1734.76479
高輪店             8900 8638.972   261.02807
西五反田店         6280 5749.128   530.87222
東五反田店         8180 6691.211  1488.78938
不動前店           5330 5749.128  -419.12778
飯倉店             3090 3801.366  -711.36647
渋谷店             8600 7225.574  1374.42639
中目黒店           3880 4807.045  -927.04495
南青山店           7400 6093.800  1306.19990
北青山店           4540 4680.402  -140.40179
芝公園店           3450 5214.765 -1764.76479
泉岳寺店           2350 2324.921    25.07936
乃木坂店           8510 8104.609   405.39107
表参道店           4450 4680.402  -230.40179
神宮前店           5320 4272.682  1047.31805
```



### 4. 説明変数を減らさずに変数の交互作用だけを減らして分析する

* これまでの重回帰分析:目的変数と説明変数との相互作用に着目

* 説明変数の間に相関がある場合を考慮すると、以下の回帰式となる

$$
\begin{eqnarray}
\hat{y} = a_0 + a_1x_1 + a_2x_2 + a_3x_1x_2
\end{eqnarray}
$$

```R
lm3 <- lm(var_1 ~
            (var_2 + var_3 + var_4 + var_5 + var_6) ^2,
          data=data)
summary(lm3)
```

```R
> summary(lm3)

Call:
lm(formula = var_1 ~ (var_2 + var_3 + var_4 + var_5 + var_6)^2,
    data = data)

Residuals:
    赤坂店 溜池山王店     広尾店   南麻布店 麻布十番店   恵比寿店     高輪店
   -327.76    -178.42     698.84     343.84     143.64    -542.67     209.35
西五反田店 東五反田店   不動前店     飯倉店     渋谷店   中目黒店   南青山店
   1136.53    -624.04    -140.70     207.07     341.28    -260.08     415.02
  北青山店   芝公園店   泉岳寺店   乃木坂店   表参道店   神宮前店
    -22.52   -1264.90    -156.24     287.64    -412.05     146.16

Coefficients:
              Estimate Std. Error t value Pr(>|t|)
(Intercept) -28807.903  43725.166  -0.659    0.546
var_2         6236.375   7724.764   0.807    0.465
var_3        -7606.035  10738.929  -0.708    0.518
var_4           54.887    166.761   0.329    0.759
var_5         7738.703  16874.878   0.459    0.670
var_6         6150.389  17192.019   0.358    0.739
var_2:var_3    286.069    430.889   0.664    0.543
var_2:var_4    -15.264     39.827  -0.383    0.721
var_2:var_5   1137.254   3856.416   0.295    0.783
var_2:var_6  -1915.039   1932.715  -0.991    0.378
var_3:var_4     12.521     29.680   0.422    0.695
var_3:var_5   -961.361   3828.903  -0.251    0.814
var_3:var_6   1824.399   2717.537   0.671    0.539
var_4:var_5    -11.777     39.449  -0.299    0.780
var_4:var_6      1.253     60.493   0.021    0.984
var_5:var_6  -1359.333   2039.140  -0.667    0.541

Residual standard error: 1130 on 4 degrees of freedom
Multiple R-squared:  0.9425,	Adjusted R-squared:  0.727
F-statistic: 4.373 on 15 and 4 DF,  p-value: 0.08197
```



#### step()関数でAICが最も低い組み合わせを調べる

```R
# 相互作用を1つずつ外してAIC値を求める
lm4 <- step(lm3)

# 分析のもとになったデータと予測値、残差を一覧にする
exp <- predict(lm4)         # 元データに対する予測値
res <- residuals(lm4)       # データと予測値の残差
view_lm4 <- data.frame(data[1], exp, res) # データフレームにまとめる

# 係数を表示
round(coefficients(lm4), 2)
```

```R
> round(coefficients(lm4), 2)
(Intercept)       var_2       var_3       var_4       var_5       var_6
  -42856.68     8566.82    -7240.91       73.71    11490.02     7600.81
var_2:var_4 var_2:var_6 var_3:var_4 var_4:var_5 var_5:var_6
     -21.45     -805.99       23.56      -17.90    -1575.55

```

* 今回の回帰モデルを用いて、予測を行う

```R
# 説明変数に値を代入
  v2 <- 0.1
  v3 <- 0
  v4 <- 300
  v5 <- 4
  v6 <- 4

# 回帰モデルで予測する
prd <- -42856.68 +
  8566.82  * v2 -      # 立地
  7240.91  * v3 +      # 競合店
  73.71    * v4 +      # 面積
  11490.02 * v5 +      # サービス満足度
  7600.81  * v6 -      # 商品の充実度
  21.45    * v2 * v4 - # var_2:var_4
  805.99   * v2 * v6 + # var_2:var_6
  23.56    * v3 * v4 - # var_3:var_4
  17.90    * v4 * v5 - # var_4:var_5
  1575.55  * v5 * v6   # var_5:var_6

  > prd
  [1] 8821.626
```



## 3. 非線形回帰分析

### 1. ロジスティック関数を使って非線形回帰分析する

* 最初は横ばいだった普及率がある時点から大きくカーブを描く

* 全体に100%に近いところまでいくと、上昇基調から急激に横ばいへと転じる

```R
file <- "普及率.txt" # 読み込むファイル名を設定

data <- read.delim(                # ファイルを読み込んでdataに格納
  file,
  header=T,                        # 1行目は列名であることを指定
  fileEncoding="CP932"             # 文字コードをShift_JISに指定
)

# データフレームの各列をベクトルに代入
year <- c(data[,1])                # 1列目の変量をベクトルに代入
pene <- c(data[,2])                # 2列目の変量をベクトルに代入
plot(data, col="red")
```



#### ロジスティック関数とロジスティック回帰

* ロジスティック関数:非線形の分布

* ロジスティック回帰:ロジスティック関数を使う回帰分析

$$
\begin{eqnarray}
y = \frac{a}{1+be^{cx}}
\end{eqnarray}
$$

* 線形回帰分析では、残差が正規分布に従うことを仮定している

  * 正規分布に従わないデータについては、線形回帰分析が行えない

* 一般化線形モデル:非線形の分布を線形の分布と同じように扱うための方法

* `glm()`関数:一般化線形モデルのための関数

```R
file <- "普及率.txt" # 読み込むファイル名を設定

data <- read.delim(                # ファイルを読み込んでdataに格納
  file,
  header=T,                        # 1行目は列名であることを指定
  fileEncoding="CP932"             # 文字コードをShift_JISに指定
)

# データフレームの各列をベクトルに代入
year <- c(data[,1])                # 1列目の変量をベクトルに代入
pene <- c(data[,2])                # 2列目の変量をベクトルに代入

# ロジスティック回帰分析を行う
glm <- glm(pene~year,family=binomial)

plot(year, pene,type="l")          # 実測値の散布図を描く
lines(year,                        # x座標は年代
      fitted(glm),                 # y座標は予測値
      lty=2,
      col="red",lwd=2)

exp <- cbind(data,                 # 実測値と予測値の表を作成
                fitted(glm))

```



### 2. データにロジスティック関数を当てはめて非線形回帰分析する

* `nls()`関数:非線形回帰分析を行う

  * 引数に目的変数と説明変数との関係式を設定することで分析を行う

```R
nls(formula, data, start, trace)
```

| 引数      | 説明                                                 |
|:----------|:-----------------------------------------------------|
| `formula` | 目的変数と説明変数との関係式                         |
| `data`    | 関係式に重みをつけるためのデータフレーム(オプション) |
| `start`   | 初期値                                               |
| `trace`   | `TRUE`で計算の過程を出力する。デフォルトは`FALSE`    |

  * 引数`formula`:目的変数と説明変数との関係式を具体的に書く

```R
# ロジスティック回帰の場合
y ~ a / (1 + b * exp(c * x))
```

  * `exp()`関数:`e`(自然対数の底)のx乗の値を返す

```R
exp(x)
```

| 引数 | 説明                |
|:-----|:--------------------|
| `x`  | eに対して累乗する値 |

  * 引数`start`:初期値を与えて、計算を始める

```R
start=c(a=1, b=1, c=-1)
```

* 引数`trace`:計算の過程を出力するかどうかを設定する。デフォルトは`FALSE`

> `nls`関数は、線形回帰分析よりも計算が難しいので、うまく会を求められずに失敗することがある

```R
year <-(1:19)       																 # 年度を1～19にする

# 非線形回帰分析
relat.nls <- nls(
                 pene ~ a / (1 + b * exp(c * year)), # 関係式
                 start=c(a=1, b=1, c=-1),            # 初期値を設定
                 trace="TRUE"                        # 計算過程をトレース
                 )
```

```R
3.905671 :   1  1 -1
2.387674 :   0.9824052  0.4300442 -0.1029666
1.743185 :   0.8872618  0.8264732 -0.2623701
0.7740848 :   0.9841109  2.3123040 -0.2310466
0.5578214 :   0.9271411  7.5149745 -0.5270324
0.09229081 :   1.0001338 17.1134431 -0.4350728
0.06874582 :   0.9606817 40.3886048 -0.6606493
0.01653944 :   0.9826601 75.9510196 -0.7160221
0.003486704 :    0.9806949 110.6878618  -0.7509771
0.001959816 :    0.9804580 123.8500779  -0.7565368
0.00194977 :    0.9806034 123.8048223  -0.7553703
0.001949752 :    0.9806268 123.6621028  -0.7551686
0.001949752 :    0.9806279 123.6609455  -0.7551647
```

* よって、この回帰モデルは以下の係数となる

```R
y = 0.9806279 / (1 + 123.6609455 * exp(-0.7551647 * x))
```

* `coefficients()`関数を用いて、分析結果をロジスティック関数に当てはめて普及率を予測する

```R
relat.coef <- coefficients(relat.nls)   # 係数を取得

# 係数を取り出す
a<- as.vector(relat.coef[1])            # aの値
b<- as.vector(relat.coef[2])            # bの値
c<- as.vector(relat.coef[3])            # cの値
x <- 10                                 # xの値

relat.y <- a / ( 1 + b * exp(c * x))    # 非線形の回帰モデル
```

```R
> relat.y
[1] 0.9208187

```

* 実測値と予測値の一覧と、グラフを作成する

```R
expe_1 <- cbind(data,    # 実測値と予測値の表を作成
                fitted(relat.nls))

plot(year, pene, cex=1)  # 実測値の散布図を作成
lines(year,              # x座標は年代
      fitted(relat.nls), # y座標は予測値
      col="RED",         # 赤にする
      lty="dotted",      # ドットで描画
      lwd=2)             # 太さは2
```



### 3. SSlogis()関数を使って非線形回帰分析を分析する

* `SSlogs()`関数:ロジスティック関数を使用して曲線とその勾配を評価する

```R
SSlogs(input, Asym, xmid, scal)
```

| 引数    | 説明                                          |
|:--------|:----------------------------------------------|
| `input` | 非線形に分布するデータを格納したベクトル      |
| `Asym`  | 漸近線を表す数値パラメータ                    |
| `xmid`  | 曲線の変曲点における`x`値を表す数値パラメータ |
| `scal`  | 入力軸の数値スケールパラメータ                |



#### ロジスティック関数SSlogis()で曲線を割り出す

```R
# SSlogis()を引数にして非線形回帰分析
func.nls <- nls(pene ~
                  SSlogis(year, Asym, xmid, scal)
                )

summary(func.nls)                   # 分析結果を表示

func.coef <- coefficients(func.nls) # 係数を取得

# 係数を取り出す
Asym <- as.vector(func.coef[1])     # aの値
xmid <- as.vector(func.coef[2])     # bの値
scal <- as.vector(func.coef[3])     # cの値
x    <- 10                          # xの値

# ロジスティック曲線モデル
func.y    <- Asym / (1 + exp((xmid - x) / scal))

expe_2    <- cbind(data,            # 実測値と予測値の表を作成
                   fitted(relat.nls),
                   fitted(func.nls))
```

* `SSlogis()`関数を使用した曲線モデルは、以下の式で表される

```R
y = Asym/(1+exp((xmid-x)/scal))
```

* 回帰モデルの収まり具合は、以下の通り

```R
> AIC(relat.nls)
[1] -112.5857
> AIC(func.nls)
[1] -112.5857
```



## 4. 一般化線形モデル

### 1. 一般化線形モデルの回帰分析を行うglm()関数

* 一般化線形モデル:正規分布を拡張した分布に非線形の分布を対応させることで、線形モデルと同じように扱えるようにした手法

  * 例:二項分布、ポアソン分布、ガンマ分布、逆正規分布



#### 一般化線形モデルとglm()関数

* 線形モデル:

  * 目的変数:`Y`

  * 説明変数:`X`

  * 係数:`A`

  * 誤差:`E`

```R
Y = XA + E
```

* 一般化線形モデル:

  * 非線形関数:`XA`

  * 目的変数の平均:`u`

  * リンク関数(非線形のデータを正規分布に拡張した分布に対応):`g`

```R
g(u) = XA
```

* `glm()`関数:一般化線形モデルを使用して回帰分析を行う

```R
glm(formula, family, data)
```

| 引数      | 説明                       |
|:----------|:---------------------------|
| `formula` | モデルの式を指定する       |
| `family`  | リンク関数を指定する       |
| `data`    | 分析対象のデータを指定する |

* 引数`family`:`family=gaussian`と指定することで、自動的にリンク関数をリンクする

  * デフォルトは`gaussian`

| family           | kinds        | link                 | assignment        |
|:-----------------|:-------------|:---------------------|:------------------|
| gaussian         | 正規分布     | $\mu$                | `link="identity"` |
| binomial         | 二項分布     | $\log{(\mu(1-\mu))}$ | `link="logit"`    |
| poisson          | ポアソン分布 | $\log{\mu}$          | `link="log"`      |
| Gamma            | ガンマ分布   | $\frac{1}{\mu}$      | `link="inverse"`  |
| Inverse gaussian | 逆正規分布   | $\frac{1}{\mu[2]}$   | `link="1/mu^2"`   |



### 2. 一般化線形モデルの回帰分析

* `lm()`関数を用いて、オゾンを目的変数、風力と温度を説明変数、として分析する

```R
airquality <- na.omit(airquality)# airqualityから欠損値がある行を削除

lm <- lm(Ozone ~                # 線形重回帰分析を実行
            Solar.R + Wind + Temp,
          data=airquality
         )

lm <- lm(airquality[,1] ~       # 線形重回帰分析を実行
           airquality[,2] + airquality[,3] + airquality[,4],
         data=airquality
)

qqnorm(                         # 残差の散布図を描く
  resid(lm)                     # 残差の行列を抽出
  )
qqline(                         # 散布図に上下四分位点を結ぶ直線を描く
  resid(lm),                    # 残差の行列を抽出
  lwd=2,col="red")
```



#### glm()関数で一般化線形モデルの回帰分析を行う

1. 正規分布を仮定した分析

2. ガンマ分布を仮定した解析

```R
# 一般化線形モデルに正規分布を使う
glm1 <- glm(airquality[,1] ~    # 線形重回帰分析を実行
              airquality[,2] + airquality[,3] + airquality[,4],
            data=airquality,
            family = gaussian   # 正規分布を使用
            )

# 一般化線形モデルにガンマ分布を使う
glm2 <- glm(airquality[,1] ~    # 線形重回帰分析を実行
              airquality[,2] + airquality[,3] + airquality[,4],
            data=airquality,
            family = Gamma      # ガンマ分布を使用
            )

exp <- cbind(airquality[,1],    # 実測値と予測値の表を作成
             fitted(glm1),      # 正規分布を仮定した予測値
             fitted(glm2))      # ガンマ分布を仮定した予測値

AIC(lm)
AIC(glm1)
AIC(glm2)

# 分布図と直線を描いてみる
qqnorm(resid(glm1))
qqline(resid(glm1),lwd=2,col="red")
qqnorm(resid(glm2))
qqline(resid(glm2),lwd=2,col="red")
```

* `AIC()`関数を用いて、モデルの当てはまりの良さを評価する

```R
> AIC(lm)
[1] 998.7171
> AIC(glm1)
[1] 998.7171
> AIC(glm2)
[1] 939.8778

```



## 5. ロジスティック回帰分析

* ロジスティック回帰分析:0になる確率、1になる確率を求める

  * オッズ:確率 $p$ で起こる事象を $A$ とすると、$A$ が起こる確率と起こらない確率の比

$$
\begin{eqnarray}
\frac{p}{1-p}
\end{eqnarray}
$$

  * 対数オッズ:オッズの対数をとったもの

$$
\begin{eqnarray}
\log{\frac{p}{1-p}}
\end{eqnarray}
$$

  * ロジット関数:対数オッズを関数とみなしたもの

$$
\begin{eqnarray}
f(p) = \log{\frac{p}{1-p}}
\end{eqnarray}
$$

  * ロジット関数の逆関数を求める

$$
\begin{eqnarray}
e^y = \frac{p}{1-p}\\
e^y - e^yp = p\\
p = \frac{e^y}{e^y+1}=\frac{1}{1+e^{-y}}
\end{eqnarray}
$$

よって、ロジスティクス関数は以下の通りとなる

$$
\begin{eqnarray}
p(x) = \frac{1}{1+e^{-x}}
\end{eqnarray}
$$

```R
eta <- seq(from=-5, to=5, length=200)
plot(eta, exp(eta)/(1+exp(eta)))
```



### ロジスティク回帰分析で非線形データを分析

* 実験データを読み込んでロジスティク回帰分析にかける

```R
actual.len  <- ToothGrowth[,1]                   # 歯の長さの実測値を取得
actual.supp <- ToothGrowth[,2]                   # 投与方法の実測値を取得
actual.dose <- ToothGrowth[,3]                   # 投与量の実測値を取得

# ロジスティック回帰分析
tooth.glm <- glm(actual.supp ~                   # 投与方法を目的変数にする
                   actual.len + actual.dose,     # 歯の長さと投与量を説明変数にする
                 family=binomial                 # 二項分布のリンク関数を指定
                 )
```

* 予測値を四捨五入で0と1にしてから取得する

```R
predict.supp <- round(                           # 四捨五入
                      fitted(tooth.glm)          # 予測値を取得
                      )
```

* 実測値と予測値の一覧とクロス集計表を作る

```R
result  <- data.frame(actual.supp, predict.supp) # データフレームを作成
c_table <- table(actual.supp, predict.supp)      # クロス集計表を作成
```

```R
> c_table
           predict.supp
actual.supp  0  1
         OJ 17 13
         VC  7 23
```



| version | update     |
|:--------|:-----------|
| 1st     | 2020/04/17 |
