06 独立性の検定と2つの平均の比較 カイ二乗検定 t検定
============================================

## 1. 2つのデータの独立性の検定($\chi^2$検定)

* $chi^2$検定:「誤差の範囲内のもの」なのか、「誤差とは言えない誤差以上のもの」なのかを決める検定

  * 信頼度95%で同じか、それとも違うのかを言い当てる

  * 観測されたデータから理論的に分布を予測し、2つのデータが「独立」であるかどうかを見極める



### データの分布を検証する$\chi^2$検定

* 期待値(期待度数):「確率が1/6だから、12回投げたらそれぞれの目が2回ずつ出るだろう」という考えを基にして求めた値

* 観測度数:サイコロを12回投げたときの1から6までのそれぞれの目が出た回数のこと

* 一様分布:どの値も同じ度数となる分布

> 観測度数と期待度数のズレを数値にして、一様分布に従っているかどうかを $\chi^2$ 検定によって判断する



#### 検定に使用する検定統計量を求める式

* 検定統計量:仮説検定によってサンプルデータから標準化された値を導く式

  * ここで求める実現値は、自由度1の $\chi^2$ 分布に従う

    > $O$:観測度数、$E$:期待値

$$
\begin{eqnarray}
\chi^2 = \frac{(O_1 - E_1)^2}{E_1} + \frac{(O_2 - E_2)^2}{E_2} + \cdots + \frac{(O_k - E_k)^2}{E_k}
\end{eqnarray}
$$

**$\chi^2$ 検定における検定統計量の特徴**

* 期待度数と観測度数が完全に一致すれば、$\chi^2$ 値は $0$ になる

* 期待度数と観測度数の差が大きくなると、$\chi^2$ 値も大きくなる



#### 検定に使用する $\chi^2$ 値を求める

* $\chi^2$ 分布:$\chi^2$ 値と確率の関係を示すもの

  * この分布のある地点の $\chi^2$ 値を比較の基準にする

  * 実現値は正の値しか取らないので、$\chi^2$ 検定は片側検定になる

```r
data <- read.table(     # サイコロ.txtをdataに代入
  "サイコロ.txt",
  header=T,             # 1行目は列名であることを指定
  fileEncoding="CP932"  # 文字コードをShift_JISに指定
)

freq <- c(
  data[1,2],            # 1の目の観測度数
  data[2,2],            # 2の目の観測度数
  data[3,2],            # 3の目の観測度数
  data[4,2],            # 4の目の観測度数
  data[5,2],            # 5の目の観測度数
  data[6,2]             # 6の目の観測度数
)

# それぞれの観測度数について検定統計量を求める
element <- (freq - 2)^2 / 2
# 検定統計量χ2の実現値を求める
elm_val <- sum(element)
# 有意水準5％のχ2値（棄却域）を求める
chi_val <- qchisq(
                  0.05,            # 有意水準5%
                  5,               # 自由度
                  lower.tail=FALSE # 上側確率を求める
                  )
```

* 有意水準:めったに起こらないか、そうでないかを決めるための基準となる確率

  * 今回は、「$\chi^2$ 分布」に基づいた有意水準5%の $\chi^2$ 値(棄却域)を求めている

  * $\chi^2$ 分布の棄却域の確率を0.05とし、これに対応する $\chi^2$ 値を求める



#### 自由度とは

* 自由度:自由に選べる値のこと

  * 有意水準5%の $\chi^2$ 値を求める際の確率変数の数

    > 「1+2+3=6」という数式の場合、1つ目を1、2つ目を2と決めると3つ目の値は確定する。この場合には自由度は2

```r
> elm_val
[1] 5
> chi_val
[1] 11.0705
```

* 検定統計量の実現値:5

* 有意水準5%の $\chi^2$ 値:11.07...

    > サイコロ12回の目の出方は偶然起こり得る範囲内であり、サイコロには歪みはない



#### $\chi^2$ 検定を行う手順

1. 対立仮説と帰無仮説を立てる

    * 対立仮説:ある出来事について、その起こり方について「差がある」という仮説

    * 帰無仮説:ある出来事について、その起こり方について「差がない」という仮説

2. 検定統計量の実現値を求める

    * 帰無仮説を採択するかを決める

    * $\chi^2$ 検定を行うための検定統計量の実現値を求める

    * 検定統計量は自由度1(の $\chi^2$ 分布に従う)

3. 有意水準を決めて $\chi^2$ 値を求める

    * 有意水準:めったに起こらないとする棄却域の割合

    * 有意水準を用いて、帰無仮説を棄却するかどうかを判定する基準にする

4. 検定統計量の実現値と $\chi^2$ 値を比較する

    * `2`で求めた検定統計量の実現値と、`3`で求めた $\chi^2$ 値を比較する

    * 実現値が $\chi^2$ 値を超えない場合:有意水準で指定した棄却域には入らないため、当然起こりうる(帰無仮説を採択)

    * 実現値が $\chi^2$ 値を超える場合:棄却域に入るので、「差がない」とは言えない(対立仮説を採択する)



### 例:A店とB店のデータ分布は同じかどうかを判断する

**A店とB店のデータ分布は同じかどうか**



#### 「差はない」という帰無仮説を立てて $\chi^2$ 検定を実施

A店

```txt
(セカンドメニュー)/(メインメニュー)
171/449 = 0.38...
```

B店

```txt
(セカンドメニュー)/(メインメニュー)
129/251 = 0.51...
```



#### 帰無仮説と対立仮説を立てて $\chi^2$ 検定を実施

* 帰無仮説:A店とB店では、メインメニューとセカンドメニューの注文数の割合に差はない

* 対立仮説:A店とB店の間では、メインメニューとセカンドメニューの注文数の割合に差がある

```r
data <- read.table(                      # 容量検査.txtをdataに代入
  "A店B店.txt",
  header=T,                              # 1行目は列名であることを指定
  fileEncoding="CP932"                   # 文字コードをShift_JISに指定
)

A_sum     <- data[1,3]                   # A店の注文数の合計
B_sum     <- data[2,3]                   # B店の注文数の合計
AB_sum    <- data[3,3]                   # A店舗B店の注文数の合計

menu1_sum <- data[3,1]                   # メニュー1の注文数の合計
menu2_sum <- data[3,2]                   # メニュー2の注文数の合計
menu_sales <- c(                         # 店舗ごとの注文数をベクトルに代入
                data[1,1],               # A店のメニュー1の注文数
                data[1,2],               # A店のメニュー2の注文数
                data[2,1],               # B店のメニュー1の注文数
                data[2,2]                # B店のメニュー2の注文数
                )


exp_A_m1  <- menu1_sum * A_sum / AB_sum  # A店メニュー1の期待値
exp_A_m2  <- menu2_sum * A_sum / AB_sum  # A店メニュー2の期待値
exp_B_m1  <- menu1_sum * B_sum / AB_sum  # B店メニュー1の期待値
exp_B_m2  <- menu2_sum * B_sum / AB_sum  # B店メニュー2の期待値

# すべての期待値をベクトルに代入
exp_freq  <- c(exp_A_m1, exp_A_m2, exp_B_m1, exp_B_m2)

# それぞれの売上について検定統計量を求める
chi_element <- (menu_sales - exp_freq) ^2/exp_freq
# 検定統計量χ2の実現値を求める
chi_elm_val <- sum(chi_element)
# 有意水準5％のχ2値（棄却域）を求める
chi_val <- qchisq(0.05, 1,lower.tail=FALSE)

# 自由度1のχ2分布のグラフを描く
curve(dchisq(x, 1), 0, 6)
abline(v=qchisq(0.05, 1,lower.tail=FALSE))
```

> $\chi^2$ 検定の対象が2店舗の2品目のデータなので、2次元の表になっている
>
> ```txt
> 自由度 = (行の数 - 1) ✕ (列の数 - 1)
> ```
>
> この場合には、自由度を「1」とする



#### A店とB店の売上に差はあるのか

```r
# 検定統計量χ2の実現値を求める
> chi_elm_val
[1] 4.547659
# 有意水準5％のχ2値（棄却域）を求める
> chi_val
[1] 3.841459
```

結果をまとめたものは、以下の通りにまとめられる

| 種類                          | 値   |
| ----------------------------- | ---- |
| 統計推定量の実現値            | 4.55 |
| 自由度1、有意5%の $\chi^2$ 値 | 3.84 |

* `dchisq()`関数:$\chi^2$ 分布の確率密度関数による確率密度を求める

```r
dchisq(自由度)
```



#### 2店舗の注文数に差はあるのか

1. 帰無仮説として「A店とB店の間では、メインとサブメニューの注文数の割合に差はない」という仮説を立てる

1. それぞれの店舗の注文数から検定統計量の実現値を求めたところ「4.55」となった

1. 自由度1、有意水準5%の $\chi^2$ 値を求めたところ「3.84」となった

1. 検定統計量の実現値は有意水準5%の $\chi^2$ 値より大きいので帰無仮説を棄却する

1. 対立仮説の「A店とB店では、メインとサブメニューの注文数の割合に差がある」を採択する



## 2. 独立した2群の差のt検定①(分散が等しいと仮定できる場合のt検定)

### 1. 2つの母集団における3つのt検定

「母平均の差」があるかないか

* 帰無仮説:平均点の差には意味がない:5点の差は、たまたま出たものであって、この程度の点差は意味の無いものであると考える

$$
\begin{eqnarray}
\mu_1 = \mu_2
\end{eqnarray}
$$

* 対立仮説:ライバル店の平均点が高いながら、当然、このメニューをおいしいと考える

$$
\begin{eqnarray}
\mu_1 \neq \mu_2
\end{eqnarray}
$$



#### 独立した2群の母平均の検定(t検定)

2つの母集団の平均の検定には、次の3つが使われる

* 独立な2群のt検定

  * スチューデントのt検定:対応のない2群のt検定

    * 2つの母集団が独立したものであり、母分散が等しいと仮定できる場合

  * ウェルチのt検定:対応のない2群のt検定

    * 2つの母集団が独立したものであり、母分散が異なる場合

* 対応のある2群のt検定

  * 調査の対象となる被験者が同じで、異なる複数の測定が行われるような「対応あり」の2群の場合

> 今回は、「スチューデントのt検定」を行う



### 2. スチューデントのt検定で母平均を検定する

#### 検定に使用する検定統計量tの実現値の求め方

検定の対象にするデータは、次の3つの要件を満たしているものとする

* 標本抽出が無作為に行われていること

* 母集団の分布が正規分布に従っていること

* 2つの母集団の分散が等しいと仮定できること

母分散は等しいと仮定できる場合の標本平均の差の分布

$$
\begin{eqnarray}
\bar{x}_1 - \bar{x}_2 \sim \mathcal{N}\Bigr( \mu_1 - \mu_2, \sigma^2\bigr( \frac{1}{n_1} + \frac{1}{n_2} \bigl)\Bigl)
\end{eqnarray}
$$

これを標準化すると、以下の式で表される

$$
\begin{eqnarray}
\frac{\bar{x}_1 - \bar{x}_2 - (\mu_1 - \mu_2)}{\sigma\sqrt{\frac{1}{n_1} + \frac{1}{n_2}}} \sim \mathcal{N}(0, 1^2)
\end{eqnarray}
$$

> 標準化を行うことで、標準正規分布 $\mathcal{N}(0, 1^2)$ に従う

未知の値である母標準偏差 $\sigma$ は、以下の方法で推定できる

* $\hat{\sigma}_1^2$, $\hat{\sigma}_2^2$:それぞれの群の不偏分散

* $n_1$, $n_2$:それぞれの群のサンプルサイズ

$$
\begin{eqnarray}
\hat{\sigma}_{pooled} = \sqrt{\frac{(n_1 - 1)\hat{\sigma}_1^2 + (n_2 - 1)\hat{\sigma}_2^2}{n_1 + n_2 - 2}}
\end{eqnarray}
$$

* $\hat{\sigma}^2_{pooled}$:2群を「プールした分散」

  * 2群に共通の母分散 $\sigma$ の不偏推定量

* 検定統計量:標本平均の差の分布を標準化した式の分母にある未知の $\sigma$ を、$\hat{\sigma}^2_{pooled}$ によって推定したもの

$$
t = \frac{\bar{X}_1 - \bar{X}_2}{\sqrt{\frac{(n_1 - 1)\hat{\sigma}_1^2 + (n_2 - 1)\hat{\sigma}_2^2}{n_1 + n_2 - 2}}\Bigr( \frac{1}{n_1} + \frac{1}{n_2} \Bigl)}
$$

> 標本分布は、自由度 $n_1+n_2-2$ のt分布に従う
>
> この検定量を用いることで、2つの平均値の差に関する検定を行うことができる



### 3. 検定統計量の実現値と有意水準5%のt値を求める

```r
data <- read.delim(                      # 採点.txtをdataに代入
  "採点.txt",
  header=T,                              # 1行目は列名であることを指定
  fileEncoding="CP932"                   # 文字コードをShift_JISに指定
)

# 主力メニューの点数をベクトルに代入
menu1 <- data$当店
# 欠損値を除いてライバル店の点数をベクトルに代入
menu2 <- data$ライバル店[!is.na(data$ライバル店)]

mean_m1 <- mean(menu1)                   # 主力メニューの平均
mean_m2 <- mean(menu2)                   # ライバル店の平均

# ブールされた分散の平方根を求めることで「ブール標準偏差」を求める
pool <- sqrt(                            # 平方根を求めることで
  (
    (length(menu1) - 1) * var(menu1) +   # 主力メニューの標本分散×サイズ－1
      (length(menu2) - 1) * var(menu2)   # ライバル店の標本分散×サイズ－1
  )
  /(length(menu1) + length(menu2) - 2)   # サンプルサイズの合計－2
)
# 検定統計量tの分母の計算
dn <- pool * sqrt(1 / length(menu1) +
                    1 / length(menu2)
)
# 検定統計量tの実現値を求める
st <- (mean_m1 - mean_m2) / dn

# 自由度を求める
dof <- length(menu1) + length(menu2) - 2

# 自由度がサンプルサイズの合計－2のt分布における下側確率0.025のt値を求める
t_low <- qt(0.025, dof)

# 自由度がサンプルサイズの合計－2のt分布における上側確率0.025のt値を求める
t_upp <- qt(0.025, dof, lower.tail=FALSE)

curve(dt(x, dof), -3, 3)  # 自由度16のt分布のグラフを描く
abline(v=qt(0.025, dof))  # 下側確率0.025のt値のところにラインを引く
abline(v=qt(0.975, dof))  # 上側確率0.975のt値のところにラインを引く

p <- 2*pt(st, dof)        # 両側検定におけるp値を求める

t.test(
  menu1,                  # 独立した2群のデータ1
  menu2,                  # 独立した2群のデータ2
  var.equal = TRUE        # スチューデントのt検定を実施
  )
```

```r
> mean_m1
[1] 77.5
> mean_m2
[1] 82.5
> st
[1] -1.579597
> t_low
[1] -2.119905
> t_upp
[1] 2.119905
```

検定統計量tの実現値、自由度16、有意水準5%のt値は、それぞれ以下の値になった

| 種類                | 値           |
| ------------------- | ------------ |
| 検定統計量tの実現値 | -1.579597... |
| 上側2.5%のt値       | 2.119905...  |
| 下側2.5%のt値       | -2.119905    |
| 主力メニューの平均  | 77.5         |
| ライバル店の平均    | 82.5         |

> 「2つの商品の平均点には差がない」という帰無仮説を採択する



#### p値を求めてt検定を行う

* p値:帰無仮説が正しいという仮定の基で、「標本から計算した検定統計量の実現値以上の値が得られる確率」

  * p値が有意水準 $\alpha$ より小さい時に帰無仮説を棄却する

* `pt()`関数:自由度`df`の`t`分布において、検定量の期待値`q`に対する下側確率、上側確率を求める

```r
pt(q, df, lower.tail = FALSE)
```

| 引数               | 説明                                        |
| ------------------ | ------------------------------------------- |
| `q`                | 検定統計量の期待値                          |
| `df`               | 自由度                                      |
| `lower.tail=FALSE` | 期待値`q`に対する上側確率を求める場合に指定 |

> 今回のt検定:両側検定なので、下側確率を2倍する

```r
p <- 2*pt(st, dof)        # 両側検定におけるp値を求める
```

```r
> p
[1] 0.1337633
```



#### t.test()関数で検定統計量tの実現値を求める

* `t.test()`関数:独立な2群のt検定を行う

  * デフォルト:ウェルチのt検定

```r
t.test(データ1, データ2, var.equal=T)
```

| 引数          | 説明                                        |
| ------------- | ------------------------------------------- |
| データ1       | 独立した2群のうちの1つのデータ              |
| データ2       | 独立した2群のもう1つのデータ                |
| `var.equal=T` | スチューデントのt検定を行うためのオプション |

```r
t.test(
  menu1,                  # 独立した2群のデータ1
  menu2,                  # 独立した2群のデータ2
  var.equal = TRUE        # スチューデントのt検定を実施
  )
```

```r
Two Sample t-test

data:  menu1 and menu2
t = -1.5796, df = 16, p-value = 0.1338
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
-11.710273   1.710273
sample estimates:
mean of x mean of y
77.5      82.5
```
